---
list_title: Note | MIT 6.172 - Storage Allocation
title: Storage Allocation
layout: post
mathjax: true
---

## Stack Storage

Array and pointer

```
A ----used----- ------unused----
               |
               sp

# Allocate x bytes 
sp += x
return sp-x

```

- Allocating and freeing take `O(1)` time.
- Must free consistent with stack discipline
- Limited applicability, but great when it works
- One can allocate on the call stack using `alloca()`, but this function is deprecated, and the compiler is more efficient with fixed-size frames.

Limitation: there is no way to free memory in the middle of the used-region on the stack. ONly the last object can be freed.

## Heap

C provides `malloc()` and `free()`. C++ provides `new` and `delete`.

Unlike Java and Python, C and C++ provide no garbage collectors. Heap storage allocated by the programmer must be freed explicitly. Failure to do so can creates a memory leak. Also, watch for dangling pointers and double freeing

Memory checkers (e.g. `AddressSanitizer`, `Valgrind`) can assist in finding these pernicious bugs.

### Fixed-size Allocation

<img class="md-img-center" src="{{site.baseurl}}/assets/images/2021/08/perf-sa-01.png">

- Every piece of storage has the same size
- Unused storage has a pointer to next unused block

Allocate 1 object

```
x = free;
free = free->next;
return x;
```

### Fixed-size Deallocation

<img class="md-img-center" src="{{site.baseurl}}/assets/images/2021/08/perf-sa-02.png">

free object `x`

```cpp
x->next = free;
free = x
```
- Allocating and freeing take `O(1)` time
- Good temporal locality
- Poor spatial locality due to external fragmentation - blocks distributed across virtual memory - which can increase the size of the page table and cause disk thrashing (page fault)
- THe translation lookaside buffer(TLB) can also be a problem (map virtual address to physical address)


### Mitigating External Fragmentation

- Keep a free list per disk page.
- Allocate from the free list for the fullest page.
- Free a block of storage to the free list for the page on which the block resides.

<img class="md-img-center" src="{{site.baseurl}}/assets/images/2021/08/perf-sa-03.png">
