I" (<p><em></em></p>

<p>å¦‚æœä¸€ä¸ªå¯¹è±¡è¢«key-value-observed ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">@interface</span> <span class="nc">KVOTestClass</span> <span class="p">:</span> <span class="nc">NSObject</span>

<span class="k">@property</span><span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span><span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span><span class="o">*</span> <span class="n">observedObj</span><span class="p">;</span>
<span class="k">@property</span><span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span><span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span><span class="o">*</span> <span class="n">unobservedObj</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">KVOTestClass</span>

<span class="k">@end</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">@autoreleasepool</span> <span class="p">{</span>
    
   <span class="c1">//normal class</span>
    <span class="n">KVOTestClass</span><span class="o">*</span> <span class="n">normalClass</span> <span class="o">=</span> <span class="p">[</span><span class="n">KVOTestClass</span> <span class="nf">new</span><span class="p">];</span>

    <span class="c1">//KVOed class</span>
    <span class="n">KVOTestClass</span><span class="o">*</span> <span class="n">kvoClass</span> <span class="o">=</span> <span class="p">[</span><span class="n">KVOTestClass</span> <span class="nf">new</span><span class="p">];</span>

    <span class="p">[</span><span class="n">kvoClass</span> <span class="nf">addObserver</span><span class="p">:</span><span class="n">normalClass</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="s">@"observerObj"</span> <span class="n">options</span><span class="o">:</span><span class="n">NSKeyValueObservingOptionNew</span>   <span class="n">context</span><span class="o">:</span><span class="nb">NULL</span><span class="p">];</span>

    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">metaClassName</span> <span class="o">=</span> <span class="n">object_getClassName</span><span class="p">(</span><span class="n">kvoClass</span><span class="p">);</span>
    <span class="n">NSString</span><span class="o">*</span> <span class="n">className</span> <span class="o">=</span> <span class="n">NSStringFromClass</span><span class="p">(</span><span class="n">kvoClass</span><span class="p">.</span><span class="n">class</span><span class="p">);</span>

    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"</span><span class="se">\n</span><span class="s"> kvo object's metaclass : %s </span><span class="se">\n</span><span class="s"> kvo object's class : %@"</span><span class="p">,</span><span class="n">metaClassName</span><span class="p">,</span><span class="n">className</span><span class="p">);</span>
        
        <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¾“å‡ºä¸ºï¼š</p>

<p><span style="color: #ff6600;">kvo objectâ€™s metaclass : NSKVONotifying_KVOTestClass</span></p>

<p><span style="color: #ff6600;"> kvo objectâ€™s class : KVOTestClass</span></p>

<p>æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p>

<p>ï¼ˆ1ï¼‰ä¸ºä»€ä¹ˆè¿™ä¸¤ä¸ªapiç»“æœä¸ä¸€æ ·ï¼Ÿ</p>

<p>ï¼ˆ2ï¼‰NSKVONotifying_KVOTestClassæ€ä¹ˆå‡ºæ¥çš„ï¼Ÿ</p>

<p>ç¬¬ä¸€ä¸ªé—®é¢˜ä¸å±äºkvoçš„è®¨è®ºèŒƒç•´ï¼Œç¬¬äºŒä¸ªé—®é¢˜æ˜¯appleçš„ä¸€ä¸ªtrickï¼š</p>
<blockquote>

  <p>â€œSo how does that work, not needing any code in the observed object? Well it all happens through the power of the Objective-C runtime. When you observe an object of a particular class for the first time, the KVO infrastructure creates a brand new class at runtime that subclasses your class. In that new class, it overrides the set methods for any observed keys. It then switches out the isa pointer of your object (the pointer that tells the Objective-C runtime what kind of object a particular blob of memory actually is) so that your object magically becomes an instance of this new class.â€</p>
</blockquote>

<p>å½“kvoClassè¢«æŸä¸ªè§‚å¯Ÿè€…(normalClass)è§‚å¯Ÿæ—¶ï¼Œruntimeä¼šä¸ºkvoClassåŠ¨æ€ç”Ÿæˆä¸€ä¸ªsubclassï¼ˆNSKVONotifying_KVOTestClassï¼‰æ¥ä»£æ›¿kvoClassï¼Œæ–¹æ³•æ˜¯æ”¹å˜kvoClassçš„isaã€‚å¹¶ä¸”é‡è½½äº†è¢«è§‚å¯Ÿpropertyï¼ˆobservedObjï¼‰çš„setteræ–¹æ³•ï¼Œé‚£ä¹ˆå½“observedObjçš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±å¯ä»¥é€šçŸ¥è§‚å¯Ÿè€…ã€‚</p>

<p>ä½†ä¸ºä»€ä¹ˆNSStringFromClassæˆ–class_getNameè¿”å›çš„æ˜¯KVOTestClasså‘¢ï¼Ÿ</p>

<p>Thatâ€™s another trickï¼š</p>

<blockquote>

  <p>Apple really doesnâ€™t want this machinery to be exposed. In addition to setters, the dynamic subclass also overrides the -class method to lie to you and return the original class! If you donâ€™t look too closely, the KVO-mutated objects look just like their non-observed counterparts.</p>
</blockquote>

<p>åŸå› æ˜¯è¿™ä¸ªåŠ¨æ€ç”Ÿæˆçš„subClassï¼ˆNSKVONotifying_KVOTestClassï¼‰åŒæ ·overrideäº†classæ–¹æ³•ï¼Œæ¥è¿”å›å®ƒåŸæ¥ç±»å‹ã€‚</p>

<p>å› æ­¤ä½¿ç”¨è€…æ ¹æœ¬æ„Ÿè§‰ä¸å‡ºkvoClassè¿™ä¸ªinstanceçš„ç±»å‹å·²ç»å‘ç”Ÿå˜åŒ–äº†ã€‚</p>

<p>ä¸‹é¢è¿™æ®µä»£ç å¯ä»¥çœ‹çš„æ›´æ¸…æ¥šï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">NSArray</span> <span class="o">*</span><span class="nf">ClassMethodNames</span><span class="p">(</span><span class="n">Class</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="nf">array</span><span class="p">];</span>
    
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">methodCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">Method</span> <span class="o">*</span><span class="n">methodList</span> <span class="o">=</span> <span class="n">class_copyMethodList</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">methodCount</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">methodCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">[</span><span class="n">array</span> <span class="nf">addObject</span><span class="p">:</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">method_getName</span><span class="p">(</span><span class="n">methodList</span><span class="p">[</span><span class="nf">i</span><span class="p">]))];</span>
    <span class="n">free</span><span class="p">(</span><span class="n">methodList</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="n">array</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç„¶åä¿®æ”¹ä¸‹mainå‡½æ•°ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NSArray</span><span class="o">*</span> <span class="n">normalClassMethods</span> <span class="o">=</span> <span class="n">ClassMethodNames</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">normalClass</span><span class="p">));</span>
<span class="n">NSArray</span><span class="o">*</span> <span class="n">kvoClassMethods</span>    <span class="o">=</span> <span class="n">ClassMethodNames</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">kvoClass</span><span class="p">));</span>
        
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"</span><span class="se">\n</span><span class="s"> normal class : </span><span class="se">\n</span><span class="s"> %@ kvo class: %@ </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">normalClassMethods</span><span class="p">,</span><span class="n">kvoClassMethods</span><span class="p">);</span>
</code></pre></div></div>

<p>è¾“å‡ºä¸ºï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">normal</span> <span class="n">class</span><span class="o">:</span> 
 <span class="p">(</span>
    <span class="n">observedObj</span><span class="p">,</span>
    <span class="s">"setObservedObj:"</span><span class="p">,</span>
    <span class="n">unobservedObj</span><span class="p">,</span>
    <span class="s">"setUnobservedObj:"</span><span class="p">,</span>
    <span class="s">".cxx_destruct"</span>
<span class="p">)</span> 
 <span class="n">kvo</span> <span class="n">class</span><span class="o">:</span> 
 <span class="p">(</span>
    <span class="s">"setObservedObj:"</span><span class="p">,</span>
    <span class="n">class</span><span class="p">,</span>
    <span class="n">dealloc</span><span class="p">,</span>
    <span class="s">"_isKVOA"</span>
<span class="p">)</span>
</code></pre></div></div>

<p>è¿™å°±ä¸€ç›®äº†ç„¶äº†ï¼ŒnormalClassåªæœ‰getterï¼Œsetteræ–¹æ³•</p>

<p>kvoClassæ˜¯å…¶å­ç±»ï¼Œç”±äºobservedObjè¢«è§‚å¯Ÿï¼Œå› æ­¤overrideäº†observedObjçš„setteræ–¹æ³•ï¼ŒåŒæ ·ï¼Œclassæ–¹æ³•ä¹Ÿè¢«overrideç”¨æ¥è¿”å›â€œKVOTestClassâ€ï¼Œdeallocæ–¹æ³•è¢«overrideåŸå› æ˜¯ä¸ºäº†é‡Šæ”¾è§‚å¯Ÿè€…ï¼Œè€Œ_isKVOAï¼Œä»å‘½åä¸Šçœ‹ï¼Œå±äºappleçš„ä¼¼æœ‰apiï¼Œå¤§æ¦‚æ˜¯ç”¨æ¥æ ‡è¯†è¿™ä¸ªå¯¹è±¡æ˜¯åŠ¨æ€ç”Ÿæˆçš„kvoå¯¹è±¡ã€‚</p>

<p>Thatâ€™s all</p>

:ET