I"‘<blockquote>
  <p>æŒç»­æ›´æ–°ï¼Œè¡¥å……C++æ–°å¢feature,ç›®å½•ç»“æ„éµå¾ªã€ŠC++ Primerã€‹</p>
</blockquote>

<h2 id="åŠ¨æ€å†…å­˜">åŠ¨æ€å†…å­˜</h2>

<ul>
  <li>é™æ€å†…å­˜ï¼šä¿å­˜å±€éƒ¨staticå¯¹è±¡ï¼Œç±»staticæ•°æ®æˆå‘˜ï¼Œä»¥åŠå®šä¹‰åœ¨ä»»ä½•å‡½æ•°ä¹‹å¤–çš„å˜é‡</li>
  <li>æ ˆå†…å­˜ï¼šä¿å­˜å®šåœ¨å‡½æ•°å†…éstaticå¯¹è±¡ï¼Œ</li>
  <li>å †å†…å­˜ï¼šåŠ¨æ€åˆ†é…ä¸å›æ”¶</li>
</ul>

<p>å¯¹äºé™æ€å†…å­˜å’Œæ ˆå†…å­˜ä¸­çš„å¯¹è±¡ï¼Œç¼–è¯‘å™¨è´Ÿè´£é”€æ¯ï¼Œå¯¹æ ˆå¯¹è±¡ï¼Œæ ˆè¢«å›æ”¶åå³è¢«é”€æ¯ï¼Œstaticå¯¹è±¡åœ¨ä½¿ç”¨ä¹‹å‰åˆ†é…ï¼Œåœ¨ç¨‹åºç»“æŸæ—¶é”€æ¯ã€‚å¯¹äºå †ä¸Šçš„å¯¹è±¡ï¼Œç”±ç¨‹åºæ¥æ§åˆ¶ï¼Œå½“å¯¹è±¡ä¸å†ä½¿ç”¨æ—¶ï¼Œéœ€è¦ä»£ç æ˜¾å¼å°†å…¶åˆ é™¤ã€‚</p>

<p>å¯¹äºåŠ¨æ€å†…å­˜çš„ç®¡ç†ï¼Œ<mark>C++ 11</mark>ä¸­å¼•å…¥äº†ä¸‰ç±»æ™ºèƒ½æŒ‡é’ˆï¼Œå®šä¹‰åœ¨<code class="highlighter-rouge">&lt;memory&gt;</code>å¤´æ–‡ä»¶</p>

<ul>
  <li><strong>shared_ptr</strong>: å…è®¸å¤šä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€å¯¹è±¡</li>
  <li><strong>unique_ptr</strong>: â€œç‹¬å â€æ‰€æŒ‡å‘çš„å¯¹è±¡</li>
  <li><strong>weak_ptr</strong>: å¼±å¼•ç”¨ï¼ŒæŒ‡å‘<code class="highlighter-rouge">shared_ptr</code>æ‰€ç®¡ç†çš„å¯¹è±¡</li>
</ul>

<p>å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨<code class="highlighter-rouge">new</code>å’Œ<code class="highlighter-rouge">delete</code>æ¥ç›´æ¥æ§åˆ¶å†…å­˜</p>

<h3 id="new--delete">new &amp; delete</h3>

<p><code class="highlighter-rouge">new</code>åœ¨å¯¹è±¡ä¸Šå¼€è¾Ÿä¸€ä¸ªå…·æœ‰æŸç±»å‹å¤§å°çš„ç©ºé—´ï¼Œå¹¶ä¸”å¯ä»¥å¯¹è¯¥å—å†…å­˜è¿›è¡Œåˆå§‹åŒ–ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åˆ†é…çš„å¯¹è±¡æ—¶é»˜è®¤åˆå§‹åŒ–çš„ï¼Œå³è°ƒç”¨ç±»çš„é»˜è®¤æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–ã€‚</p>

<p>å¦‚æœåœ¨æ‰§è¡Œ<code class="highlighter-rouge">new</code>çš„æ—¶å€™ï¼Œå†…å­˜è€—å°½ï¼Œåˆ™ç³»ç»Ÿä¼šæŠ›å‡º<code class="highlighter-rouge">std::bad_alloc</code>çš„å¼‚å¸¸ï¼Œä¹Ÿå¯ä»¥å‘<code class="highlighter-rouge">new</code>ä¼ å‚æ§åˆ¶å…¶è¡Œä¸º</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//piæŒ‡å‘ä¸€ä¸ªåŠ¨æ€åˆ†é…çš„ï¼Œæœªåˆå§‹åŒ–çš„æ— åå¯¹è±¡</span>
<span class="kt">int</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">;</span> 
<span class="c1">//å®šä¹‰å¹¶åˆå§‹åŒ–</span>
<span class="kt">int</span> <span class="o">*</span><span class="nf">p2</span><span class="p">(</span><span class="k">new</span> <span class="kt">int</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
<span class="n">string</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">string</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="sc">'9'</span><span class="p">);</span> 
<span class="c1">//å¦‚æœå†…å­˜ä¸è¶³ï¼Œä¸æŠ›å¼‚å¸¸ï¼Œè¿”å›ä¸€ä¸ªç©ºæŒ‡é’ˆ</span>
<span class="kt">int</span> <span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">nothrow</span><span class="p">)</span> <span class="kt">int</span><span class="p">;</span> 
</code></pre></div></div>

<p>å¯¹äº<code class="highlighter-rouge">delete</code>ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ä¹Ÿä¼šæœ‰å¾ˆå¤šé—®é¢˜ï¼Œæ¯”å¦‚ä¸‹é¢çš„æƒ…å†µ:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="o">*</span><span class="nf">p</span><span class="p">(</span><span class="k">new</span> <span class="kt">int</span><span class="p">(</span><span class="mi">42</span><span class="p">));</span>
<span class="k">auto</span> <span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
<span class="k">delete</span> <span class="n">p</span><span class="p">;</span>
<span class="n">p</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
</code></pre></div></div>
<p>å½“<code class="highlighter-rouge">p</code>è¢«deleteåï¼Œå…¶å†…å­˜è¢«é‡Šæ”¾æ‰ï¼Œå¯¹äº<code class="highlighter-rouge">q</code>æ¥è¯´ï¼Œå´ä¸çŸ¥é“ï¼Œä»ä¼šç»§ç»­è®¿é—®ï¼Œä»è€Œå‡ºç°å¼‚å¸¸ã€‚ç±»ä¼¼çš„é—®é¢˜è¿˜æœ‰æŒ‡é’ˆçš„double freeï¼Œä»¥åŠå°†æŒ‡é’ˆä½œä¸ºå‡½æ•°çš„è¿”å›å€¼è¿”å›åï¼Œä½¿ç”¨è€…å¿˜è®°deleteè¯¥æŒ‡é’ˆï¼ˆæˆ–è®¸æ ¹æœ¬ä¸æ¸…æ¥šè¿™ä¸ªæŒ‡é’ˆæ€ä¹ˆæ¥çš„ï¼‰ï¼Œè€Œé€ æˆå†…å­˜æ³„æ¼</p>

<h3 id="unique_ptr">unique_ptr</h3>

<p>å½“éœ€è¦ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆæ—¶ï¼Œå¯ä»¥é¦–å…ˆè€ƒè™‘ä½¿ç”¨<code class="highlighter-rouge">unique_ptr</code>ï¼Œä½¿ç”¨å®ƒå‡ ä¹å’Œä½¿ç”¨åŸå§‹æŒ‡é’ˆä¸€æ ·ï¼Œå¹¶ä¸”æ€§èƒ½ä¸Šå‡ ä¹æ²¡æœ‰æŸè€—ã€‚ä¸åŒçš„æ˜¯ä¸€ä¸ª<code class="highlighter-rouge">unique_ptr</code>ç‹¬å ä¸€ä¸ªèµ„æºçš„æ§åˆ¶æƒ(<code class="highlighter-rouge">exclusive ownership</code>)ï¼ŒæŒ‡é’ˆï¼Œä½ ä¸èƒ½ç”¨ä¸¤ä¸ª<code class="highlighter-rouge">unique_ptr</code>æ¥æ§åˆ¶åŒä¸€ä»½èµ„æºï¼Œå³æŸä¸ªæ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ª<code class="highlighter-rouge">unique_ptr</code>æŒ‡å‘ä¸€ä¸ªç»™å®šçš„å¯¹è±¡ã€‚ä½¿ç”¨<code class="highlighter-rouge">unique_ptr</code>å¦ä¸€ä¸ªæ–¹ä¾¿ä¹‹å¤„æ˜¯ï¼Œä½ ä¸éœ€è¦æ‹…å¿ƒèµ„æºçš„é‡Šæ”¾ï¼Œå½“<code class="highlighter-rouge">unique_ptr</code>å¯¹è±¡é”€æ¯æ—¶ï¼Œè¢«ç®¡ç†çš„èµ„æºä¹Ÿå°†è‡ªåŠ¨è¢«é”€æ¯ã€‚</p>

<ul>
  <li>åˆ›å»º</li>
</ul>

<p>åˆ›å»º<code class="highlighter-rouge">unique_ptr</code>å¿…é¡»é‡‡ç”¨ç›´æ¥åˆå§‹åŒ–çš„å½¢å¼ï¼Œ<mark>å¹¶ä¸”ä¸æ”¯æŒæ‹·è´ä¸èµ‹å€¼æ“ä½œ</mark></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//åˆ›å»ºä¸€ä¸ªintæŒ‡é’ˆ</span>
<span class="n">unique_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p1</span><span class="p">(</span><span class="k">new</span> <span class="nf">int</span><span class="p">(</span><span class="mi">42</span><span class="p">));</span>
<span class="c1">//åˆ›å»ºä¸€ä¸ªstring[]æ•°ç»„</span>
<span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="p">[]</span><span class="o">&gt;</span> <span class="n">ps</span><span class="p">(</span><span class="k">new</span> <span class="n">string</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="c1">//ä¸æ”¯æŒæ‹·è´æ„é€ å’Œèµ‹å€¼æ“ä½œ</span>
<span class="n">unique_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p2</span><span class="p">(</span><span class="n">p1</span><span class="p">);</span> <span class="c1">//wrong;</span>
<span class="k">auto</span> <span class="n">p3</span> <span class="o">=</span> <span class="n">p1</span><span class="p">;</span> <span class="c1">//wrong</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">make_unique</code></li>
</ul>

<p><mark>C++ 14</mark>å¼•å…¥äº†<code class="highlighter-rouge">make_unique</code>å‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥åˆ›å»º<code class="highlighter-rouge">unique_ptr</code>ï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿæ¨èä½¿ç”¨è¿™ç§æ–¹å¼ä»¥å–ä»£<code class="highlighter-rouge">new</code>çš„æ–¹å¼ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼ä¹Ÿæœ‰å±€é™æ€§ï¼Œå…¶ä¸­ä¹‹ä¸€æ˜¯å®ƒä¸æ”¯æŒè‡ªå®šä¹‰çš„<code class="highlighter-rouge">delete</code>å‡½æ•°ï¼ˆåé¢ä¼šä»‹ç»ï¼‰</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ä½¿ç”¨new</span>
<span class="k">auto</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">widget</span><span class="o">&gt;</span> <span class="p">(</span><span class="k">new</span> <span class="nf">widget</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
<span class="c1">//ä½¿ç”¨make</span>
<span class="k">auto</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">make_unique</span><span class="o">&lt;</span><span class="n">widget</span><span class="o">&gt;</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>æ§åˆ¶æƒè½¬ç§»</li>
</ul>

<p>ä¸€ä¸ª<code class="highlighter-rouge">unique_ptr</code>å¯ä»¥é€šè¿‡<code class="highlighter-rouge">release()</code>æ–¹æ³•å°†å¯¹æŸä¸ªå†…ç½®æŒ‡é’ˆçš„æ§åˆ¶æƒè½¬ç§»ç»™å¦ä¸€ä¸ª<code class="highlighter-rouge">unique_ptr</code>å¯¹è±¡ï¼Œ</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">p1</span><span class="p">(</span><span class="k">new</span> <span class="nf">string</span><span class="p">(</span><span class="s">"abc"</span><span class="p">));</span> <span class="c1">//äº¤å‡ºæ§åˆ¶æƒåï¼Œp1=nullptr</span>
<span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">p2</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">release</span><span class="p">());</span>
<span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">p3</span><span class="p">(</span><span class="n">p2</span><span class="p">.</span><span class="n">release</span><span class="p">());</span>
<span class="c1">//p1 == nullptr &amp; p2 == nullptr</span>
</code></pre></div></div>
<p>æ³¨æ„ï¼Œ<code class="highlighter-rouge">release</code>æ“ä½œæ˜¯åˆ‡æ–­äº†<code class="highlighter-rouge">unique_ptr</code>å’Œå…¶å†…éƒ¨æŒ‡é’ˆä¹‹é—´çš„è”ç³»ï¼Œ<code class="highlighter-rouge">release</code>è¿”å›çš„æŒ‡é’ˆé€šå¸¸ç”¨æ¥åˆå§‹åŒ–å¦ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆ</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p2</span><span class="p">.</span><span class="n">release</span><span class="p">();</span> <span class="c1">//wrongï¼Œp2ä¸ä¼šé‡Šæ”¾å†…å­˜ï¼Œå´ä¸¢å¤±äº†å†…ç½®æŒ‡é’ˆ</span>
<span class="k">auto</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p2</span><span class="p">.</span><span class="n">release</span><span class="p">();</span> <span class="c1">//æ­£ç¡®ï¼Œä½†æ˜¯è¦æ‰‹åŠ¨delete p</span>
</code></pre></div></div>

<ul>
  <li>ä½œä¸ºè¿”å›å€¼</li>
</ul>

<p>ä¸èƒ½æ‹·è´<code class="highlighter-rouge">unique_ptr</code>çš„è§„åˆ™æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥æ‹·è´æˆ–èµ‹å€¼ä¸€ä¸ªå°†è¦é”€æ¯çš„<code class="highlighter-rouge">unique_ptr</code></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">clone</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">){</span>
  <span class="k">return</span> <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="kt">int</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>
<ul>
  <li>é‡Šæ”¾èµ„æº</li>
</ul>

<p><code class="highlighter-rouge">unique_ptr</code>æ”¯æŒè‡ªå®šä¹‰ææ„å‡½æ•°ï¼Œå…¶ææ„å‡½æ•°å¿…é¡»å°†å…¶ç±»å‹ç”¨äºæ„é€ <code class="highlighter-rouge">unique_ptr</code>ã€‚</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//pæŒ‡å‘ä¸€ä¸ªç±»å‹ä¸ºobjTçš„å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªç±»å‹ä¸ºdelTçš„å‡½æ•°é‡Šæ”¾èµ„æº</span>
<span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">objT</span><span class="p">,</span> <span class="n">delT</span><span class="o">&gt;</span> <span class="n">p</span> <span class="p">(</span><span class="k">new</span> <span class="n">objT</span><span class="p">,</span> <span class="n">fcn</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="n">destination</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">){</span>
  <span class="n">connnection</span> <span class="n">c</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="p">);</span>
  <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">connection</span><span class="p">,</span> <span class="k">decltype</span><span class="p">(</span><span class="n">end_connection</span><span class="p">)</span><span class="o">*</span> <span class="o">&gt;</span><span class="n">p</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span><span class="n">end_connection</span><span class="p">);</span> 
<span class="p">}</span>
</code></pre></div></div>
<p>æ³¨æ„ä¸Šè¿°ä»£ç ä¸­åœ¨<code class="highlighter-rouge">decltype(end_connection)</code>åå¿…é¡»åŠ ä¸€ä¸ª<code class="highlighter-rouge">*</code>è¡¨ç¤ºå‡½æ•°æŒ‡é’ˆã€‚</p>

<h3 id="shared_ptr">shared_ptr</h3>

<p>æœ€å®‰å…¨çš„åˆ†é…å’Œä½¿ç”¨åŠ¨æ€å†…å­˜çš„æ–¹æ³•æ˜¯ä½¿ç”¨<code class="highlighter-rouge">make_shared&lt;T&gt;</code>å‡½æ•°ï¼Œå¤´æ–‡ä»¶å®šä¹‰åœ¨<code class="highlighter-rouge">&lt;memory&gt;</code>ä¸­ï¼Œ<code class="highlighter-rouge">make_shared</code>å‚æ•°å’Œå¾…æ„é€ å¯¹è±¡çš„æ„é€ å‡½æ•°å‚æ•°ç›¸åŒï¼Œ<code class="highlighter-rouge">make_shared</code>ä¼šå°†å…¶å‚æ•°é€ä¼ ç»™ç±»çš„æ„é€ å‡½æ•°ã€‚</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//æŒ‡å‘ä¸€ä¸ªå€¼ä¸º32çš„intå‹æŒ‡é’ˆr</span>
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p3</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
<span class="n">cout</span><span class="o">&lt;&lt;*</span><span class="n">p3</span> <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span> <span class="c1">//42</span>
<span class="c1">//åˆ›å»ºæŒ‡å‘å€¼ä¸ºâ€œcccâ€çš„å­—ç¬¦ä¸²æŒ‡é’ˆ</span>
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">p4</span><span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="sc">'c'</span><span class="p">);</span>
<span class="c1">//ä½¿ç”¨auto</span>
<span class="k">auto</span> <span class="n">p5</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;&gt;</span><span class="p">();</span>
</code></pre></div></div>
<p>é™¤äº†ä½¿ç”¨<code class="highlighter-rouge">make_shared</code>ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code class="highlighter-rouge">new</code>æ¥åˆ›å»ºæŒ‡é’ˆï¼Œå½“æ—¶ç”¨<code class="highlighter-rouge">new</code>æ—¶ï¼Œå¿…é¡»ä½¿ç”¨å…¶<code class="highlighter-rouge">explicit</code>çš„æ„é€ å‡½æ•°ï¼Œè€Œä¸èƒ½é€šè¿‡éšå¼çš„ç±»å‹è½¬æ¢</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// /shared_ptr&lt;int&gt; p1 = new int(10); //wrongï¼</span>
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p1</span><span class="p">(</span><span class="k">new</span> <span class="nf">int</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span> <span class="c1">//correct, ä½¿ç”¨ç›´æ¥åˆå§‹åŒ–å½¢å¼</span>
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">clone</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">){</span>
  <span class="c1">//return new int(p); //worng</span>
  <span class="k">return</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="kt">int</span><span class="p">(</span><span class="n">p</span><span class="p">));</span> <span class="c1">//correct</span>
<span class="p">}</span>
</code></pre></div></div>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç§æƒ…å†µï¼Œä¸è¦æ··ç”¨æ™®é€šæŒ‡é’ˆå’Œ<code class="highlighter-rouge">shared_ptr</code>ï¼Œåœ¨åˆ›å»º<code class="highlighter-rouge">shared_ptr</code>æ—¶å°±newå¯¹è±¡æˆ–è€…ä½¿ç”¨<code class="highlighter-rouge">make_shared</code>ï¼Œè€ƒè™‘ä¸‹é¢æƒ…å†µ</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
<span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">get</span><span class="p">();</span> <span class="c1">//è¿”å›pç®¡ç†çš„æŒ‡é’ˆ</span>
<span class="p">{</span>
  <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="n">q</span> <span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">//qè¢«é‡Šæ”¾ï¼Œå¯¼è‡´`ptr`æŒ‡å‘çš„å†…å­˜è¢«é‡Šæ”¾ï¼Œæ­¤æ—¶på¹¶ä¸çŸ¥æƒ…</span>
<span class="kt">int</span> <span class="n">foo</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="c1">//crash</span>
</code></pre></div></div>
<p>å½“ä½¿ç”¨ä¸€ä¸ªå·²ç»åˆå§‹åŒ–çš„æŒ‡é’ˆèµ‹ç»™<code class="highlighter-rouge">q</code>æ—¶ï¼Œä¼šå¯¼<code class="highlighter-rouge">p</code>å’Œ<code class="highlighter-rouge">q</code>ç®¡ç†åŒä¸€ç‰‡å†…å­˜ï¼Œå¹¶ä¸”è¿™ç§æƒ…å†µä¸‹ï¼Œä¸”å„è‡ªçš„å¼•ç”¨è®¡æ•°å‡ä¸º1ï¼ŒäºŒè€…ä¸­ä»»ä½•ä¸€ä¸ªè¢«é”€æ¯ä¼šå¯¼è‡´è¯¥å†…å­˜è¢«é‡Šæ”¾ï¼Œä¼šæœ‰é‡æŒ‡é’ˆè®¿é—®æˆ–è€…double freeçš„é£é™©</p>

<p><mark>é¿å…å°†ä¸€ä¸ªå·²ç»åˆå§‹åŒ–çš„æŒ‡é’ˆæ¥æ„é€ `shared_ptr`å¯¹è±¡</mark></p>

<ul>
  <li>æ‹·è´å’Œèµ‹å€¼</li>
</ul>

<p>å½“å¯¹<code class="highlighter-rouge">shared_ptr</code>å¯¹è±¡è¿›è¡Œæ‹·è´æ—¶ï¼Œä¼šå½±å“åˆ°å…¶å¼•ç”¨è®¡æ•°ï¼Œæ¯ä¸ª<code class="highlighter-rouge">shared_ptr</code>éƒ½å…³è”ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œæ¥è®°å½•æœ‰å¤šå°‘ä¸ªå…¶å®ƒçš„<code class="highlighter-rouge">shared_ptr</code>æŒ‡å‘ç›¸åŒçš„å¯¹è±¡ã€‚å½“å‘ç”Ÿæ‹·è´æ—¶ï¼Œå¼•ç”¨è®¡æ•°+1ï¼Œæ‹·è´å¯ä»¥å‘ç”Ÿåœ¨æ„é€ å‡½æ•°ï¼Œå‡½æ•°ä¼ å‚ä»¥åŠå‡½æ•°è¿”å›å€¼ã€‚</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">p</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span> <span class="c1">//pæ‰€æŒ‡å‘å¯¹è±¡çš„å¼•ç”¨è®¡æ•° = 1</span>
<span class="c1">//å¯ä»¥ä½¿ç”¨unique()æŸ¥çœ‹è¢«ç®¡ç†çš„èµ„æºæ˜¯å¦æ˜¯è‡ªå·±ç‹¬æœ‰</span>
<span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">p</span><span class="p">.</span><span class="n">unique</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span> <span class="c1">//true;</span>
<span class="k">auto</span> <span class="nf">q</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="c1">//qæ‰§è¡Œæ‹·è´æ„é€ ï¼Œå¼•ç”¨è®¡æ•°+1</span>
<span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">p</span><span class="p">.</span><span class="n">unique</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span> <span class="c1">//false, å› ä¸ºpå’Œqå…±äº«è¯¥èµ„æº</span>
<span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">q</span><span class="p">.</span><span class="n">user_count</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span> <span class="c1">//å¼•ç”¨è®¡æ•°ä¸º2</span>
</code></pre></div></div>

<p>å½“ç»™ä¸€ä¸ª<code class="highlighter-rouge">shared_ptr</code>å¯¹è±¡èµ‹ä¸€ä¸ªæ–°å€¼æˆ–æ˜¯è¯¥å¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œå…¶ç®¡ç†çš„å¼•ç”¨è®¡æ•°ä¼š-1ã€‚ä¸€æ—¦å¼•ç”¨è®¡æ•°ä¸º0ï¼Œåˆ™<code class="highlighter-rouge">shared_ptr</code>ä¼šè‡ªåŠ¨é‡Šæ”¾å¯¹è±¡å†…å­˜ã€‚</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">r</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">19</span><span class="p">);</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span> 
<span class="c1">//qæŒ‡å‘å¯¹è±¡çš„å¼•ç”¨è®¡æ•°+1</span>
<span class="c1">//ræŒ‡å‘å¯¹è±¡çš„å¼•ç”¨è®¡æ•°-1</span>
<span class="c1">//rçš„å¼•ç”¨è®¡æ•°ä¸º0ï¼Œè‡ªåŠ¨é‡Šæ”¾å†…å­˜</span>
</code></pre></div></div>
<p>ä½¿ç”¨<code class="highlighter-rouge">shared_ptr</code>çš„ä¸€ä¸ªå¥½å¤„æ˜¯ä¸éœ€è¦æƒ¦è®°ä½•æ—¶å»é‡Šæ”¾å¯¹è±¡ï¼Œä¸€ä¸ªä¾‹å­æ˜¯ç”¨<code class="highlighter-rouge">shared_ptr</code>å¯¹è±¡åšè¿”å›å€¼</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span> <span class="n">factory</span><span class="p">(</span><span class="n">T</span> <span class="n">arg</span><span class="p">){</span>
  <span class="k">return</span> <span class="n">mark_shared</span><span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>æŒ‰ç…§ä»¥å¾€çš„ç»éªŒï¼Œä½¿ç”¨è¿™ç§æ–¹å¼æ¥è¿”å›ä¸€ç›´æŒ‡é’ˆæ˜¯æœ‰é£é™©çš„ï¼ŒåŸå› åœ¨äºä½¿ç”¨è€…å¾ˆæœ‰å¯èƒ½ä¸çŸ¥é“æ€ä¹ˆå¤„ç†è¿™ä¸ªæŒ‡é’ˆï¼›å¦‚æœä½¿ç”¨<code class="highlighter-rouge">shared_ptr</code>åˆ™å¯ä»¥è®©ä½¿ç”¨è€…æ— éœ€å…³å¿ƒè¿™ä¸ªé—®é¢˜</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">use_factory</span><span class="p">(</span><span class="n">T</span> <span class="n">arg</span><span class="p">){</span>
  <span class="k">auto</span> <span class="n">p</span> <span class="o">=</span> <span class="n">factor</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//pç¦»å¼€ä½œç”¨äºï¼Œå†…å­˜è‡ªåŠ¨é‡Šæ”¾</span>
</code></pre></div></div>
<p>å†çœ‹ä¸€ä¸ªå‡½æ•°ä¼ å‚çš„ä¾‹å­</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">process</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">){</span>
  <span class="c1">//ptrè¢«copyï¼Œå¼•ç”¨è®¡æ•°+1</span>
  <span class="n">do_some_thing</span><span class="p">();</span>
  <span class="c1">//ptrè¢«é‡Šæ”¾ï¼Œå¼•ç”¨è®¡æ•°-1</span>
<span class="p">}</span>
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">(</span><span class="k">new</span> <span class="nf">int</span><span class="p">(</span><span class="mi">42</span><span class="p">));</span>
<span class="n">process</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">i</span><span class="o">=*</span><span class="n">p</span><span class="p">;</span>
</code></pre></div></div>
<ul>
  <li>ä½¿ç”¨<code class="highlighter-rouge">reset</code></li>
</ul>

<p><code class="highlighter-rouge">reset</code>çš„ä½œç”¨æ˜¯ä½¿<code class="highlighter-rouge">shared_ptr</code>æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">p6</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">DynamicArray</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="n">p6</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="nf">DynamicArray</span><span class="p">(</span><span class="mi">11</span><span class="p">));</span>
</code></pre></div></div>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœ<code class="highlighter-rouge">p6</code>æ˜¯å½“å‰å†…å­˜å¯¹è±¡çš„å”¯ä¸€æŒæœ‰è€…ï¼Œé‚£ä¹ˆå½“<code class="highlighter-rouge">p6</code>è¢«resetæ—¶ï¼Œå†…å­˜å¯¹è±¡è¢«é‡Šæ”¾ï¼Œä½†æ˜¯å¦‚æœ<code class="highlighter-rouge">p6</code>ä¸æ˜¯å”¯ä¸€æŒæœ‰è€…çš„æ—¶ï¼Œå¦‚æœ<code class="highlighter-rouge">p6</code>æƒ³è¦ä¿®æ”¹è¯¥å†…å­˜å¯¹è±¡ï¼Œå³ä¸å½±å“å…¶å®ƒæŒæœ‰è€…ï¼Œåˆ™éœ€è¦å•ç‹¬æ‹·è´ä¸€ä»½å†…å­˜</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">p6</span><span class="p">.</span><span class="n">unique</span><span class="p">()){</span>
  <span class="n">p6</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">string</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>
<span class="o">*</span><span class="n">p</span> <span class="o">+=</span> <span class="n">newVal</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>é‡Šæ”¾èµ„æº</li>
</ul>

<p>é»˜è®¤æƒ…å†µä¸‹å½“<code class="highlighter-rouge">shared_ptr</code>å¯¹è±¡ææ„æ—¶ï¼Œä¼šè°ƒç”¨<code class="highlighter-rouge">delete</code>æ¥é‡Šæ”¾å†…éƒ¨ç®¡ç†çš„å¯¹è±¡çš„å†…å­˜ã€‚<code class="highlighter-rouge">shared_ptr</code>ä¹Ÿæä¾›äº†è‡ªå®šä¹‰é‡Šæ”¾çš„æ–¹æ³•ï¼Œå¯ä»¥åœ¨æ„é€ æ—¶ï¼Œä¼ å…¥ä¸€ä¸ªlambdaè¡¨è¾¾å¼ï¼Œå‡½æ•°æŒ‡é’ˆæˆ–è€…Functoræ¥è‡ªå®šä¹‰ææ„é€»è¾‘</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ä½¿ç”¨lambdaè¡¨è¾¾å¼æ¸…ç†intæ•°ç»„</span>
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">sp</span><span class="p">(</span><span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="mi">10</span><span class="p">],[](</span><span class="o">*</span><span class="n">p</span><span class="p">){</span>
  <span class="k">delete</span> <span class="p">[]</span><span class="n">p</span><span class="p">;</span>
<span class="p">})</span>
</code></pre></div></div>
<ul>
  <li>APIæ•´ç†</li>
</ul>

<table>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">shared_ptr&lt;T&gt; p(q)</code></td>
      <td>qæ˜¯å†…ç½®æŒ‡é’ˆ</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">shared_ptr&lt;T&gt; p(u)</code></td>
      <td>uæ˜¯unique_ptrï¼Œpä»ué‚£é‡Œæ¥ç®¡äº†å¯¹è±¡çš„æ‰€æœ‰æƒï¼Œå°†uç½®ä¸ºç©º</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">shared_ptr&lt;T&gt; p(q,d)</code></td>
      <td>qæ˜¯å†…ç½®æŒ‡é’ˆï¼Œdæ˜¯è‡ªå®šä¹‰ææ„å‡½æ•°</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">shared_ptr&lt;T&gt; p(p2,d)</code></td>
      <td>pæ˜¯shared_ptr<T> p2çš„æ‹·è´ï¼Œdæ˜¯è‡ªå®šä¹‰ææ„å‡½æ•°</T></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">reset</code></td>
      <td>è‹¥pæ˜¯å”¯ä¸€æŒ‡å‘å…¶å¯¹è±¡çš„shared_ptr, resetä¼šé‡Šæ”¾æ­¤å¯¹è±¡</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">reset(q)</code></td>
      <td>pæŒ‡å‘å†…ç½®æŒ‡é’ˆq</td>
    </tr>
  </tbody>
</table>

<h3 id="weak_ptr">weak_ptr</h3>

<p><code class="highlighter-rouge">weak_ptr</code>æ˜¯ä¸€ç§ä¸æ§åˆ¶æ‰€æŒ‡å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ç”±ä¸€ä¸ª<code class="highlighter-rouge">shared_ptr</code>ç®¡ç†çš„å¯¹è±¡ï¼Œå°†<code class="highlighter-rouge">weak_ptr</code>ç»‘å®šåˆ°<code class="highlighter-rouge">shared_ptr</code>ä¸ä¼šå½±å“æ”¹å˜åè€…çš„å¼•ç”¨è®¡æ•°ã€‚ä¸€æ—¦æœ€åä¸€ä¸ªæŒ‡å‘å¯¹è±¡çš„<code class="highlighter-rouge">shared_ptr</code>è¢«é”€æ¯ï¼Œå¯¹è±¡å†…å­˜å°±ä¼šè¢«é‡Šæ”¾ï¼Œå³æ˜¯æœ‰<code class="highlighter-rouge">weak_ptr</code>å­˜åœ¨ï¼Œå¯¹è±¡ä¾æ—§ä¼šè¢«é‡Šæ”¾ã€‚</p>

<p>åˆ›å»ºä¸€ä¸ª<code class="highlighter-rouge">weak_ptr</code>å¯¹è±¡ï¼Œéœ€è¦ä¼ å…¥<code class="highlighter-rouge">shared_ptr</code>ã€‚ä½¿ç”¨<code class="highlighter-rouge">weak_ptr</code>æ—¶ï¼Œä¸èƒ½ç›´æ¥è®¿é—®å…¶å†…ç½®æŒ‡é’ˆï¼Œå› ä¸ºå¯¹è±¡å¯èƒ½å·²ç»è¢«é‡Šæ”¾ï¼Œéœ€è¦å…ˆä½¿ç”¨<code class="highlighter-rouge">lock</code>æ£€æŸ¥å¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼Œè¿›è€Œè®¿é—®</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">p</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
<span class="n">weak_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">wp</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">np</span> <span class="o">=</span> <span class="n">wp</span><span class="p">.</span><span class="n">lock</span><span class="p">()){</span> <span class="c1">//lockè¿”å›ä¸€ä¸ªshared_ptrå¯¹è±¡</span>
  <span class="n">cout</span><span class="o">&lt;&lt;*</span><span class="n">np</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="åŠ¨æ€æ•°ç»„">åŠ¨æ€æ•°ç»„</h3>

<ul>
  <li><code class="highlighter-rouge">new</code>å’Œæ•°ç»„</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="o">*</span><span class="n">pia</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span> <span class="c1">//10ä¸ªæœªåˆå§‹åŒ–çš„int</span>
<span class="kt">int</span> <span class="o">*</span><span class="n">pia2</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="mi">10</span><span class="p">]();</span> <span class="c1">//10ä¸ªåˆå€¼ä¸º0çš„int</span>
<span class="kt">int</span> <span class="o">*</span><span class="n">pia3</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">};</span>
<span class="kt">int</span> <span class="o">*</span><span class="n">psa</span> <span class="o">=</span> <span class="k">new</span> <span class="n">string</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span> <span class="c1">//10ä¸ªç©ºstring</span>
<span class="kt">int</span> <span class="o">*</span><span class="n">psa2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">string</span><span class="p">[</span><span class="mi">10</span><span class="p">]();</span> <span class="c1">//10ä¸ªç©ºstring</span>

<span class="c1">//delete</span>
<span class="k">delete</span> <span class="p">[]</span> <span class="n">pia</span><span class="p">;</span>
</code></pre></div></div>
<p>åœ¨é”€æ¯æ•°ç»„ä¸­çš„å¯¹è±¡æ—¶ï¼Œææ„é¡ºåºæŒ‰ç…§é€†åºè¿›è¡Œï¼Œå³æœ€åä¸€ä¸ªå…ƒç´ å…ˆè¢«é”€æ¯</p>

<ul>
  <li>ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ</li>
</ul>

<p>ä¸<code class="highlighter-rouge">new</code>å¯¹åº”ï¼ŒC++ 11ä¸­åˆ»æ„ä½¿ç”¨<code class="highlighter-rouge">std::unique_ptr&lt;int[]&gt;</code>ç±»å‹æ¥åŒ…è£…åŠ¨æ€æ•°ç»„</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">unique</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">[]</span><span class="o">&gt;</span> <span class="n">up</span><span class="p">(</span><span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
<span class="n">up</span><span class="p">.</span><span class="n">release</span><span class="p">();</span> <span class="c1">//è‡ªåŠ¨delete []é”€æ¯å…¶æŒ‡é’ˆ</span>
</code></pre></div></div>
<p>ç”±äº<code class="highlighter-rouge">unique_ptr</code>æŒ‡å‘ä¸€ä¸ªæ•°ç»„ï¼Œå› æ­¤æ²¡æœ‰ç‚¹æˆ–è€…ç®­å¤´æˆå‘˜è¿ç®—ç¬¦ï¼Œå¦‚æœæƒ³è¦éå†æ•°ç»„ï¼Œå¯ä»¥è¿˜æ˜¯ç”¨<code class="highlighter-rouge">for</code>å¾ªç¯</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
  <span class="n">up</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="c1">//unique_ptræ”¯æŒä¸‹æ ‡è¿ç®—</span>
<span class="p">}</span>
</code></pre></div></div>
<p>å¦‚æœæƒ³è¦ä½¿ç”¨<code class="highlighter-rouge">shared_ptr</code>åˆ™éœ€è¦ä¸ºå…¶æŒ‡å®šææ„å‡½æ•°</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">sp</span><span class="p">(</span><span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="p">[](</span><span class="kt">int</span> <span class="o">*</span><span class="n">p</span><span class="p">){</span> <span class="k">delete</span> <span class="p">[]</span> <span class="n">p</span><span class="p">;});</span>
</code></pre></div></div>
<p>å¦å¤–ï¼Œ<code class="highlighter-rouge">shared_ptr</code>å¹¶ä¸æ”¯æŒä¸‹æ ‡è¿ç®—ï¼Œå› æ­¤æƒ³è¦éå†æ•°ç»„éœ€è¦é€šè¿‡<code class="highlighter-rouge">get()</code>å¾—åˆ°æŒ‡é’ˆå‘¨å†éå†ï¼Œè¿™ä¸æ˜¯ä¸€ç§å¥½çš„é€‰æ‹©ã€‚</p>

<h3 id="ä½¿ç”¨allocator">ä½¿ç”¨<code class="highlighter-rouge">allocator</code></h3>

<p><code class="highlighter-rouge">new</code>æœ‰ä¸€äº›çµæ´»ä¸Šçš„å±€é™æ€§ï¼Œå…¶ä¸­ä¸€æ–¹é¢æ˜¯å®ƒå°†å†…å­˜åˆ†é…å’Œå¯¹è±¡æ„é€ ç»“åˆåœ¨äº†ä¸€èµ·ï¼Œç±»ä¼¼çš„ï¼Œ<code class="highlighter-rouge">delete</code>ä¹Ÿå°†å¯¹è±¡ææ„å’Œå†…å­˜é‡Šæ”¾ç»“åˆåœ¨äº†ä¸€èµ·ã€‚å¯¹äºå•ä¸ªå¯¹è±¡ï¼Œè¿™ç§ç­–ç•¥æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯å½“åˆ†é…ä¸€å¤§å—å†…å­˜æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å†…å­˜çš„åˆ†é…å’Œå¯¹è±¡çš„æ„é€ è¿›è¡Œåˆ†ç¦»ã€‚C++ æ ‡å‡†åº“ä¸­çš„<code class="highlighter-rouge">allocator</code>æä¾›äº†å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆè¿™ä¸ªå·¥ä½œ</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">allocator</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">alloc</span><span class="p">;</span>
<span class="k">auto</span> <span class="k">const</span> <span class="n">p</span> <span class="o">=</span> <span class="n">alloc</span><span class="p">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="http://www.charleshouserjr.com/Cplus2.pdf">C++ Primer</a></li>
  <li><a href="https://www.amazon.com/Effective-Modern-Specific-Ways-Improve/dp/1491903996/">Effective Modern C++</a></li>
</ul>
:ET