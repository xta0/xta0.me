I"±›<p>ä»Šå¤©è®¨è®ºä¸‹UIç»˜åˆ¶çš„æ€§èƒ½é—®é¢˜ï¼Œé€šå¸¸æ¥è¯´ï¼Œå¦‚æœç†Ÿæ‚‰ä¸‹é¢åˆ—å‡ºçš„å†…å®¹åŸºæœ¬ä¸Šèƒ½è§£å†³80%ä»¥ä¸Šçš„æ€§èƒ½é—®é¢˜äº†ï¼š</p>

<ol>
  <li><a href="https://xta0.me/2012/10/22/iOS-UIView-Rendering.html">UIViewæ˜¯å¦‚ä½•æ¸²æŸ“åˆ°å±å¹•ä¸Šçš„</a></li>
  <li>WWDC2011:Session 318 - iOS Performance in Depth</li>
  <li>WWDC2012:Session 238 - iOS App Performance_ Graphics and Animations</li>
  <li>ç†Ÿç»ƒInstrumentçš„Time Profilerå’ŒCore Animation</li>
</ol>

<p>æ¥ä¸‹æ¥è®¨è®ºä¸‰ä¸ªæˆ‘è®¤ä¸ºæœ‰ä»·å€¼çš„ç‚¹ï¼š</p>

<ol>
  <li>Twitterçš„è¿™ç¯‡å…³äºtableviewä¼˜åŒ–çš„æ–‡ç« ï¼Œæ˜¯å¯¹è¿˜æ˜¯é”™ï¼Ÿ</li>
  <li>CoreTextæœ€ä½³æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ</li>
  <li>å¼‚æ­¥ç»˜åˆ¶</li>
</ol>

<h3 id="layer-trees-vs-flat-drawing">Layer Trees v.s. Flat Drawing</h3>

<p>åŸºæœ¬ä¸Šï¼Œå¦‚æœå»ä¼˜åŒ–UITableviewçš„æ»šåŠ¨æ€§èƒ½ï¼Œéƒ½ä¼šè¯»åˆ°<a href="https://blog.twitter.com/engineering/en_us/a/2012/simple-strategies-for-smooth-animation-on-the-iphone.html">Twitterçš„è¿™ç¯‡æ–‡ç« </a>ã€‚è¿™ç¯‡æ–‡ç« å…¶å®å°±è¯´äº†ä¸€ä»¶äº‹ï¼šå°†cellä¸Šå¤æ‚çš„UIå±‚æ¬¡ç»“æ„ï¼Œç®€åŒ–ä¸ºä¸€ä¸ªLayerã€‚</p>

<p>ä¾‹å¦‚ï¼šè¦å±•ç¤ºè¿™æ ·ä¸€ä¸ªcellï¼š</p>

<p><img src="/assets/images/2013/07/cell.png" alt="" /></p>

<h3 id="ä¼ ç»Ÿçš„åšæ³•">ä¼ ç»Ÿçš„åšæ³•</h3>

<p>ä¼ ç»Ÿçš„åšæ³•æ˜¯å®šä¹‰ä¸€ä¸ª<code class="highlighter-rouge">cell</code>ï¼Œåœ¨<code class="highlighter-rouge">cell</code>çš„<code class="highlighter-rouge">contentView</code>ä¸Šæ·»åŠ UIå…ƒç´ ï¼šä¸‰ä¸ªlabelï¼Œä¸€ä¸ªimagViewï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@implementation</span> <span class="nc">ETTableViewDemoAppStoreCell</span>
<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="nf">initWithStyle</span><span class="p">:(</span><span class="n">UITableViewCellStyle</span><span class="p">)</span><span class="nv">style</span> <span class="nf">reuseIdentifier</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">reuseIdentifier</span> 
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">=</span><span class="p">[</span><span class="n">super</span> <span class="nf">initWithStyle</span><span class="p">:</span><span class="n">style</span> <span class="nf">reuseIdentifier</span><span class="p">:</span><span class="n">reuseIdentifier</span><span class="p">])</span> 
    <span class="p">{</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">contentView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">nameLabel</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">contentView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">priceLabel</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">contentView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">summaryLabel</span><span class="p">];</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">contentView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">imgView</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>  
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setItem</span><span class="p">:(</span><span class="n">ETTableViewDemoAppStoreItem</span><span class="o">*</span> <span class="p">)</span><span class="nv">item</span>
<span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">nameLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">appName</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">priceLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">appPrice</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">summaryLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">appSummary</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">imgView</span> <span class="nf">setImageURL</span><span class="p">:</span><span class="n">item</span><span class="p">.</span><span class="n">appImageURL</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">layoutSubviews</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">layoutSubviews</span><span class="p">];</span>

    <span class="n">self</span><span class="p">.</span><span class="n">imgView</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
    <span class="n">self</span><span class="p">.</span><span class="n">nameLabel</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>
    <span class="n">self</span><span class="p">.</span><span class="n">priceLabel</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
    <span class="n">self</span><span class="p">.</span><span class="n">summaryLabel</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<h3 id="twitterçš„åšæ³•">Twitterçš„åšæ³•</h3>

<p>é¦–å…ˆä¹Ÿæ˜¯éœ€è¦å®šä¹‰ä¸ªcellï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">ETTableViewDemoAppStoreFlatCell</span> <span class="p">:</span> <span class="nc">ETTableViewSingleImageCell</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>è¿™é‡Œé¢ä¸å®šä¹‰ä»»ä½•UIå…ƒç´ ï¼Œç„¶ååœ¨cellçš„contentViewä¸Šåªaddä¸€ä¸ªviewï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="nf">initWithFrame</span><span class="p">:(</span><span class="n">CGRect</span><span class="p">)</span><span class="nv">frame</span>
<span class="p">{</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">initWithFrame</span><span class="p">:</span><span class="n">frame</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">_internalContentView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ETTableViewDemoAppStoreFlatContentView</span> <span class="nf">alloc</span><span class="p">]</span><span class="nf">initWithFrame</span><span class="p">:</span><span class="n">CGRectZero</span><span class="p">];</span>
        <span class="n">_internalContentView</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">clearColor</span><span class="p">];</span>
        <span class="n">_internalContentView</span><span class="p">.</span><span class="n">contentMode</span> <span class="o">=</span> <span class="n">UIViewContentModeRedraw</span><span class="p">;</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">contentView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">_internalContentView</span><span class="p">];</span>

    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç”±äº<code class="highlighter-rouge">internalContentView</code>çš„<code class="highlighter-rouge">contentMode</code>ä¸º<code class="highlighter-rouge">Redraw</code>ï¼Œå› æ­¤æ¯å½“å®ƒ<code class="highlighter-rouge">frame</code>æ”¹å˜çš„æ—¶å€™ï¼Œéƒ½ä¼šé‡æ–°ç»˜åˆ¶ä¸€æ¬¡ã€‚</p>

<p>è¿™ä¸ªInternalContentViewçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">ETTableViewDemoAppStoreFlatContentView</span> <span class="p">:</span> <span class="nc">UIView</span>

<span class="k">@property</span><span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span><span class="n">strong</span><span class="p">)</span> <span class="n">ETTableViewDemoAppStoreItem</span><span class="o">*</span> <span class="n">item</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">ETTableViewDemoAppStoreFlatContentView</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">drawRect</span><span class="p">:(</span><span class="n">CGRect</span><span class="p">)</span><span class="nv">rect</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">drawRect</span><span class="p">:</span><span class="n">rect</span><span class="p">];</span>

    <span class="c1">//draw image</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">item</span><span class="p">.</span><span class="n">image</span> <span class="nf">drawInRect</span><span class="p">:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">)];</span>

    <span class="c1">//draw text</span>
    <span class="p">[[</span><span class="n">UIColor</span> <span class="nf">blackColor</span><span class="p">]</span><span class="nf">set</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">item</span><span class="p">.</span><span class="n">appName</span> <span class="nf">drawInRect</span><span class="p">:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span> <span class="nf">withFont</span><span class="p">:[</span><span class="n">UIFont</span> <span class="nf">systemFontOfSize</span><span class="p">:</span><span class="mi">16</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">]</span> <span class="n">lineBreakMode</span><span class="o">:</span><span class="n">NSLineBreakByTruncatingTail</span><span class="p">];</span>

    <span class="c1">//draw price</span>
    <span class="p">[[</span><span class="n">UIColor</span> <span class="nf">grayColor</span><span class="p">]</span> <span class="nf">set</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">item</span><span class="p">.</span><span class="n">appPrice</span> <span class="nf">drawInRect</span><span class="p">:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span> <span class="nf">withFont</span><span class="p">:[</span><span class="n">UIFont</span> <span class="nf">systemFontOfSize</span><span class="p">:</span><span class="mi">14</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">]</span> <span class="n">lineBreakMode</span><span class="o">:</span><span class="n">NSLineBreakByTruncatingTail</span><span class="p">];</span>

    <span class="c1">//draw price</span>
    <span class="p">[[</span><span class="n">UIColor</span> <span class="nf">grayColor</span><span class="p">]</span> <span class="nf">set</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">item</span><span class="p">.</span><span class="n">appPrice</span> <span class="nf">drawInRect</span><span class="p">:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span> <span class="nf">withFont</span><span class="p">:[</span><span class="n">UIFont</span> <span class="nf">systemFontOfSize</span><span class="p">:</span><span class="mi">14</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">]</span> <span class="n">lineBreakMode</span><span class="o">:</span><span class="n">NSLineBreakByTruncatingTail</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">InternalContent</code>é€šè¿‡å®ç°å®ƒ<code class="highlighter-rouge">drawRect</code>çš„æ–¹æ³•ï¼Œå°†æ•°æ®ç»˜åˆ¶å‡ºæ¥ã€‚</p>

<p>ç„¶åå°±æ˜¯cellå¦‚ä½•å»è§¦å‘internalContentViewç»˜åˆ¶ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">prepareForReuse</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">prepareForReuse</span><span class="p">];</span>

    <span class="n">_internalContentView</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectZero</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">layoutSubviews</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">layoutSubviews</span><span class="p">];</span>

    <span class="n">_internalContentView</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CGRectGetWidth</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">frame</span><span class="p">),</span> <span class="n">CGRectGetHeight</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">frame</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>
<p>å½“tableviewæ»šåŠ¨çš„æ—¶å€™ï¼Œç”±äº<code class="highlighter-rouge">view</code>çš„<code class="highlighter-rouge">size</code>ä¸æ–­å˜åŒ–ï¼Œ<code class="highlighter-rouge">view</code>å¯ä»¥ä¸æ–­çš„é‡ç»˜ã€‚</p>

<p>ä¸‹é¢æˆ‘ä»¬å…ˆæ¥æƒ³ä¸‹è¿™ä¸¤ç§æ–¹å¼èƒŒåçš„å·®åˆ«ï¼š</p>

<ul>
  <li>
    <p>ä¼ ç»Ÿæ–¹å¼ï¼šå½“æ–°çš„ä¸€å¸§åˆ°æ¥æ—¶å€™ï¼Œ<code class="highlighter-rouge">cell</code>é¦–å…ˆè¦å°†æ•°æ®äº¤ç»™ä¸‰ä¸ªlabelå»ç»˜åˆ¶ï¼Œç”±äº<code class="highlighter-rouge">cell</code>ä¸Šçš„UIå…ƒç´ æœ¬èº«å°±æ˜¯å¤ç”¨çš„ï¼Œå› æ­¤<code class="highlighter-rouge">label</code>ä¸ä¼šé‡æ–°åˆ›å»ºï¼Œåªéœ€è¦é‡æ–°updateè‡ªå·±çš„backing storeï¼Œå°†æ–°çš„textæ•°æ®å†™è¿›å»ï¼Œç”Ÿæˆbitmapã€‚<code class="highlighter-rouge">imageView</code>åŒç†ï¼Œä½†æ˜¯ç”±äº<code class="highlighter-rouge">imageview</code>ä¸éœ€è¦update backing storeï¼Œå®ƒçš„<code class="highlighter-rouge">layer</code>ç›´æ¥æŒ‡å‘äº†ä¸€å—bitmapã€‚åˆ°æ­¤CPUçš„å·¥ä½œåšå®Œäº†ï¼ŒGPUè¦å°†<code class="highlighter-rouge">cell</code>å’Œè¿™ä¸‰ä¸ª<code class="highlighter-rouge">label</code>åŠ <code class="highlighter-rouge">imageview</code>ç»„æˆçš„<code class="highlighter-rouge">layer tree</code>ä¸€èµ·åšcompositingï¼Œæœ€åæ¸²æŸ“å‡ºæ¥ã€‚</p>
  </li>
  <li>
    <p>twitterçš„æ–¹å¼ï¼šå½“ä¸€ä¸ªæ–°çš„runloopåˆ°æ¥ï¼Œç”±äº<code class="highlighter-rouge">cell</code>ä¸Šä¹‹åªæœ‰ä¸€ä¸ª<code class="highlighter-rouge">internalContentView</code>ï¼Œå®ƒæ›´æ–°å®Œè‡ªå·±çš„backing storeåç”Ÿæˆä¸€å—bitmapäº¤ç»™GPUï¼Œè€ŒGPUç”±äºä¹‹æ¸²æŸ“ä¸€ä¸ªbitmapï¼Œcompostingçš„å‹åŠ›ä¹Ÿä¸å¤§ã€‚</p>
  </li>
</ul>

<p>ä»ä¸Šé¢çš„è¿‡ç¨‹æ¥çœ‹ï¼Œæ˜¾ç„¶ï¼Œä¼ ç»Ÿæ–¹å¼GPUçš„å·¥ä½œå¤šä¸€äº›ï¼Œå½“layer-treeå¾ˆå¤æ‚çš„æ—¶å€™ï¼ŒGPUçš„è€—æ—¶ä¹Ÿä¼šå¢åŠ ï¼Œä½†æ˜¯CPUçš„å‹åŠ›ä¸å¤§ã€‚twitterè¿™ç§æ–¹å¼ï¼ŒCPUçš„å‹åŠ›å¤§ä¸€äº›ï¼Œå› ä¸ºCore Graphicçš„apiæ˜¯CPUåœ¨æ‰§è¡Œï¼Œä½†æ˜¯ç”±äºä¹‹æ¸²æŸ“ä¸€ä¸ªbitmapï¼ŒGPUçš„å‹åŠ›å°å¾ˆå¤šã€‚</p>

<h3 id="ç»“è®º">ç»“è®º</h3>

<p>æ‰€ä»¥ï¼Œè¿™æ˜¯ä¸€ä¸ªtest - measureçš„è¿‡ç¨‹ã€‚twitteræœ€å¼€å§‹ä½¿ç”¨è¿™ç§æ–¹å¼è€Œè·å¾—æ€§èƒ½ä¸Šçš„æˆåŠŸè¦è¿½æº¯åˆ°2008å¹´ï¼Œé‚£æ—¶å€™çš„iPhoneè¿˜æ˜¯ä½æ¸…å±çš„3gsï¼Œåˆ°äº†retinaçš„æ—¶ä»£ï¼Œè¿™ç§æ–¹å¼è¿˜é€‚ä¸é€‚åˆï¼Œ<a href="http://floriankugler.com/blog/2013/5/24/layer-trees-vs-flat-drawing-graphics-performance-across-ios-device-generations">è¿™ç¯‡æ–‡ç« </a>ç»™å‡ºäº†é‡åŒ–çš„ç»“è®ºï¼šåœ¨retinaçš„æ—¶ä»£é‡Œï¼Œä½¿ç”¨Core Graphicç»˜åˆ¶çš„ä»£ä»·è¿œé«˜äºGPUæ¸²æŸ“layer-treeçš„ä»£ä»·ï¼Œåœ¨iPhone4åŠä»¥åçš„å¹³å°ä¸Šä½¿ç”¨è¿™ç§æ–¹å¼ç»˜åˆ¶cellï¼Œæ—¶é—´åè€Œä¼šå˜é•¿ï¼Œtwitterçš„è¿™ç§æ–¹å¼è¿‡æ—¶äº†ï¼</p>

<p>ä½†å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘æ›´å–œæ¬¢ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå€’ä¸æ˜¯å› ä¸ºæ•ˆç‡é—®é¢˜ï¼Œè€Œæ˜¯è¿™ç§å†™æ³•å¾ˆç®€å•ï¼Œé¡¹ç›®é‡Œï¼Œä¸€èˆ¬ä¸å¤æ‚çš„åˆ—è¡¨ï¼Œæ²¡æœ‰æ€§èƒ½é—®é¢˜çš„ï¼Œéƒ½å¯ä»¥è¿™ä¹ˆå®ç°ã€‚ä½†æ˜¯å¦‚æœå¾ˆå¤æ‚çš„åˆ—è¡¨ï¼Œæœ‰å¾ˆå¤šsubviewï¼Œä½¿ç”¨è¿™ç§æ–¹å¼å°±ä¸å¤ªé€‚åˆäº†ï¼Œå°¤å…¶åœ¨retinaå±ä¸Šï¼Œæ•ˆç‡é™ä½äº†ã€‚</p>

<h3 id="coretext-optimization">CoreText Optimization</h3>

<p>è¿™ä¸€èŠ‚ä¸»è¦æ¥è®¨è®ºä½¿ç”¨CoreTextç»˜åˆ¶æ–‡æœ¬çš„ä¼˜åŒ–ï¼Œåœºæ™¯æ˜¯è¿™æ ·çš„ï¼š</p>

<p>å¯¹äºç¤¾äº¤ç±»çš„appå¦‚å¾®åšï¼Œå¾®ä¿¡ï¼Œéƒ½æœ‰ç”¨æˆ·å†…å®¹çš„timelineï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªtableviewï¼‰ï¼Œåœ¨timelineä¸­ï¼Œç”¨æˆ·ä¼šå‘ä¸€äº›è¡¨æƒ…ï¼Œä¼šæœ‰##è¯é¢˜ï¼Œ@æŸäººï¼Œå‘èµ·ä¸€ä¸ªhttpè¿æ¥ç­‰ï¼Œä¸€èˆ¬è¿™ç§åœºåˆåœ¨iOSä¸­ä¼šç”¨<code class="highlighter-rouge">CoreText</code>å¤„ç†ï¼Œå‡è®¾æˆ‘ä»¬ç»˜åˆ¶è¿™æ ·ä¸€æ®µæ–‡æœ¬ï¼š</p>

<p><a href="/blogimages/2013/07/coretext.png"><img class="alignnone size-full wp-image-257" alt="coretext" src="/assets/images/2013/07/coretext.png" width="308" height="161" /></a></p>

<p>ç»˜åˆ¶è¿™æ®µæ–‡æœ¬çš„ç“¶é¢ˆéƒ½æœ‰ä»€ä¹ˆå‘¢ï¼Ÿ</p>

<ol>
  <li>
    <p>éœ€è¦é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼š[å“ˆå“ˆ]â€¦è¿™ç§æ–‡æœ¬ï¼Œç„¶åæ›¿æ¢æˆè¡¨æƒ…</p>
  </li>
  <li>
    <p>éœ€è¦é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼š@ï¼Œ#ï¼Œhttp://è¿™ç§å…³é”®å­—ï¼Œç„¶åé«˜äº®</p>
  </li>
  <li>
    <p>ç»˜åˆ¶AttributedStringå’Œè¡¨æƒ…å›¾ç‰‡</p>
  </li>
</ol>

<p>è¿™äº›éƒ½è¦é€šè¿‡CPUæ¥å®Œæˆï¼Œè€Œä¸”åœ¨tableviewæ»šåŠ¨çš„æ—¶å€™ï¼Œlabelè™½ç„¶å¯ä»¥å¤ç”¨ï¼Œä½†ä¸Šé¢å±•ç¤ºçš„å†…å®¹å´éœ€è¦å®æ—¶çš„è®¡ç®—å’Œç»˜åˆ¶ï¼Œå°±ä»¥ä¸Šè¿°é‚£æ®µæ–‡æœ¬ä¸ºä¾‹ï¼Œä¸Šè¿°3æ¡èŠ±è´¹çš„æ—¶é—´å¦‚ä¸‹ï¼š</p>

<p><a href="/assets/images/2013/07/time.png"><img src="/assets/images/2013/07/time.png" alt="time" width="785" height="124" /></a></p>

<p>è¿™ä¸ªç»“æœèƒ½çœ‹å‡ºä¸¤ä»¶äº‹æƒ…ï¼š</p>

<ol>
  <li>
    <p>åœ¨éretinaçš„3gsä¸Šï¼ŒCoreTextç»˜åˆ¶çš„æ—¶é—´ä½äºretinaå±çš„iPhone4ï¼Œå†æ¬¡å°è¯äº†ä¸Šé¢çš„ç»“è®ºã€‚</p>
  </li>
  <li>
    <p>å³ä½¿æ˜¯iphone5åœ¨ä¸åšä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œä»æ£€æµ‹åˆ°ç»˜åˆ¶è¿™æ®µæ–‡å­—ä¹Ÿéœ€è¦16mså·¦å³ã€‚è™½ç„¶å®é™…æƒ…å†µä¸­ï¼Œä¸æ˜¯æ¯ä¸€æ®µæ–‡æœ¬å†…å®¹éƒ½è¿™ä¹ˆå¤æ‚ï¼Œä½†å¦‚æœç¢°è§ä¸€ä¸¤æ¡ï¼Œå°±ä¼šå‡ºç°æ˜æ˜¾çš„å¡é¡¿æ„Ÿå‡ºç°ï¼Œè€Œä¸”å³ä½¿æ–‡æœ¬ä¸å¤æ‚çš„æƒ…å†µï¼Œå°±ç®—å®ƒéœ€è¦8msï¼Œé‚£ä¹ˆå¦‚æœä¸ä¼˜åŒ–ï¼Œç•™ç»™å…¶å®ƒUIå…ƒç´ çš„ç»˜åˆ¶æ—¶é—´å°±ä¼šå˜çŸ­ï¼Œå¯¹äº60fpsï¼Œ16ms/fçš„æ ‡å‡†ï¼Œæ˜¯å¾ˆéš¾è¾¾åˆ°çš„ã€‚</p>
  </li>
</ol>

<p>ä¸‹é¢æˆ‘ä»¬è®¨è®ºä¸‹ä¼˜åŒ–æ–¹æ¡ˆï¼š</p>

<ol>
  <li>
    <p>ä¿®æ”¹æ­£åˆ™è¡¨è¾¾å¼ï¼Œæé«˜æ•ˆç‡</p>
  </li>
  <li>
    <p>å…ˆæŠŠæ–‡æœ¬ç»˜åˆ¶å‡ºæ¥ï¼Œç„¶ååœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è®¡ç®—æ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é…keywordså’Œè¡¨æƒ…</p>
  </li>
  <li>
    <p>æå‰æ¸²æŸ“å¥½æŠŠå®ƒå˜æˆå›¾ç‰‡</p>
  </li>
</ol>

<p>ç¬¬ä¸€ç§æ–¹æ¡ˆç¡®æœ‰ä¼˜åŒ–çš„ç©ºé—´ï¼Œä½†æ˜¯ç©ºé—´ä¸å¤§ï¼Œå³ä½¿ä¼˜åŒ–åˆ°3msä»¥å†…ï¼Œç»˜åˆ¶ä»ç„¶éœ€è¦8-10msï¼Œæ€»ä½“ä¹Ÿè¶…è¿‡äº†10msï¼Œæ„ä¹‰ä¸å¤§ã€‚</p>

<p>ç¬¬äºŒç§æ–¹æ¡ˆå¯ä»¥ï¼Œä½†ä¼šæœ‰è§†è§‰çš„çªå˜æ„Ÿï¼Œæ–‡æœ¬çš„frameä¹Ÿä¼šæœ‰çªå˜ï¼Œç”¨æˆ·ä½“éªŒå¾ˆå·®</p>

<p>ç¬¬ä¸‰ç§æ–¹æ¡ˆæ˜¯æœ€ä½³çš„ï¼Œåœ¨å±•ç¤ºæ–‡æœ¬å‰ï¼Œå…ˆæå‰æŠŠå®ƒç»˜åˆ¶æˆä¸€å¹…å›¾ç‰‡ä¿å­˜å¥½ï¼Œæ˜¾ç¤ºçš„æ—¶å€™è®©layerçš„contentæŒ‡å‘å®ƒã€‚</p>

<p>ç›®å‰å¼€æºçš„æœ‰<a href="https://github.com/mattt/TTTAttributedLabel">TTTAttributeLabel</a>ï¼Œ320ä½œè€…å†™çš„ï¼Œä¹Ÿæ˜¯AFNetworkingçš„ä½œè€…ï¼Œå®ƒé‡Œé¢ä¼˜åŒ–çš„æ–¹æ¡ˆæ˜¯ç¬¬äºŒç§ï¼šdeferDetectionï¼Œä½†å®é™…çš„æ•ˆæœæ¥çœ‹ï¼Œå¹¶ä¸ç†æƒ³ã€‚</p>

<p>æˆ‘ç”¨ç¬¬ä¸‰ç§æ–¹æ¡ˆçš„æ€è·¯å®ç°äº†<code class="highlighter-rouge">ETAttributedLabel</code>ï¼Œç”¨æ³•å’Œ<code class="highlighter-rouge">UILabel</code>ä¸€æ ·ã€‚å®ƒæœ€å¤§çš„ä¼˜åŠ¿åœ¨äºæä¾›äº†ä¸€ä¸ª<code class="highlighter-rouge">parser</code>ï¼Œå¯ä»¥å°†è®¡ç®—ï¼Œè§£æï¼Œç»˜åˆ¶ç­‰è€—æ—¶çš„æ“ä½œå’ŒUIæ˜¾ç¤ºå‰¥ç¦»å¼€,è€Œä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æˆ‘ä»¬å¯ä»¥å…ˆä½¿ç”¨<code class="highlighter-rouge">parser</code>åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ç”Ÿæˆå¥½<code class="highlighter-rouge">attributedString</code>ç„¶åä¸¢ç»™<code class="highlighter-rouge">label</code>ç›´æ¥æ˜¾ç¤ºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨parserå°†æ–‡æœ¬ç›´æ¥ä¼šåˆ¶æˆå›¾ç‰‡ï¼Œç„¶åä¸¢ç»™<code class="highlighter-rouge">label.layer.content</code>ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">ETUIAttributeStringParser</span><span class="o">*</span> <span class="n">parser</span> <span class="o">=</span> <span class="p">[</span><span class="n">ETUIAttributeStringParser</span> <span class="nf">new</span><span class="p">];</span>
<span class="n">parser</span><span class="p">.</span><span class="n">constraintTextWidth</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
<span class="n">parser</span><span class="p">.</span><span class="n">lineHeight</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">parser</span><span class="p">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">blackColor</span><span class="p">];</span>
<span class="n">parser</span><span class="p">.</span><span class="n">textFont</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="nf">systemFontOfSize</span><span class="p">:</span><span class="mi">14</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">];</span>
<span class="n">parser</span><span class="p">.</span><span class="n">linkColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">orangeColor</span><span class="p">];</span>
<span class="n">parser</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">clearColor</span><span class="p">];</span>
<span class="n">parser</span><span class="p">.</span><span class="n">highlightedLinkBackgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">colorWithWhite</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="nf">alpha</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">];</span>
<span class="n">parser</span><span class="p">.</span><span class="n">cleanText</span> <span class="o">=</span><span class="s">@"#wwdc2013#é’ˆå¯¹ iOS 7 ä¸­å¢åŠ çš„ä¸€ä¸ªæ•´ä½“è°ƒæ•´å­—ä½“çš„æ”¯æŒçš„æè¿°[smile]ã€‚ä»å¤§å°ä¸Šå’Œæ ·å¼ç±»å‹ä¸Šï¼Œä»¥åŠå¯¹ Accessbility (è¾…åŠ©åŠŸèƒ½) ä¸Šçš„æ”¯æŒï¼Œå³é’ˆå¯¹ä¸€äº›å­˜åœ¨è§†åŠ›æˆ–å¬åŠ›éšœç¢çš„ç”¨æˆ·çš„ç‰¹åˆ«é€‚é…[dizzle][dizzle]ã€‚é’ˆå¯¹æ–‡å­—æ’ç‰ˆç›¸å…³çš„å¢å¼ºï¼Œæ¨å‡ºäº†TextKit[smile][kiss]ï¼Œå…³äºè¿™å—çš„è¯¦ç»†æè¿°çš„ç›¸å…³çš„sessionsä¸€å…±æœ‰ä¸‰ä¸ª[crash][crash]ï¼Œè¶³ä»¥è¯æ˜ @TextKit çš„é‡è¦æ€§[cry][cry]ã€‚https://developer.apple.com/wwdc/videos/2013"</span><span class="p">;</span>
<span class="p">[</span><span class="n">parser</span> <span class="nf">highlightKeywords</span><span class="p">:@[</span><span class="s">@"å¢å¼º"</span><span class="p">,</span><span class="s">@"è§†åŠ›æˆ–å¬åŠ›éšœç¢"</span><span class="p">]];</span>


<span class="p">[</span><span class="n">parser</span> <span class="nf">preRenderText</span><span class="p">:</span><span class="n">CGSizeMake</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">)];</span>

<span class="n">_label</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ETUIAttributeLabel</span> <span class="nf">alloc</span><span class="p">]</span><span class="nf">initWithFrame</span><span class="p">:</span><span class="n">CGRectZero</span><span class="p">];</span>
<span class="n">_label</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">clearColor</span><span class="p">];</span>
<span class="n">_label</span><span class="p">.</span><span class="n">attributedString</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">attributedString</span><span class="p">;</span>
<span class="n">_label</span><span class="p">.</span><span class="n">highLightedKeywords</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">highLightedKeywords</span><span class="p">;</span>
<span class="n">_label</span><span class="p">.</span><span class="n">attributedImages</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">attributeImages</span><span class="p">;</span>
<span class="n">_label</span><span class="p">.</span><span class="n">usePreRenderedImage</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
<span class="n">_label</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="n">_label</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">contents</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">parser</span><span class="p">.</span><span class="n">preRenderedImage</span><span class="p">.</span><span class="n">CGImage</span><span class="p">;</span>

<span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">_label</span><span class="p">];</span>
</code></pre></div></div>

<p>å‡å¦‚æˆ‘ä»¬ä¸€æ¬¡è¯·æ±‚æœåŠ¡å™¨è·å¾—äº†10æ¡æ•°æ®ï¼Œé‚£ä¹ˆåœ¨<code class="highlighter-rouge">tableview</code>åˆ·æ–°å‰ï¼Œæˆ‘ä»¬ä½¿ç”¨<code class="highlighter-rouge">parser</code>å°†æ¯æ¡æ•°æ®çš„textæ¸²æŸ“æˆå›¾ç‰‡ï¼Œæ¸²æŸ“å®Œæˆåï¼Œé€šçŸ¥<code class="highlighter-rouge">tableview</code>åˆ·æ–°ï¼Œç„¶ååœ¨<code class="highlighter-rouge">cell</code>ç»˜åˆ¶çš„æ—¶å€™ä¸º<code class="highlighter-rouge">label</code>çš„<code class="highlighter-rouge">layer.content</code>èµ‹å€¼ã€‚</p>

<h3 id="asynchronous-drawing">Asynchronous Drawing</h3>

<p>ä»åˆšæ‰è®¨è®ºçš„ç¬¬ä¸€ç‚¹æˆ‘ä»¬èƒ½çŸ¥é“åœ¨retinaå±å¹•ä¸Šï¼Œä½¿ç”¨Core Graphicç»˜åˆ¶è®©äººå¾ˆå¤±æœ›</p>

<p>ä»åˆšæ‰è®¨è®ºçš„ç¬¬äºŒç‚¹æˆ‘ä»¬èƒ½çŸ¥é“ç»˜åˆ¶UIViewæœ€å¿«çš„æ–¹æ³•å°±æ˜¯æŠŠå®ƒå½“æˆimageviewï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">layer</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">image</span><span class="p">.</span><span class="n">cgImage</span><span class="p">;</span>
</code></pre></div></div>

<p>å¦‚æœæˆ‘ä»¬æŠŠç¬¬ä¸€ç‚¹å’Œç¬¬äºŒç‚¹ç»“åˆèµ·æ¥ï¼Œæˆ‘ä»¬æŠŠéœ€è¦ç”¨Core Graphicç»˜åˆ¶çš„ä»£ç æ”¾åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ä¸­å»ç»˜åˆ¶ï¼Œç”Ÿæˆimageåç›´æ¥èµ‹å€¼ç»™viewã€‚å³ä¸€ç§å¼‚æ­¥ç»˜åˆ¶çš„æŠ€æœ¯ï¼Œæˆ‘çš„æ¡†æ¶ä¸­ï¼ŒETAsyncDrawingCacheä¸“é—¨ä¸ºæ­¤è€Œè®¾è®¡ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªæ–¹æ³•ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">drawViewAsyncWithCacheKey</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">cacheKey</span>
                             <span class="nf">size</span><span class="p">:(</span><span class="n">CGSize</span><span class="p">)</span><span class="nv">imageSize</span>
                  <span class="nf">backgroundColor</span><span class="p">:(</span><span class="n">UIColor</span> <span class="o">*</span><span class="p">)</span><span class="nv">backgroundColor</span>
                       <span class="nf">targetView</span><span class="p">:(</span><span class="n">UIView</span> <span class="o">*</span><span class="p">)</span><span class="nv">targetView</span>
                  <span class="nf">completionBlock</span><span class="p">:(</span><span class="n">ETAsyncDrawingCompletionBlock</span><span class="p">)</span><span class="nv">completionBlock</span><span class="p">;</span>
</code></pre></div></div>

<p>è¿™ä¸ªæ–¹æ³•å¯ä»¥æŠŠä¸€ä¸ªviewä¸¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ¸²æŸ“ï¼Œç„¶åå¾—åˆ°è¿™ä¸ªviewçš„imageï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">drawViewAsyncWithCacheKey</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">cacheKey</span>
                             <span class="nf">size</span><span class="p">:(</span><span class="n">CGSize</span><span class="p">)</span><span class="nv">imageSize</span>
                  <span class="nf">backgroundColor</span><span class="p">:(</span><span class="n">UIColor</span> <span class="o">*</span><span class="p">)</span><span class="nv">backgroundColor</span>
                       <span class="nf">targetView</span><span class="p">:(</span><span class="n">UIView</span> <span class="o">*</span><span class="p">)</span><span class="nv">targetView</span>
                  <span class="nf">completionBlock</span><span class="p">:(</span><span class="n">ETAsyncDrawingCompletionBlock</span><span class="p">)</span><span class="nv">completionBlock</span>
<span class="p">{</span>
    <span class="n">__block</span> <span class="n">NSString</span><span class="o">*</span> <span class="n">_cacheKey</span> <span class="o">=</span> <span class="n">cacheKey</span><span class="p">;</span>
    <span class="n">UIImage</span> <span class="o">*</span><span class="n">cachedImage</span> <span class="o">=</span> <span class="p">[</span><span class="n">_memCache</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="n">cacheKey</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">cachedImage</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">completionBlock</span><span class="p">(</span><span class="n">cachedImage</span><span class="p">,</span><span class="n">_cacheKey</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">completionBlock</span> <span class="o">=</span> <span class="p">[</span><span class="n">completionBlock</span> <span class="nf">copy</span><span class="p">];</span>
    
    <span class="n">dispatch_block_t</span> <span class="n">loadImageBlock</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">BOOL</span> <span class="n">opaque</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">colorIsOpaque</span><span class="p">:</span><span class="n">backgroundColor</span><span class="p">];</span>
        
        <span class="n">UIImage</span> <span class="o">*</span><span class="n">resultImage</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
        
        <span class="n">UIGraphicsBeginImageContextWithOptions</span><span class="p">(</span><span class="n">imageSize</span><span class="p">,</span> <span class="n">opaque</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">{</span>
            <span class="n">CGContextRef</span> <span class="n">context</span> <span class="o">=</span> <span class="n">UIGraphicsGetCurrentContext</span><span class="p">();</span>
            
            <span class="n">CGRect</span> <span class="n">rectToDraw</span> <span class="o">=</span> <span class="p">(</span><span class="n">CGRect</span><span class="p">){.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">CGPointZero</span><span class="p">,</span> <span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">imageSize</span><span class="p">};</span>
            
            <span class="n">BOOL</span> <span class="n">shouldDrawBackgroundColor</span> <span class="o">=</span> <span class="o">!</span><span class="p">[</span><span class="n">backgroundColor</span> <span class="nf">isEqual</span><span class="p">:[</span><span class="n">UIColor</span> <span class="nf">clearColor</span><span class="p">]];</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">shouldDrawBackgroundColor</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">CGContextSaveGState</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
                <span class="p">{</span>
                    <span class="n">CGContextSetFillColorWithColor</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">backgroundColor</span><span class="p">.</span><span class="n">CGColor</span><span class="p">);</span>
                    <span class="n">CGContextFillRect</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">rectToDraw</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">CGContextRestoreGState</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
            <span class="p">}</span>
            
            <span class="p">[</span><span class="n">targetView</span><span class="p">.</span><span class="n">layer</span> <span class="nf">renderInContext</span><span class="p">:</span><span class="n">context</span><span class="p">];</span>
            
            <span class="n">resultImage</span> <span class="o">=</span> <span class="n">UIGraphicsGetImageFromCurrentImageContext</span><span class="p">();</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">resultImage</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">[</span><span class="n">_memCache</span> <span class="nf">setObject</span><span class="p">:</span><span class="n">resultImage</span> <span class="nf">forKey</span><span class="p">:</span><span class="n">cacheKey</span><span class="p">];</span>
            <span class="p">}</span>
            
        <span class="p">}</span>
        <span class="n">UIGraphicsEndImageContext</span><span class="p">();</span>
        
        <span class="c1">//notify</span>
        <span class="p">[[</span><span class="n">ETThread</span> <span class="nf">sharedInstance</span><span class="p">]</span> <span class="nf">enqueueOnMainThread</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
            <span class="n">completionBlock</span><span class="p">(</span><span class="n">resultImage</span><span class="p">,</span><span class="n">_cacheKey</span><span class="p">);</span>
        <span class="p">}];</span>
        
    <span class="p">};</span>
    
    <span class="c1">//background drawing</span>
    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">_backgroundQueue</span><span class="p">,</span> <span class="n">loadImageBlock</span><span class="p">);</span>
    
<span class="p">}</span>
</code></pre></div></div>

<p>é€šè¿‡è¿™ç§ç»˜åˆ¶æ–¹å¼æ¥ç»˜åˆ¶UITableViewCellï¼Œéå¸¸æµç•…ï¼Œä½†æ˜¯ä¹Ÿæœ‰å®ƒçš„é—®é¢˜ï¼š</p>

<p>ï¼ˆ1ï¼‰æ¶ˆè€—æ›´å¤šçš„å†…å­˜</p>

<p>ï¼ˆ2ï¼‰viewçš„ç‚¹å‡»äº‹ä»¶éœ€è¦è‡ªå·±å¤„ç†</p>

<blockquote>
  <p>2014å¹´3æœˆ14æ—¥ æ³¨ï¼š<code class="highlighter-rouge">CALayer</code>çš„<code class="highlighter-rouge">renderInContext:</code>æ–¹æ³•å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä¸å»ºè®®ä½¿ç”¨</p>
</blockquote>

<p class="md-p-center md-margin-top-24">ï¼ˆå…¨æ–‡å®Œï¼‰</p>
:ET