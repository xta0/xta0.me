I"±d<h2 id="cookies">Cookies</h2>

<p>a small piece of data stored in the browser for a website, key-value paires, 20 Cookies per website</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Browser                 Server
    |   --- login ---&gt;    |
    |                     |
    |    {uid = 1234}     |
    |   &lt;--- Cookie ---   |
    |                     |
    |    {uid = 1234}     |
    |   --- Cookie ---&gt;   |
    |                     |
    |   &lt;--- User Data--- |
    |                     |
</code></pre></div></div>
<p>Cookies are sent in HTTP headers, something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP Response
--------------
set-Cookie: user_id = 12345
set-Cookie: last_seen = Dec 25 1985

HTTP Request
-------------
Cookie: user_id = 12345; last-seen=Dec 25 1985
</code></pre></div></div>

<p>æˆ‘ä»¬å¯ä»¥å®é™…æŸ¥çœ‹ä¸€ä¸‹Serverè¿”å›çš„Cookie</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>âœ  curl -I www.google.com
HTTP/1.1 200 OK
Date: Mon, 06 Aug 2018 02:08:03 GMT
Expires: -1
Cache-Control: private, max-age=0
Content-Type: text/html; charset=ISO-8859-1
P3P: CP="This is not a P3P policy! See g.co/p3phelp for more info."
Server: gws
X-XSS-Protection: 1; mode=block
X-Frame-Options: SAMEORIGIN
Set-Cookie: 1P_JAR=2018-08-06-02; expires=Wed, 05-Sep-2018 02:08:03 GMT; path=/; domain=.google.com
Set-Cookie: NID=136=CCO0I2iLHXevLQ9iTtMQcUOKDRmByXVIPRmrnW-6i6b59ZcCDiTASvbns6Dc9C7Sq39qg4wsF3WJ88zwNj2DC27dE2kshTSuE9KSsOsW00Xbhgnyn6ZY4QnJHdCEZNZc; expires=Tue, 05-Feb-2019 02:08:03 GMT; path=/; domain=.google.com; HttpOnly
Transfer-Encoding: chunked
Accept-Ranges: none
Vary: Accept-Encoding
</code></pre></div></div>

<h3 id="hash-cookies">Hash Cookies</h3>

<p>å¸¸ç”¨çš„Hashå‡½æ•°æœ‰ï¼ŒCRC,MD5,Sha1,Sha256ï¼Œå…¶å®‰å…¨æ€§ç”±ä½åˆ°é«˜ï¼ŒHashçš„é€Ÿåº¦ç”±å¿«åˆ°æ…¢ã€‚Pythonæä¾›äº†ä¸€äº›å¸¸ç”¨çš„Hash API</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="n">key</span> <span class="o">=</span> <span class="s">"udacity"</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">x</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="c1">#
</span></code></pre></div></div>
<p>å¯ä»¥ä½¿ç”¨Hashæ¥æ ¡éªŒCookieï¼Œå‡è®¾Cookieçš„æ ¼å¼ä¸º<code class="highlighter-rouge">{visits | hashcode}</code>å…¶ä¸­visitsè¡¨ç¤ºè®¿é—®Serverçš„æ¬¡æ•°</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Server
#-----------
#set-Cookie: {5|e4da3b7fbbce2345d7772b0674a318d5}
</span>
<span class="c1">#client
#-----------
#Cookie: {5|e4da3b7fbbce2345d7772b0674a318d5}
</span>
<span class="c1"># check Cookie 
</span><span class="k">def</span> <span class="nf">hash_str</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">check_secure_val</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
    <span class="n">val</span><span class="p">,</span> <span class="n">hashstr</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'|'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hashstr</span> <span class="o">==</span> <span class="n">hash_str</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p>ä¸Šè¿°Hash Cookieçš„æ–¹æ³•ä»»ç„¶æœ‰ä¸€ä¸ªç¼ºé™·ï¼Œå°±æ˜¯å¯ä»¥è¢«ä¼ªé€ ï¼Œä¾‹å¦‚å¯ä»¥å°†<code class="highlighter-rouge">{5|e4da3b7fbbce2345d7772b0674a318d5}</code>æ›¿æ¢ä¸º<code class="highlighter-rouge">{123|202cb962ac59075b964b07152d234b70}</code>ï¼Œæ ¡éªŒä»ç„¶æœ‰æ•ˆã€‚</p>

<p>å¯ä»¥å¯¹ä¸Šè¿°æ–¹æ³•åšä¸ªä¿®æ”¹ï¼Œåœ¨è®¡ç®—hashæ—¶ï¼ŒåŠ å…¥ä¸€ä¸ªsecret key</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hash(secret_key,Cookie) = hash_code
</code></pre></div></div>

<p>Pythonçš„hashåº“ä¸­æä¾›HMAC(Hash-based Meesage Authentication Code)çš„APIæ¥åº”å¯¹ä¸Šè¿°åœºæ™¯</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">secret_key</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">])</span>
<span class="n">Cookie</span> <span class="o">=</span> <span class="s">"some_Cookie"</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
<span class="n">hash_code</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">secret_key</span><span class="p">,</span><span class="n">Cookie</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="c1">#f2b280549c1c9edb18d5500d6c01ea51
</span></code></pre></div></div>
<h3 id="ä½¿ç”¨cookie">ä½¿ç”¨Cookie</h3>

<p>ä¸Šé¢ä»‹ç»äº†æœåŠ¡ç«¯å¦‚ä½•ç”ŸæˆCookieï¼Œè¿™ä¸€èŠ‚ä»‹ç»æµè§ˆå™¨å¦‚ä½•ä½¿ç”¨Cookieã€‚RFC6265å®šä¹‰äº†Cookieçš„ä¸€äº›å±æ€§ï¼ŒåŒ…å«<code class="highlighter-rouge">Expires</code>ã€<code class="highlighter-rouge">Max-Age</code>ã€<code class="highlighter-rouge">Domain</code>ã€<code class="highlighter-rouge">Path</code>ã€<code class="highlighter-rouge">Secure</code>ã€<code class="highlighter-rouge">HttpOnly</code>ç­‰ã€‚è¿™äº›å±æ€§å†³å®šæµè§ˆå™¨æ˜¯å¦æ¥å—Serverç«¯ä¼ æ¥çš„Cookie</p>

<p>å¯¹äºæµè§ˆå™¨æ¥è¯´ï¼ŒDomainã€Pathã€Nameä¸‰è€…å”¯ä¸€ç¡®å®šä¸€ä¸ªcookieã€‚åœ¨æµè§ˆå™¨åœ¨ä½¿ç”¨cookieæ—¶ï¼Œä¸åŒºåˆ†Http/Httpså’Œç«¯å£å·ã€‚</p>

<ul>
  <li>Domainæ˜¯å‘ä¸Šé€šé…çš„</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#å†™å…¥ï¼ˆSet-Cookieï¼‰è®¿é—®www.example.com</span>
Set-Cookie: <span class="nv">sid1</span><span class="o">=</span>a<span class="p">;</span> <span class="nv">domain</span><span class="o">=</span>example.com<span class="p">;</span> <span class="nv">path</span><span class="o">=</span>/<span class="p">;</span> <span class="c">#æ¥å—</span>
Set-Cookie: <span class="nv">sid2</span><span class="o">=</span>b<span class="p">;</span> <span class="nv">domain</span><span class="o">=</span>www.example.com<span class="p">;</span> <span class="nv">path</span><span class="o">=</span>/<span class="p">;</span> <span class="c">#æ¥å—</span>
Set-Cookie: <span class="nv">sid3</span><span class="o">=</span>c<span class="p">;</span> <span class="nv">domain</span><span class="o">=</span>pay.example.com<span class="p">;</span> <span class="nv">path</span><span class="o">=</span>/<span class="p">;</span> <span class="c">#æ‹’ç»</span>

<span class="c">#è¯»å–ï¼ˆCookieï¼‰</span>
<span class="c">#è®¿é—®pay.example.com</span>
Cookie: <span class="nv">sid1</span><span class="o">=</span>a
        
<span class="c">#è®¿é—®www.example.com</span>
Cookie: <span class="nv">sid1</span><span class="o">=</span>a<span class="p">;</span> <span class="nv">sid2</span><span class="o">=</span>b<span class="p">;</span>
</code></pre></div></div>
<ul>
  <li>Pathæ˜¯å‘ä¸‹é€šé…çš„</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#å†™å…¥ï¼ˆSet-Cookieï¼‰</span>

Setâ€Cookie: <span class="nv">sid1</span><span class="o">=</span>a<span class="p">;</span> <span class="nv">domain</span><span class="o">=</span>example.com<span class="p">;</span> <span class="nv">path</span><span class="o">=</span>/<span class="p">;</span>
Setâ€Cookie: <span class="nv">sid2</span><span class="o">=</span>b<span class="p">;</span> <span class="nv">domain</span><span class="o">=</span>example.com<span class="p">;</span> <span class="nv">path</span><span class="o">=</span>/test/<span class="p">;</span>

<span class="c">#è¯»å–ï¼ˆCookieï¼‰</span>
<span class="c">#è®¿é—®http://example.com/</span>
Cookie: <span class="nv">sid1</span><span class="o">=</span>a<span class="p">;</span>
    
<span class="c">#è®¿é—®http://example.com/test/</span>
Cookie: <span class="nv">sid1</span><span class="o">=</span>a<span class="p">;</span> <span class="nv">sid2</span><span class="o">=</span>b
</code></pre></div></div>
<p><code class="highlighter-rouge">Expires</code>ã€<code class="highlighter-rouge">Max-Age</code>å¯ä»¥æŒ‡å®šCookieçš„æœ‰æ•ˆæœŸï¼Œä¸æŒ‡å®šæœ‰æ•ˆæœŸæ—¶ï¼ŒCookieé»˜è®¤ä¸ºå½“å‰sessionæœ‰æ•ˆï¼Œå½“å‰sessionæœ‰æ•ˆæŒ‡å…³é—­æµè§ˆå™¨æ—¶Cookieå¤±æ•ˆã€‚</p>

<h3 id="cookieçš„å®‰å…¨é—®é¢˜">Cookieçš„å®‰å…¨é—®é¢˜</h3>

<p>å¦‚ä½•ç›—å–Cookieä¸€ç›´æ˜¯ä¸€ä¸ªçƒ­é—¨ä¸”é‡è¦çš„å®‰å…¨é—®é¢˜ï¼Œå¸¸ç”¨çš„æ”»å‡»æ‰‹æ®µæœ‰ä¸­é—´äººæ‹¦æˆªï¼ŒXSSï¼ŒCSRFç­‰ç­‰ï¼Œå…³äºè¿™éƒ¨åˆ†å†…å®¹å’Œæœ¬æ–‡ä¸»é¢˜æ— å…³ï¼Œæˆ‘ä»¬å°†åœ¨åé¢ä¸€ç¯‡æ–‡ç« ä¸­é‡ç‚¹è®¨è®ºWeb Securityçš„é—®é¢˜ã€‚</p>

<h2 id="oauth-è®¤è¯">OAuth è®¤è¯</h2>

<p>æœ‰äº†å‰é¢Cookieçš„é“ºå«ï¼Œæˆ‘ä»¬å¯ä»¥è°ˆä¸€è°ˆç›®å‰æ¯”è¾ƒæµè¡Œçš„OAuthè®¤è¯ã€‚æ‰€è°“OAuthæ˜¯æŒ‡ä½¿ç”¨ç¬¬ä¸‰æ–¹å¹³å°è´¦å·è¿›è¡Œè®¤è¯ï¼Œå…¶è®¤è¯æµç¨‹å›¾ï¼ˆä»¥Googleä¸ºä¾‹ï¼‰å¦‚ä¸‹</p>

<p><a href="/assets/images/2008/07/oauth2-passport.png" data-lightbox="1"><img src="/assets/images/2008/07/oauth2-passport.png" /></a></p>

<p>ä¸Šé¢çš„è®¤è¯è¿‡ç¨‹åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ä»Googleè·å–ç™»å½•ä¿¡æ¯ï¼Œä¸€éƒ¨åˆ†æ˜¯å°†å¾—åˆ°çš„ç™»å½•ä¿¡æ¯è¿›è¡Œå¤„ç†ï¼Œç”ŸæˆCookieï¼Œå­˜åˆ°è‡ªå·±çš„Serverä¸Šã€‚ç¬¬ä¸€éƒ¨åˆ†çš„ä»»åŠ¡æµç¨‹ç›¸å¯¹æ ‡å‡†åŒ–ï¼ŒåŸºæœ¬ä¸Šæ¯ä¸ªå¹³å°éƒ½æœ‰ç›¸åº”çš„ä¸‰æ–¹åº“æ”¯æŒï¼Œæ¯”å¦‚Node.jså¯ä»¥ä½¿ç”¨<code class="highlighter-rouge">Passport</code>(å›¾ä¸­è™šçº¿éƒ¨åˆ†)</p>

<p><code class="highlighter-rouge">Passport</code>ç”±ä¸¤éƒ¨åˆ†æ„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯<code class="highlighter-rouge">Passport</code>æ ¸å¿ƒåº“ï¼Œç”¨æ¥å¤„ç†ç™»å½•é€»è¾‘ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯<code class="highlighter-rouge">passpoart strategy</code>ç”¨æ¥æ”¯æŒå„ç±»ç™»å½•ç­–ç•¥ï¼Œæ¯”å¦‚JWTï¼ŒOAuthç­‰ç­‰ã€‚ä¸Šè¿°ä¸¤ä¸ªframeworkåˆ†åˆ«ä¸º</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install</span> <span class="nt">--save</span> Passport Passport-google-oauth20
</code></pre></div></div>

<h3 id="config-passport">Config Passport</h3>

<p>æˆ‘ä»¬ä»¥Googleçš„OAuthè®¤è¯ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨Passportå®ŒæˆOAuthæµç¨‹ã€‚é¦–å…ˆéœ€è¦å¯¹<code class="highlighter-rouge">Passport</code>è¿›è¡Œåˆå§‹åŒ–ï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span>
  <span class="k">new</span> <span class="nx">GoogleStrategy</span><span class="p">(</span>
    <span class="p">{</span>
      <span class="na">clientID</span><span class="p">:</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">googleClientID</span><span class="p">,</span>
      <span class="na">clientSecret</span><span class="p">:</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">googleClientSecret</span><span class="p">,</span>
      <span class="na">callbackURL</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/auth/google/callback</span><span class="dl">'</span>
    <span class="p">},</span>
    <span class="nx">accessToken</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>
<p>ä¸Šè¿°ä»£ç åˆå§‹åŒ–<code class="highlighter-rouge">Passport</code>ï¼Œä¼ å…¥<code class="highlighter-rouge">client_id</code>å’Œ<code class="highlighter-rouge">secret</code>ä»¥åŠ<code class="highlighter-rouge">callbackURL</code>ï¼Œæ³¨æ„<code class="highlighter-rouge">callbackURL</code>éœ€è¦åœ¨Google Accountä¸­é¢„å…ˆé…ç½®å¥½ï¼Œå½“OAuthè¯·æ±‚æˆåŠŸåï¼ŒGoogleä¼šä½¿ç”¨è¿™ä¸ªURLè¿”å›tokenã€‚æ¥ä¸‹æ¥ï¼Œåœ¨Serverä¸Šé…ç½®OAuthç™»å½•API:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span>
  <span class="dl">'</span><span class="s1">/auth/google</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">google</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">scope</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">profile</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">email</span><span class="dl">'</span><span class="p">]</span> <span class="c1">//å…è®¸è®¿é—®ç”¨æˆ·çš„profileå’Œemailä¿¡æ¯</span>
  <span class="p">})</span>
<span class="p">);</span>
</code></pre></div></div>
<p>æ­¤æ—¶ï¼Œå½“æˆ‘ä»¬è®¿é—®<code class="highlighter-rouge">/auth/google</code>æ—¶ï¼Œ<code class="highlighter-rouge">Passport</code>ä¼šå°†ä¸Šè¿°GETè¯·æ±‚çš„URLæ›¿æ¢ä¸ºï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://accounts.google.com/o/oauth2/v2/auth?response_type=code
&amp;redirect_uri=http%3A%2F%2F127.0.0.1%3A5000%2Fauth%2Fgoogle%2Fcallback
&amp;scope=profile%20email
&amp;client_id=999661698345-ivms5t1s778qp5n4k55sep4odp7t4her.apps.googleusercontent.com
</code></pre></div></div>
<p>å½“è¯·æ±‚OAuthè¯·æ±‚æˆåŠŸåï¼ŒGoogleä¼šè°ƒç”¨callback URLï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¤„ç†è¯¥è¯·æ±‚çš„å›è°ƒ(<code class="highlighter-rouge">Passport</code>å†…éƒ¨ä¼šé€šè¿‡URLä¸­æ˜¯å¦å­˜åœ¨<code class="highlighter-rouge">code</code>å­—æ®µæ¥åŒºåˆ†è¯¥è¯·æ±‚æ˜¯å¦æ˜¯callbackè¯·æ±‚ï¼‰</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//callback API</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/google/callback</span><span class="dl">'</span><span class="p">,</span> <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">google</span><span class="dl">'</span><span class="p">));</span>
</code></pre></div></div>

<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å†è®¿é—®<code class="highlighter-rouge">/auth/google</code>ï¼Œé€‰æ‹©ä¸€ä¸ªè´¦å·ç™»å½•ï¼ŒGoogleä¼šé€šè¿‡callback URLè¿”å›ç™»å½•ä¿¡æ¯å’Œç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·ä¿¡æ¯ä¸­é‡è¦çš„æ˜¯ç”¨æˆ·<code class="highlighter-rouge">id</code>ï¼Œæˆ‘ä»¬åé¢ä¼šç”¨è¿™ä¸ª<code class="highlighter-rouge">id</code>æ¥ç”ŸæˆCookie</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//token</span>
<span class="nx">ya29</span><span class="p">.</span><span class="nx">GlsgBiHIcv4rAhcYaxNkAn7nJadfm1oNQpCbnz1FO3QczeEke9zdWGc0ZExklr0b6WSJVQEuv_x6oe_cH5YAYrj9cNXeLWLjo3ATvZ_0pM0agI4_ju8</span><span class="o">-</span><span class="nx">KxhUxIkhG</span>

<span class="c1">//user profile</span>
<span class="p">{</span> <span class="nl">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1128784079818168156265</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">displayName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">JOHN DOE</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">name</span><span class="p">:</span> <span class="p">{</span> <span class="nl">familyName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">DOE</span><span class="dl">'</span><span class="p">,</span> <span class="nx">givenName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">JOHN</span><span class="dl">'</span> <span class="p">},</span>
  <span class="nx">emails</span><span class="p">:</span> <span class="p">[</span> <span class="p">{</span> <span class="na">value</span><span class="p">:</span> <span class="dl">'</span><span class="s1">johndoe@gmail.com</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">account</span><span class="dl">'</span> <span class="p">}</span> <span class="p">],</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="cookie-management-in-passportjs">Cookie Management in passport.js</h3>

<p>é€šè¿‡OAuthæ‹¿åˆ°ç™»å½•ä¿¡æ¯å’Œç”¨æˆ·ä¿¡æ¯ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸ºç”¨æˆ·ç”ŸæˆCookieï¼Œè¿™ä¸ªè¿‡ç¨‹åŒæ ·ä¹Ÿæ˜¯è¢«<code class="highlighter-rouge">Passport</code>åœ¨å†…éƒ¨å°è£…äº†ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ä»£ç ä¸­åšä¸€äº›ç®€å•çš„é…ç½®å³å¯ã€‚é¦–å…ˆåˆå§‹åŒ–<code class="highlighter-rouge">Passport</code>ä¸­é—´ä»¶ï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Cookie</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span>
  <span class="nx">CookieSession</span><span class="p">({</span> <span class="c1">//CookieSesssion</span>
    <span class="na">maxAge</span><span class="p">:</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="na">keys</span><span class="p">:</span> <span class="p">[</span><span class="nx">keys</span><span class="p">.</span><span class="nx">CookieKey</span><span class="p">]</span>
  <span class="p">})</span>
<span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">initialize</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">session</span><span class="p">());</span>
</code></pre></div></div>
<p><code class="highlighter-rouge">CookieSession</code>æ˜¯ä¸€ä¸ªç”¨æ¥ä»ç”Ÿæˆä»¥åŠè§£æCookieçš„ä¸‰æ–¹åº“ï¼Œå‚è€ƒå‰é¢ä¸€èŠ‚å¯¹Cookieçš„ä»‹ç»å¯çŸ¥æˆ‘ä»¬éœ€è¦åœ¨Serverä¸Šæ”¾ä¸€ä¸ªç§é’¥åŒæ¥å¯¹Cookieè¿›è¡Œéå¯¹ç§°åŠ å¯†è§£å¯†ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œå½“OAuthè¯·æ±‚æˆåŠŸåï¼Œ<code class="highlighter-rouge">Passport</code>ä¼šè°ƒç”¨ä¹‹å‰æ³¨å†Œçš„å›è°ƒå‡½æ•°</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span> <span class="nx">refreshToken</span><span class="p">,</span> <span class="nx">profile</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">googleId</span> <span class="o">=</span> <span class="nx">profile</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="c1">//Get user from mongoDB</span>
    <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">googleId</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">new</span> <span class="nx">User</span><span class="p">({</span> <span class="nx">googleId</span> <span class="p">}).</span><span class="nx">save</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span> <span class="c1">//if found user, save it</span>
    <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>
<p>åœ¨å›è°ƒå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä»DBæŸ¥è¯¢userå¹¶å°†å¾—åˆ°çš„ç»“æœä¼šä¼ ç»™<code class="highlighter-rouge">Passport</code>ï¼Œè¿™ä¸€æ­¥å¾ˆå…³é”®ï¼Œ<code class="highlighter-rouge">Passport</code>ä¼šä½¿ç”¨<code class="highlighter-rouge">user</code>ä¸­çš„å†…å®¹æ¥ç”ŸæˆCookieå¹¶è¿”å›ç»™Browserã€‚</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">passport</span><span class="p">.</span><span class="nx">serializeUser</span><span class="p">((</span><span class="nx">user</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> 
  <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span> <span class="c1">//{Cookie, user.id}</span>
<span class="p">});</span>
</code></pre></div></div>
<p>ä¸Šé¢ä»£ç ä¸­æŒ‡å®š<code class="highlighter-rouge">user.id</code>çš„æ„ä¹‰åœ¨äºå‘Šè¯‰<code class="highlighter-rouge">passport</code>ï¼Œåœ¨åæ»¡çš„é€šä¿¡ä¸­ä½¿ç”¨<code class="highlighter-rouge">user.id</code>ä½œä¸ºé€šä¿¡çš„sessionã€‚åé¢çš„å†…å®¹è¿˜ä¼šæåˆ°è¿™ä¸ªsessionçš„ä½œç”¨ã€‚</p>

<p>è‡³æ­¤ï¼ŒOAuthè®¤è¯çš„å®Œæ•´æµç¨‹å°±èµ°å®Œäº†ã€‚æ¥ä¸‹æ¥ï¼Œå½“ç”¨æˆ·çš„Browserå·²ç»å­˜æœ‰å½“å‰Serverçš„Cookieæ—¶ï¼Œå¦‚æœè¯¥ç”¨æˆ·å†æ¬¡è®¿é—®ï¼Œå°†èµ°ä¸‹é¢çš„æµç¨‹ï¼š</p>

<p><img src="/assets/images/2011/07/cookie-1.png" /></p>

<p>æ­¤æ—¶å½“Serveræ”¶åˆ°è¯·æ±‚åï¼Œ<code class="highlighter-rouge">CookieSession</code>ä¼šå…ˆè§£æå‡ºRequest Headerä¸­çš„Cookieï¼Œç„¶å<code class="highlighter-rouge">Passport</code>ä¼šæ ¹æ®è§£æå¾—åˆ°çš„Cookieæ‰¾åˆ°å¯¹ç›¸åº”çš„userï¼Œç„¶åå°†<code class="highlighter-rouge">user</code>ç»‘å®šåˆ°<code class="highlighter-rouge">req.user</code>ï¼Œå°†<code class="highlighter-rouge">user.id</code>ç»‘å®šåˆ°<code class="highlighter-rouge">req.session</code>ä¸Šã€‚</p>

<p>è™½ç„¶æ•´ä¸ªè¿‡ç¨‹é€»è¾‘ä¸Šè¯´çš„é€šï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªç–‘é—®ï¼Œå°±æ˜¯<code class="highlighter-rouge">Passport</code>å¦‚ä½•æ ¹æ®Cookieæ‰¾åˆ°å¯¹åº”çš„<code class="highlighter-rouge">user</code>çš„ã€‚èƒ½æƒ³åˆ°çš„æ˜¯ï¼Œä¸€ç§åšæ³•æ˜¯å°†Cookieå­˜èµ·æ¥ï¼Œå…¶ä¸­keyä¸ºCookieçš„å€¼ï¼Œvalueä¸º<code class="highlighter-rouge">user.id</code>ã€‚å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶ï¼Œé¦–å…ˆæ ¹æ®Cookieæ‰¾åˆ°<code class="highlighter-rouge">user.id</code>ï¼Œå†æ ¹æ®<code class="highlighter-rouge">user.id</code>å»è·å–<code class="highlighter-rouge">user</code>å…¶å®ƒä¿¡æ¯ã€‚ä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡å‘Šè¯‰<code class="highlighter-rouge">Passport</code>åœ¨å“ªé‡Œå­˜Cookieï¼Œæ˜¾ç„¶ä¸Šè¿°è¿‡ç¨‹ä½¿ç”¨çš„ä¸æ˜¯è¿™ç§æ–¹å¼ã€‚</p>

<p>å¦ä¸€ç§æ–¹å¼åˆ™æ˜¯ä¸å­˜æ”¾Cookie, è€Œæ˜¯å°†ç”¨æˆ·ä¿¡æ¯<code class="highlighter-rouge">user</code>é€šè¿‡æŸç§æ–¹å¼encodeåˆ°Cookieä¸­ï¼Œæˆä¸ºCookieçš„ä¸€éƒ¨åˆ†ã€‚å½“ç”¨æˆ·å¸¦ç€Cookieè®¿é—®æ—¶ï¼Œä»Cookieä¸­decodeå‡ºæ¥ï¼Œæ˜¾ç„¶ä¸Šé¢çš„è¿‡ç¨‹ä½¿ç”¨çš„æ˜¯è¿™ç§æ–¹å¼ã€‚</p>

<blockquote>
  <p>åœ¨Node.jsä¸­ç¬¬ä¸€ç§æ–¹å¼å¯¹åº”express-sessionåº“, ç¬¬äºŒç§æ–¹å¼å¯¹åº”cookie-sessionåº“</p>
</blockquote>

<p>ä¸Šè¿°ä¸¤ç§æ–¹å¼å„æœ‰ä¼˜åŠ£ï¼Œé€‰ç”¨é‚£ç§æ–¹å¼è¦çœ‹å®é™…åº”ç”¨åœºæ™¯ï¼Œå¦‚æœæ˜¯å¤§è§„æ¨¡çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç”¨æˆ·æ•°æ®å¾ˆåºå¤§ï¼Œå»ºè®®ä½¿ç”¨ç¬¬ä¸€ç§æ–¹å¼ï¼›å¦‚æœæ˜¯è½»é‡çº§çš„å°åº”ç”¨ï¼Œ<code class="highlighter-rouge">user</code>ä¿¡æ¯ä¸å¤æ‚ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ç¬¬äºŒç§æ–¹å¼ã€‚</p>

<h2 id="resource">Resource</h2>

<ul>
  <li><a href="">Intro to backend</a></li>
</ul>
:ET