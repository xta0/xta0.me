I"şp<h3 id="armåŸºç¡€">ARMåŸºç¡€</h3>

<ul>
  <li>å¯„å­˜å™¨åŠŸèƒ½ï¼š
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>r0 - r3 ï¼šå­˜æ”¾å‡½æ•°çš„ä¼ å‚
r4 - r11 ï¼šå­˜æ”¾å±€éƒ¨å˜é‡
r7  : FP : frame pointerã€‚é€šå¸¸ç”¨æ¥ä¿å­˜ä¹‹å‰çš„spå’Œlr 
r12 : é€šç”¨å¯„å­˜å™¨
r13 : SP : stack pointer ï¼Œæ ˆåº•æŒ‡é’ˆï¼Œå¾ˆé‡è¦
r14 ï¼š LR : link register ï¼Œä¿å­˜ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€
r15 ï¼š PC : program counterï¼Œå­˜æ”¾å½“å‰æŒ‡ä»¤çš„åœ°å€ï¼Œå½“æŒ‡ä»¤æ‰§è¡Œå®Œåï¼Œä¼šè‡ªå¢åŠ 
</code></pre></div>    </div>
  </li>
  <li>å¸¸ç”¨çš„æ±‡ç¼–æŒ‡ä»¤ï¼š
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mov r0, r1   =&gt; r0 = r1
mov r0, #10  =&gt; r0 = 10
ldr r0, [sp] =&gt; r0 = *sp
str r0, [sp] =&gt; *sp = r0
add r0, r1, r2 =&gt;r0 = r1 + r2
add r0, r1     =&gt; r0 = r0 + r1
push {r0, r1, r2} =&gt; Push r0, r1 and r2 onto the stack.
pop {r0, r1, r2}  =&gt; Pop three values off the stack, putting them into r0, r1 and r2.
b _label =&gt;pc = _label
bl _label =&gt;lr = pc + 4; pc = _label
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="æ ˆå¸§-stackframe">æ ˆå¸§ StackFrame</h3>

<p>å‡½æ•°è°ƒç”¨æ˜¯åŸºäºstackçš„ï¼Œstackæ˜¯ä»é«˜åˆ°ä½ç”Ÿé•¿çš„ï¼Œå‡å¦‚å‡½æ•°Aå†…éƒ¨è¦è°ƒç”¨Bï¼Œé¦–å…ˆè¦å°†Açš„spå­˜èµ·æ¥ï¼Œç„¶ååœ¨stackä¸Šå¼€è¾Ÿä¸€å—æ§ä»¶ï¼Œæ‰§è¡ŒBï¼Œæ‰§è¡Œä¸‡ååœ¨å°†spå–å‡ºæ¥ç»§ç»­æ‰§è¡Œã€‚æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š</p>

<p><img class="md-img-center" src="/assets/images/2012/11/stack.png" /></p>

<p><strong>parameter areaï¼š</strong>å­˜æ”¾äº†Bï¼ˆcalleeï¼‰å‡½æ•°éœ€è¦çš„å‚æ•°ï¼Œè¿™ä¸€å—ç©ºé—´éœ€è¦ç”±Aæ¥åˆ†é…(caller),è¿™ä¸ªè¿‡ç¨‹å«åšPrologsï¼š</p>

<p>(1)å°†LR,R7å…¥æ ˆ
(2)å°†SPèµ‹ç»™R7
(3)ä¿å­˜å½“å‰å¯„å­˜å™¨çš„å€¼
(4)åˆ†é…ç©ºé—´ç»™Bå‡½æ•°
<strong>linkage area ï¼š</strong> å­˜æ”¾äº†Aåœ¨è°ƒç”¨å®ŒBåä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€
<strong>saved frame pointer ï¼š</strong>å­˜æ”¾äº†Aè°ƒç”¨Bå‰çš„SPåœ°å€
<strong>local storage areaï¼š</strong>å­˜æ”¾å‡½æ•°Béœ€è¦çš„å‚æ•°</p>

<h3 id="assemblyæŒ‡ä»¤åˆ†æ">AssemblyæŒ‡ä»¤åˆ†æ</h3>

<p>æŸ¥çœ‹ä¸‹é¢ä»£ç </p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span><span class="kt">int</span> <span class="nf">addFunction</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fooFunction</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">add</span> <span class="o">=</span> <span class="n">addFunction</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"add = %i"</span><span class="p">,</span> <span class="n">add</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>fooFunctionä¸­è°ƒç”¨äº†addFunctionï¼Œæˆ‘ä»¬æŒ‰ç…§å‰é¢è®¨è®ºçš„æ­¥éª¤å…ˆæ¥çœ‹fooFunctionçš„æ±‡ç¼–ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="p">.</span><span class="n">globl</span>	<span class="n">_fooFunction</span>
	<span class="p">.</span><span class="n">align</span>	<span class="mi">2</span>
	<span class="p">.</span><span class="n">code</span>	<span class="mi">16</span>                      <span class="err">@</span> <span class="err">@</span><span class="n">fooFunction</span>
	<span class="p">.</span><span class="n">thumb_func</span>	<span class="n">_fooFunction</span>
<span class="n">_fooFunction</span><span class="o">:</span>
	<span class="p">.</span><span class="n">cfi_startproc</span>
<span class="n">Lfunc_begin1</span><span class="o">:</span>
	<span class="p">.</span><span class="n">loc</span>	<span class="mi">1</span> <span class="mi">19</span> <span class="mi">0</span>                
<span class="err">@</span> <span class="n">BB</span><span class="err">#</span><span class="mi">0</span><span class="o">:</span>
	<span class="n">push</span>	<span class="p">{</span><span class="n">r7</span><span class="p">,</span> <span class="n">lr</span><span class="p">}</span>
	<span class="n">mov</span>	<span class="n">r7</span><span class="p">,</span> <span class="n">sp</span>
	<span class="n">sub</span>	<span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">12</span>
	<span class="n">movs</span>	<span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">50</span>
	<span class="n">movt</span>	<span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
	<span class="n">movs</span>	<span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mi">51</span>
	<span class="n">movt</span>	<span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
	<span class="p">.</span><span class="n">loc</span>	<span class="mi">1</span> <span class="mi">20</span> <span class="mi">0</span> <span class="n">prologue_end</span>    
<span class="n">Ltmp2</span><span class="o">:</span>
	<span class="n">bl</span>	<span class="n">_addFunction</span>
	<span class="n">movw</span>	<span class="n">r1</span><span class="p">,</span> <span class="o">:</span><span class="n">lower16</span><span class="o">:</span><span class="p">(</span><span class="n">L_</span><span class="p">.</span><span class="n">str</span><span class="o">-</span><span class="p">(</span><span class="n">LPC1_0</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span>
	<span class="n">movt</span>	<span class="n">r1</span><span class="p">,</span> <span class="o">:</span><span class="n">upper16</span><span class="o">:</span><span class="p">(</span><span class="n">L_</span><span class="p">.</span><span class="n">str</span><span class="o">-</span><span class="p">(</span><span class="n">LPC1_0</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span>
<span class="n">LPC1_0</span><span class="o">:</span>
	<span class="n">add</span>	<span class="n">r1</span><span class="p">,</span> <span class="n">pc</span>
	<span class="n">str</span>	<span class="n">r0</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">8</span><span class="p">]</span>
	<span class="p">.</span><span class="n">loc</span>	<span class="mi">1</span> <span class="mi">21</span> <span class="mi">0</span>                  
	<span class="n">ldr</span>	<span class="n">r0</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">8</span><span class="p">]</span>
	<span class="n">str</span>	<span class="n">r0</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span><span class="p">]</span>            <span class="err">@</span> <span class="mi">4</span><span class="o">-</span><span class="n">byte</span> <span class="n">Spill</span>
	<span class="n">mov</span>	<span class="n">r0</span><span class="p">,</span> <span class="n">r1</span>
	<span class="n">ldr</span>	<span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span><span class="p">]</span>            <span class="err">@</span> <span class="mi">4</span><span class="o">-</span><span class="n">byte</span> <span class="n">Reload</span>
	<span class="n">bl</span>	<span class="n">_printf</span>
	<span class="p">.</span><span class="n">loc</span>	<span class="mi">1</span> <span class="mi">22</span> <span class="mi">0</span>                 
	<span class="n">str</span>	<span class="n">r0</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span>                <span class="err">@</span> <span class="mi">4</span><span class="o">-</span><span class="n">byte</span> <span class="n">Spill</span>
	<span class="n">add</span>	<span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">12</span>
	<span class="n">pop</span>	<span class="p">{</span><span class="n">r7</span><span class="p">,</span> <span class="n">pc</span><span class="p">}</span>
<span class="n">Ltmp3</span><span class="o">:</span>
<span class="n">Lfunc_end1</span><span class="o">:</span>
	<span class="p">.</span><span class="n">cfi_endproc</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å…ˆæ¥çœ‹å¤´ä¿¡æ¯ï¼Œæ‰€è°“çš„å¤´ä¿¡æ¯ä¹Ÿå«<a href="http://www.sourceware.org/binutils/docs-2.12/as.info/ARM-Directives.html">ARM Machine Directives</a>ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="n">globl</span>	<span class="n">_fooFunction</span>
	<span class="p">.</span><span class="n">align</span>	<span class="mi">2</span>
	<span class="p">.</span><span class="n">code</span>	<span class="mi">16</span>                      <span class="err">@</span> <span class="err">@</span><span class="n">fooFunction</span>
	<span class="p">.</span><span class="n">thumb_func</span>	<span class="n">_fooFunction</span>
<span class="n">_fooFunction</span><span class="o">:</span>
	<span class="p">.</span><span class="n">cfi_startproc</span>
</code></pre></div></div>

<ol>
  <li><code class="highlighter-rouge">.globl</code>å£°æ˜çš„ç¬¦å·ä¸ºå¤–éƒ¨ç¬¦å·ï¼Œå¤–éƒ¨ç¬¦å·æ˜¯.cæˆ–.mä¸­å¯è§çš„ç¬¦å·ï¼Œ<code class="highlighter-rouge">_fooFunction</code>ä¸º<code class="highlighter-rouge">fooFunction()</code>æ–¹æ³•ã€‚</li>
  <li><code class="highlighter-rouge">.align 2</code>ä»£è¡¨åé¢çš„ä»£ç ä¼šä»¥2çš„å¹³æ–¹=4å­—èŠ‚å¯¹é½ï¼Œæ²¡æœ‰padding</li>
  <li><code class="highlighter-rouge">.code 16</code>æ„æ€æ˜¯ä¸‹é¢çš„æ±‡ç¼–æŒ‡ä»¤é›†æ˜¯Thumbçš„ä¸æ˜¯ARMçš„ï¼ˆ32ï¼‰ã€‚ç°ä»£çš„ARMå¤„ç†å™¨æœ‰ä¸¤ç§æ¨¡å¼ï¼šARMå’ŒThumbï¼ŒARMæ˜¯32bitå®½ï¼ŒThumbæ˜¯16bitå®½ï¼ŒThumbçš„æŒ‡ä»¤å¾ˆå°‘ï¼Œä½¿ç”¨Thumbæ¨¡å¼ï¼Œé€šå¸¸ä¼šä½¿ä»£ç é‡æ›´å°ï¼Œå’Œæ›´æœ‰æ•ˆçš„CPUç¼“å­˜</li>
  <li>.thumb_func æ„æ€æ˜¯å‘Šè¯‰åé¢çš„_fooFunctionä¸­çš„æŒ‡ä»¤æ˜¯ç”¨Thumbç¼–ç çš„</li>
</ol>

<p>æ¥ä¸‹æ¥å°±æ˜¯_fooFunctionçš„å†…å®¹äº†ï¼Œåœ¨æ±‡ç¼–ä¸­ï¼š</p>

<p>ä»¥å†’å·ä¸ºç»“å°¾çš„è¡Œï¼Œå¦‚<code class="highlighter-rouge">_fooFunction:  ï¼ŒLfunc_begin1:  ï¼ŒLtmp3ï¼šï¼ŒLtmp4ï¼šï¼ŒLfunc_end1</code> ç§°ä¸º<code class="highlighter-rouge">Labels</code>
ç”¨æ¥æ ‡è¯†ä¸€æ®µæ±‡ç¼–ä»£ç çš„åå­—ï¼Œä¸ºæŸæ®µä»£ç çš„å…¥å£åœ°å€ï¼Œä¾‹å¦‚:_fooFunction:æ˜¯å‡½æ•°çš„å…¥å£ä½ç½®ã€‚
ç¨‹åºä¸­å¯ä»¥call è¿™äº›labelï¼Œæ¥æ‰§è¡Œå‡½æ•°ã€‚
ç”¨_å¼€å¤´çš„æ˜¯å‡½æ•°å…¥å£çš„labelï¼Œç”¨Lå¼€å¤´çš„æ˜¯å‡½æ•°ä¸­çš„å†…éƒ¨è·³è½¬ä½ç½®ï¼ŒåŒ…å«åœ¨å‡½æ•°å†…éƒ¨ã€‚
æ³¨é‡Šæ˜¯ä»¥<code class="highlighter-rouge">@</code>å¼€å¤´ã€‚</p>

<p>ä¸€èˆ¬å‡½æ•°å¼€å¤´éƒ½ä¼šä»¥<code class="highlighter-rouge">.cfi_startproc</code>å¼€å§‹ã€‚<code class="highlighter-rouge">cfi</code>æ˜¯<code class="highlighter-rouge">call frame information</code>çš„ç¼©å†™ã€‚</p>

<p>æˆ‘ä»¬ç»§ç»­ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">Lfunc_begin1:</span>
	<span class="p">.</span><span class="n">loc</span>	<span class="mi">1</span> <span class="mi">19</span> <span class="mi">0</span>                
<span class="err">@</span> <span class="n">BB</span><span class="err">#</span><span class="mi">0</span><span class="o">:</span>
	<span class="n">push</span>	<span class="p">{</span><span class="n">r7</span><span class="p">,</span> <span class="n">lr</span><span class="p">}</span>
	<span class="n">mov</span>	<span class="n">r7</span><span class="p">,</span> <span class="n">sp</span>
	<span class="n">sub</span>	<span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">12</span>
	<span class="n">movs</span>	<span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">50</span>
	<span class="n">movt</span>	<span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
	<span class="n">movs</span>	<span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mi">51</span>
	<span class="n">movt</span>	<span class="n">r1</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
	<span class="p">.</span><span class="n">loc</span>	<span class="mi">1</span> <span class="mi">20</span> <span class="mi">0</span> <span class="n">prologue_end</span>    
<span class="n">Ltmp2</span><span class="o">:</span>
	<span class="n">bl</span>	<span class="n">_addFunction</span>
</code></pre></div></div>

<p>è¿™ä¸€æ®µä¹Ÿå¾ˆå¥½ç†è§£ï¼š
è®°å¾—å‰é¢ç¬¬ä¸‰ç‚¹è®¨è®ºçš„å†…å®¹ï¼Œåœ¨_fooFunctionçš„stackä¸­ï¼Œé¦–å…ˆçš„ä¸€æ®µåº”è¯¥æ˜¯<strong>Parameter Area</strong>ã€‚ä¹Ÿå°±æ˜¯çœ¼å‰çš„è¿™ä¸€æ®µï¼Œæ ¹æ®è§„å®šï¼Œè¿™ä¸€æ®µstackéœ€è¦ç”±_fooFunctionåˆ†é…å‡ºæ¥ï¼Œä¿å­˜å®ƒè¦è°ƒç”¨çš„addFunction(50,51)çš„å…¥å‚ï¼Œè¿™ä¸€è¿‡ç¨‹æˆä¸º<strong>prologs</strong>ã€‚</p>

<p>prologsçš„ç¬¬ä¸€æ­¥ä¾¿æ˜¯ï¼šå°†R7å’ŒLRå…¥æ ˆï¼š<strong>push{r7,lr}</strong>ã€‚ç”±äºr7å’Œlréƒ½æ˜¯32bitï¼Œ4byteï¼Œå› æ­¤spä¼šè‡ªåŠ¨å‡å°‘8å­—èŠ‚ï¼Œæ­¤å¥ç›¸å½“äº</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>str  r7,  [sp,     #8]
str  lr , [sp,     #4]
</code></pre></div></div>
<p><strong>mov r7, sp</strong> ï¼šç”±äºä¸Šä¸€æ­¥r7ä¸­çš„å€¼å·²ç»ä¿å­˜åˆ°æ ˆé‡Œäº†ï¼Œå› æ­¤ç°åœ¨å¯ä»¥ç”¨r7æ¥ä¿å­˜å½“å‰spçš„åœ°å€ã€‚
<strong>sub sp, #12</strong>ï¼šä»spå½“å‰åœ°å€ï¼Œå‘ä¸‹å¼€è¾Ÿ12å­—èŠ‚çš„ç©ºé—´ï¼Œå…¶ä¸­å‰8ä¸ªå­—èŠ‚ç”¨æ¥å­˜æ”¾r7å’Œlrçš„å€¼</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>movs	r0, #50
movt	r0, #0
movs	r1, #51
movt	r1, #0
.loc	1 20 0 prologue_end
</code></pre></div></div>

<p>ç„¶åå°†ä¼ å…¥çš„å‚æ•°50ï¼Œ51åˆ†åˆ«æ”¾åˆ°å¯„å­˜å™¨r0,r1ä¸­ï¼šr0ï¼Œr1å‡ä¸º32bitå®½ï¼Œmovtå°†é«˜16bitå¡«å……ä¸º0.
æœ€åæ˜¯prologè¿‡ç¨‹ç»“æŸï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œcallerçš„ä»»åŠ¡å°±å®Œæˆäº†ã€‚
<strong>bl _addFunction</strong>ï¼šblï¼ˆbranch with linkï¼‰ç”¨æ¥æ‰§è¡Œå‡½æ•°è°ƒç”¨ï¼Œå±äºThumbæŒ‡ä»¤é›†ã€‚æ˜¾ç„¶ä¸‹é¢å°±å»è¿›å…¥addFunctionçš„å‡½æ•°æ ˆäº†ã€‚</p>

<p>æˆ‘ä»¬å…ˆä¸ç®¡addFunctionï¼Œå‡è®¾ç°åœ¨addFunctionå·²ç»æ‰§è¡Œå®Œäº†ï¼Œè¿”å›å€¼ä¿å­˜åœ¨äº†r0ä¸­ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">movw</span>	<span class="n">r1</span><span class="p">,</span> <span class="o">:</span><span class="n">lower16</span><span class="o">:</span><span class="p">(</span><span class="n">L_</span><span class="p">.</span><span class="n">str</span><span class="o">-</span><span class="p">(</span><span class="n">LPC1_0</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span>
<span class="n">movt</span>	<span class="n">r1</span><span class="p">,</span> <span class="o">:</span><span class="n">upper16</span><span class="o">:</span><span class="p">(</span><span class="n">L_</span><span class="p">.</span><span class="n">str</span><span class="o">-</span><span class="p">(</span><span class="n">LPC1_0</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span>
<span class="n">LPC1_0</span><span class="o">:</span>
	<span class="n">add</span>	<span class="n">r1</span><span class="p">,</span> <span class="n">pc</span>
	<span class="n">str</span>	<span class="n">r0</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">8</span><span class="p">]</span>
	<span class="p">.</span><span class="n">loc</span>	<span class="mi">1</span> <span class="mi">21</span> <span class="mi">0</span>                  
	<span class="n">ldr</span>	<span class="n">r0</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">8</span><span class="p">]</span>
	<span class="n">str</span>	<span class="n">r0</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span><span class="p">]</span>            <span class="err">@</span> <span class="mi">4</span><span class="o">-</span><span class="n">byte</span> <span class="n">Spill</span>
	<span class="n">mov</span>	<span class="n">r0</span><span class="p">,</span> <span class="n">r1</span>
	<span class="n">ldr</span>	<span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span><span class="p">]</span>            <span class="err">@</span> <span class="mi">4</span><span class="o">-</span><span class="n">byte</span> <span class="n">Reload</span>
        <span class="n">bl</span>	<span class="n">_printf</span>
</code></pre></div></div>

<p>å‰ä¸¤å¥æ˜¯æŠŠâ€add = %iâ€è¿™ä¸ªå­—ç¬¦ä¸²æ”¾åˆ°r1ä¸­ï¼Œå…¶ä¸­L_.strå®šä¹‰åœ¨äº†å¸¸é‡æ®µï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="n">section</span>	<span class="n">__TEXT</span><span class="p">,</span><span class="n">__cstring</span><span class="p">,</span><span class="n">cstring_literals</span>
<span class="n">L_</span><span class="p">.</span><span class="n">str</span><span class="o">:</span>                                 <span class="err">@</span> <span class="err">@</span><span class="p">.</span><span class="n">str</span>
<span class="p">.</span><span class="n">asciz</span>	 <span class="s">"add = %i"</span>
</code></pre></div></div>

<p>ç„¶åå…ˆæŠŠr0ä¸­çš„å€¼ä¿å­˜åˆ°stackä¸Šï¼ˆsp + 4ï¼‰çš„ä½ç½®ï¼Œå†æŠŠr1ä¸­çš„â€add = %iâ€æ”¾åˆ°r0ä¸­ï¼Œæœ€åå†æŠŠï¼ˆsp + 4ï¼‰ä¸­çš„å€¼å­˜åˆ°r1ä¸­ã€‚
è¿™ä¸ªè¿‡ç¨‹å¾ˆå†—ä½™ï¼Œæˆ‘ä»¬ä¸ºäº†çœ‹èµ·æ¥æ›´è¯¦ç»†ï¼Œç”¨äº†Testingæ¨¡å¼ï¼Œå¦‚æœæ˜¯Archivingæ¨¡å¼ï¼Œåˆ™è¿™æ®µä»£ç ä¼šè¢«ä¼˜åŒ–æ‰ã€‚</p>

<p>è¿™æ˜¯ï¼Œè°ƒç”¨printfçš„å‚æ•°åœ¨å¯„å­˜å™¨ä¸­å°±å‡†å¤‡å¥½äº†ã€‚æ¥ä¸‹æ¥bl printf</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>str	r0, [sp]                @ 4-byte Spill
add	sp, #12
pop	{r7, pc}
</code></pre></div></div>

<p>æœ€åæ˜¯ä¸€ä¸ªå‡ºæ ˆçš„è¿‡ç¨‹ï¼Œç”±äºä¹‹å‰spå‡æ‰äº†12å­—èŠ‚ï¼Œç°åœ¨è¦åŠ å›æ¥ã€‚</p>

<p>ç„¶åæˆ‘ä»¬å†æ¥åˆ†æaddFunctionå‡½æ•°å†…éƒ¨çš„è°ƒç”¨è¿‡ç¨‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="p">.</span><span class="n">globl</span>	<span class="n">_addFunction</span>
	<span class="p">.</span><span class="n">align</span>	<span class="mi">2</span>
	<span class="p">.</span><span class="n">code</span>	<span class="mi">16</span>                      <span class="err">@</span> <span class="err">@</span><span class="n">addFunction</span>
	<span class="p">.</span><span class="n">thumb_func</span>	<span class="n">_addFunction</span>
<span class="n">_addFunction</span><span class="o">:</span>
	<span class="p">.</span><span class="n">cfi_startproc</span>
<span class="n">Lfunc_begin0</span><span class="o">:</span>
	<span class="p">.</span><span class="n">loc</span>	<span class="mi">1</span> <span class="mi">14</span> <span class="mi">0</span>                 
<span class="err">@</span> <span class="n">BB</span><span class="err">#</span><span class="mi">0</span><span class="o">:</span>
	<span class="n">sub</span>	<span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">12</span>
	<span class="n">str</span>	<span class="n">r0</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">8</span><span class="p">]</span>
	<span class="n">str</span>	<span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span><span class="p">]</span>
	<span class="p">.</span><span class="n">loc</span>	<span class="mi">1</span> <span class="mi">15</span> <span class="mi">0</span> <span class="n">prologue_end</span>    
<span class="n">Ltmp0</span><span class="o">:</span>
	<span class="n">ldr</span>	<span class="n">r0</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">8</span><span class="p">]</span>
	<span class="n">ldr</span>	<span class="n">r1</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span><span class="p">]</span>
	<span class="n">add</span>	<span class="n">r0</span><span class="p">,</span> <span class="n">r1</span>
	<span class="n">str</span>	<span class="n">r0</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span>
	<span class="p">.</span><span class="n">loc</span>	<span class="mi">1</span> <span class="mi">16</span> <span class="mi">0</span>                  
	<span class="n">ldr</span>	<span class="n">r0</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span>
	<span class="n">add</span>	<span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">12</span>
	<span class="n">bx</span>	<span class="n">lr</span>
<span class="n">Ltmp1</span><span class="o">:</span>
<span class="n">Lfunc_end0</span><span class="o">:</span>
	<span class="p">.</span><span class="n">cfi_endproc</span>
</code></pre></div></div>

<p><strong>sub	sp, #12</strong> : ä¸ºaddFunctionå¼€è¾Ÿ12å­—èŠ‚ç©ºé—´
<strong>str	r0, [sp, #8] </strong> : æŠŠr0çš„å€¼æ”¾åˆ°sp+8çš„ä½ç½®ï¼Œr0é‡Œä¿å­˜çš„æ˜¯50
<strong>str	r1, [sp, #4] </strong> : æŠŠr1çš„å€¼æ”¾åˆ°sp+4çš„ä½ç½®ï¼Œr1é‡Œä¿å­˜çš„æ˜¯51
<strong>ldr	r0, [sp, #8] </strong> : æŠŠsp+8ä¸­å­˜æ”¾çš„å€¼å†æ”¾å›r0ä¸­
<strong>ldr	r1, [sp, #4] </strong> : æŠŠsp+4ä¸­å­˜æ”¾çš„å€¼å†æ”¾å›r1ä¸­</p>

<p>åŒæ ·è¿™å››æ­¥å†—ä½™çš„ä»£ç ä¼šè¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰ã€‚</p>

<p><strong>add	r0, r1</strong>        : è®¡ç®—r0 + r1å°†ç»“æœæ”¾å›r0
<strong>str	r0, [sp]</strong>      : æŠŠr0ä¿å­˜åœ¨sp+0çš„ä½ç½®
<strong>ldr	r0, [sp]</strong>      : æŠŠr0åœ¨loadå›æ¥
<strong>add	sp, #12 </strong>      : è¿˜åŸstack pointerçš„ä½ç½®ï¼Œç”±äºä¹‹å‰å‘ä¸‹å¼€è¾Ÿäº†12å­—èŠ‚çš„ç©ºé—´ï¼Œç°åœ¨éœ€è¦è¿˜åŸå›å»ã€‚
<strong>bx	lr </strong>           : æ‰§è¡Œä¸‹é¢ä¸€æ¡æŒ‡ä»¤ï¼Œæ­¤æ—¶lrä¸­å­˜çš„å€¼ä¸º_fooFunctionçš„åœ°å€ã€‚</p>

<p>è¿™æ ·ï¼Œæ•´æ®µæ±‡ç¼–æŒ‡ä»¤å°±å…¨éƒ¨åˆ†æå®Œæˆäº†ï¼Œä½†æ˜¯ç›¸ä¿¡ä¸æ˜¯æ‰€æœ‰äººéƒ½çœ‹çš„æ˜ç™½ï¼Œè€Œä¸”ä»…é é€»è¾‘åˆ†ææ˜¾ç„¶ä¸å¤Ÿç›´è§‚ï¼Œä¸‹é¢æˆ‘ä»¬ç”¨LLDBäº²è‡ªè°ƒè¯•ä¸€ä¸‹ã€‚</p>

<h3>Debug with LLDB</h3>

<p>æˆ‘ä»¬é¦–å…ˆåœ¨fooFunctionå…¥å£å¤„æ‰“ä¸€ä¸ªæ–­æ–­ç‚¹ï¼š</p>

<p><a href="/assets/images/2013/06/assembly-break.png"><img src="/assets/images/2013/06/assembly-break.png" alt="assembly-break" width="419" height="190" /></a></p>

<p>ç„¶åç”¨çœŸæœºè°ƒè¯•ç¨‹åºï¼Œåœåœ¨æ–­ç‚¹å¤„ï¼š</p>

<p><a href="/assets/images/2013/06/assembly-break2.png"><img src="/assets/images/2013/06/assembly-break2.png" alt="assembly-break2" width="290" height="65" /></a></p>

<p>è¿™æ—¶ï¼Œæˆ‘ä»¬å…ˆç”¨<code>bt</code>æŸ¥çœ‹å½“å‰çº¿ç¨‹çš„stack frameï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tid = 0x1bf859, 0x000eab5e ARMAssembly`fooFunction + 18 at main.m:20, queue = 'com.apple.main-thread, stop reason = breakpoint 2.1
    frame #0: 0x000eab5e ARMAssembly`fooFunction + 18 at main.m:20
    frame #1: 0x000eab8e ARMAssembly`main(argc=1, argv=0x27d1fcfc) + 14 at main.m:26
</code></pre></div></div>

<p>å…¶ä¸­ï¼Œframe #0: 0x000eab5eè¿™ä¸ªå€¼å°±æ˜¯ _fooFunctionçš„å…¥å£åœ°å€ã€‚</p>

<p>ç„¶åæˆ‘ä»¬å†<code>register read</code>ä¸€ä¸‹ï¼š</p>

<div class="md-flex-h">
<div><img src="/assets/images/2013/06/assembly-stack1.png" /></div>
<div class="md-margin-left-12"><pre>
General Purpose Registers:
r0 = 0x00000032
r1 = 0x00000033
r2 = 0x27d1fd04
r3 = 0x27d1fd30
r4 = 0x00000000
r5 = 0x000eab81  ARMAssembly`main + 1 at main.m:25
r6 = 0x00000000
r7 = 0x27d1fcc8
r8 = 0x27d1fcf4
r9 = 0x3b347e30  
r10 = 0x00000000
r11 = 0x00000000
r12 = 0x80000028
sp = 0x27d1fcbc
lr = 0x000eab8f  ARMAssembly`main + 15 at main.m:26
pc = 0x000eab5e  ARMAssembly`fooFunction + 18 at main.m:20
cpsr = 0x20000030
</pre></div>
</div>

<p>å¦‚å›¾æ‰€ç¤ºï¼Œr0,r1å¡«å¥½äº†å…¥å‚50ï¼Œ51ï¼ŒspæŒ‡å‘æ ˆåº•ï¼ŒlræŒ‡å‘ä¸‹ä¸€æ¡å‡½æ•°çš„å…¥å£åœ°å€
å¥½äº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥åˆ†æstackï¼š<code>memory read/6xw 0x27d1fcbc</code>ä»å½“å‰spçš„ä½ç½®å‘ä¸Š6*4 = 24å­—èŠ‚ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x27d1fcbc: 0x2be8c384 0x27d1fcf4 0x00000000 0x27d1fcd8
0x27d1fccc: 0x000eab8f 0x27d1fcfc
</code></pre></div></div>
<p>æ­¤æ—¶çš„stack frameå¦‚å³å›¾æ‰€ç¤ºï¼šæˆ‘ä»¬çœ‹åˆ°ï¼Œlrå’Œr7å·²ç»å…¥æ ˆã€‚</p>

<p>ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ‰§è¡Œ<code class="highlighter-rouge">addFunction:</code></p>

<p><a href="/assets/images/2013/06/assembly-break3.png"><img src="/assets/images/2013/06/assembly-break3.png" alt="assembly-break3" width="432" height="69" /></a></p>

<p>å†<code class="highlighter-rouge">bt</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span> thread <span class="c">#1: tid = 0x1bf859, 0x000eab3e ARMAssembly`addFunction(a=50, b=51) + 6 at main.m:15, queue = 'com.apple.main-thread, stop reason = breakpoint 1.1</span>
    frame <span class="c">#0: 0x000eab3e ARMAssembly`addFunction(a=50, b=51) + 6 at main.m:15</span>
    frame <span class="c">#1: 0x000eab62 ARMAssembly`fooFunction + 22 at main.m:20</span>
    frame <span class="c">#2: 0x000eab8e ARMAssembly`main(argc=1, argv=0x27d1fcfc) + 14 at main.m:26</span>
</code></pre></div></div>

<p>æˆ‘ä»¬çœ‹åˆ°å¤šäº†ä¸€ä¸ªframeæ˜¯addFunctionï¼Œæ­¤å¤–ï¼Œæ¯ä¸ªfunctionçš„å…¥å£åœ°å€ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™æ„å‘³ç€lrä¸­çš„åœ°å€ä¹Ÿä¼šç›¸åº”å‘ç”Ÿå˜åŒ–ï¼
åŒæ ·ï¼Œæˆ‘ä»¬å†çœ‹ä¸€éå¯„å­˜å™¨ï¼š<code>register read</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>General Purpose Registers:
        r0 <span class="o">=</span> 0x00000032
        r1 <span class="o">=</span> 0x00000033
        r2 <span class="o">=</span> 0x27d1fd04
        r3 <span class="o">=</span> 0x27d1fd30
        r4 <span class="o">=</span> 0x00000000
        r5 <span class="o">=</span> 0x000eab81  ARMAssembly<span class="sb">`</span>main + 1 at main.m:25
        r6 <span class="o">=</span> 0x00000000
        r7 <span class="o">=</span> 0x27d1fcc8
        r8 <span class="o">=</span> 0x27d1fcf4
        r9 <span class="o">=</span> 0x3b347e30  
       r10 <span class="o">=</span> 0x00000000
       r11 <span class="o">=</span> 0x00000000
       r12 <span class="o">=</span> 0x80000028
        sp <span class="o">=</span> 0x27d1fcb0
        lr <span class="o">=</span> 0x000eab63  ARMAssembly<span class="sb">`</span>fooFunction + 23 at main.m:20
        pc <span class="o">=</span> 0x000eab3e  ARMAssembly<span class="sb">`</span>addFunction + 6 at main.m:15
      cpsr <span class="o">=</span> 0x20000030
</code></pre></div></div>

<p><img class="md-img-center" src="/assets/images/2013/06/assembly-stack2.png" /></p>

<p>æ­¤æ—¶ï¼Œr0ï¼Œr1ä¸ºå…¥å‚ï¼ŒspæŒ‡å‘æ ˆåº•ï¼Œå½“å‰spä½ç½®ä¸º0x27d1fcb0ï¼Œå’Œä¸Šå›¾ä¸­çš„ä½ç½®æ­£å¥½ç›¸å·®12å­—èŠ‚ï¼è¿™12å­—èŠ‚ä¹Ÿå°±æ˜¯addFunctionçš„stack frameã€‚æ­¤æ—¶lræŒ‡å‘äº†ä¸‹ä¸€æ¡å‡½æ•°å…¥å£ï¼šfooFunctionã€‚å€¼ä¸º:0x000eab63ï¼Œæ¯”æˆ‘ä»¬btå‡ºæ¥çš„0x000eab62å¤šä¸€ä¸ªå­—èŠ‚ã€‚å› ä¸ºlræ°¸è¿œæŒ‡å‘ä¸‹ä¸€æ¡å‡½æ•°å…¥å£åœ°å€çš„ä¸‹ä¸€ä¸ªå­—èŠ‚ã€‚</p>

<p>å¥½äº†æˆ‘ä»¬çœ‹çœ‹æ­¤æ—¶çš„æ ˆçš„æƒ…å†µ<code> memory read/3xw 0x27d1fcb0</code>ï¼šä»æ ˆåº•å‘ä¸Š12å­—èŠ‚ï¼Œå¦‚å›¾æ‰€ç¤ºï¼šæ¯ä¸€ä¸ª4å­—èŠ‚å•å…ƒä¿å­˜äº†å…·ä½“è¿ç®—çš„æ•°å€¼ï¼Œå¯¹ç…§æˆ‘ä»¬ä¹‹å‰çš„åˆ†æï¼Œå®Œå…¨å»åˆã€‚</p>

<p>åé¢çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ä¾æ­¤æ–¹æ³•å»è§‚å¯Ÿå¯„å­˜å™¨å’Œstackæƒ…å†µï¼Œæ¥å°è¯æˆ‘ä»¬ä¸Šæ–‡çš„åˆ†æã€‚</p>

<p class="md-p-center md-margin-top-24">ï¼ˆå…¨æ–‡å®Œï¼‰</p>

<h3 id="resources">Resources</h3>

<ul>
  <li><a href="http://www.raywenderlich.com/37181/ios-assembly-tutorial">iOS Assembly</a></li>
  <li><a href="http://lldb.llvm.org/lldb-gdb.html">LLDB debugger tool</a></li>
</ul>
:ET