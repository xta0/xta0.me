I"â<p>C++ Core Guidelineä¸­å…³äºå‡½æ•°å‚æ•°ä¼ é€’ï¼Œæœ‰ä¸¤æ¡è§„åˆ™</p>

<ol>
  <li>How to pass arguments and return values</li>
  <li>Pass cheaply-copied types by value and others by reference to const</li>
</ol>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»¥iOSå¹³å°ä¸ºä¾‹ï¼Œè®¨è®ºä¸€ä¸‹è¿™èƒŒåçš„åŸå› ã€‚</p>

<h3 id="how-argument-passing-works-at-the-cpu-level">How argument passing works at the CPU level</h3>

<p>Cé‡Œé¢çš„å‡½æ•°è°ƒç”¨é€šå¸¸ç”±ä¸€ç³»åˆ—instructionæ„æˆ</p>

<p>1.å‡½æ•°å‚æ•°éœ€è¦æ ¹æ®calling conventionæ”¾åˆ°åˆé€‚çš„åœ°æ–¹ã€‚è¿™æ ·è¢«è°ƒç”¨çš„å‡½æ•°çŸ¥é“å»å“ªé‡Œæ‰¾</p>
<ol>
  <li>å‡½æ•°çš„è¿”å›åœ°å€éœ€è¦è¢«æ”¾åˆ°æŸä¸ªä½ç½®ï¼Œè¿™æ ·calleeä¼šå°†æ§åˆ¶æƒè¿”å›ç»™caller</li>
  <li>controlä¼šæŒ‡å‘functionçš„ç¬¬ä¸€æ¡æŒ‡ä»¤</li>
</ol>

<p>åœ¨modernçš„CPUä¸Šï¼Œå…·ä½“è¡¨ç°ä¸º</p>

<ol>
  <li>
    <p>ä¸€äº›pointer-sizedå‡½æ•°å‚æ•°ä¼šè¢«æ”¾åˆ°æŸäº›ç‰¹æ®Šçš„å¯„å­˜å™¨ä¸­ï¼Œå…¶å®ƒæ¯”è¾ƒå¤§çš„å‚æ•°æ”¾åˆ°stackä¸Šï¼Œè¿™äº›å‚æ•°åœ¨stackä¸Šçš„åœ°å€ä¼šè¢«ä¿å­˜åˆ°å¯„å­˜å™¨ä¸­ã€‚è¿™é‡Œä¹Ÿä¼šæœ‰ä¾‹å¤–ï¼Œæ¯”å¦‚å‚æ•°å¤§å°æ­£å¥½æ˜¯2ä¸ªpointer-sizeï¼Œæˆ–è€…å‚æ•°æ˜¯floating-pointçš„ç±»å‹ï¼Œå¯å˜å‚æ•°çš„è¡Œä¸ºä¹Ÿä¸ä¸€æ ·(<code class="highlighter-rouge">printf(const char*, ...)</code>)</p>
  </li>
  <li>
    <p>æ±‡ç¼–ä¸­ä¼šæœ‰ç±»ä¼¼äº<code class="highlighter-rouge">call</code>è¿™æ ·çš„instructionç”¨æ¥Jumpåˆ°ç›®æ ‡å‡½æ•°ï¼Œå¹¶ä¸”stashè¿”å›return address</p>
  </li>
  <li>
    <p>æ±‡ç¼–ä¸­ä¼šæœ‰ç±»ä¼¼äº<code class="highlighter-rouge">return</code>è¿™æ ·çš„å‘½ä»¤è·³è½¬åˆ°ä¸Šä¸€æ­¥stashçš„å‡½æ•°åœ°å€ï¼Œä»¥ä¾¿ç»§ç»­æ‰§è¡Œåé¢çš„æŒ‡ä»¤</p>
  </li>
</ol>

<p>å¯¹äºä¸iOSçš„ARM64 CPUæ¥è¯´</p>

<ol>
  <li>
    <p>ç¼–è¯‘å™¨ä¼šå°è¯•å°†å‡½æ•°çš„å‰8ä¸ªå‚æ•°æ”¾åˆ°é€šç”¨64bitå¯„å­˜å™¨ <code class="highlighter-rouge">x0-x7</code>ï¼Œæˆ–è€…<code class="highlighter-rouge">v0-v7</code>ä¸­(SIMD/floating-point registers)ã€‚Integeræˆ–è€…æŒ‡é’ˆç±»å‹çš„å‚æ•°ä¼šè¢«æ”¾åˆ°<code class="highlighter-rouge">x0-x7</code>ä¸­ï¼Œ<code class="highlighter-rouge">float/double/long double</code>å‚æ•°ä¼šè¢«æ”¾åˆ°<code class="highlighter-rouge">v0-v7</code>ä¸­ã€‚å¯¹äºæ¯”è¾ƒå¤§çš„(å¤§äºç­‰äº16 bytes)<code class="highlighter-rouge">struct</code>å‚æ•°ï¼Œå®ƒä»¬ä¼šè¢«copyåˆ°stackä¸Šï¼ŒæŒ‡å‘è¿™ä»½copyçš„pointerä¼šè¢«æ”¾åˆ°å¯„å­˜å™¨<code class="highlighter-rouge">x0-x7</code>ä¸­ (Note: this is easy to miss: itâ€™s item B.3 in section 5.4.2 of â€œProcedure Call Standard for the ARM 64-bit Architectureâ€)ã€‚å¯¹äºå°çš„<code class="highlighter-rouge">struct</code>(å°äº16 bytes)ï¼Œå®ƒä»¬ä¼šè¢«æ”¾åˆ°ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªå¯„å­˜å™¨ä¸­ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œå¦‚æœä¸€ä¸ª<code class="highlighter-rouge">struct</code>åŒ…æ¶µå°äº4ä¸ªfloat pointerï¼Œå®ƒä¹Ÿä¼šè¢«æ”¾åˆ°å¯„å­˜å…¶ä¸­ã€‚</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">bl</code> (branch and link)æŒ‡ä»¤ä¼šå°†controläº¤ç»™å®ƒçš„å‚æ•°ï¼Œå¹¶å°†è¿”å›åœ°å€å­˜åˆ°ä¸€ä¸ªç‰¹æ®Šçš„link registerä¸­(â€œLRâ€)</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">blr</code>æŒ‡ä»¤ç”¨äºå‡½æ•°è¿”å›ã€‚å®ƒå°†controläº¤ç»™LRå¯„å­˜å™¨ä¸­ä¿å­˜çš„å€¼</p>
  </li>
</ol>
:ET