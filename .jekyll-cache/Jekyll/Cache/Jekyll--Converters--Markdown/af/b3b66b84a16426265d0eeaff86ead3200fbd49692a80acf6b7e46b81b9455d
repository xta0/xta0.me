I"3Ò<p>åœ¨GCDå’ŒNSOperationQueueä¹‹å‰ï¼ŒiOSä½¿ç”¨çº¿ç¨‹ä¸€èˆ¬æ˜¯ç”¨NSThreadï¼Œè€ŒNSThreadæ˜¯å¯¹<a title="POSIX THREAD" href="http://en.wikipedia.org/wiki/POSIX_Threads">POSIX thread</a>çš„å°è£…,ä¹Ÿå°±æ˜¯pthreadï¼Œæœ¬æ–‡æœ€åä¼šé¢é™„ä¸Šä¸€æ®µä½¿ç”¨pthreadä¸‹å›¾ç‰‡çš„ä»£ç ï¼Œç°åœ¨æˆ‘ä»¬è¿˜æ˜¯ç»§ç»­ä¸Šé¢çš„è®¨è®ºã€‚ä½¿ç”¨NSThreadçš„ä¸€ä¸ªæœ€å¤§çš„é—®é¢˜æ˜¯ï¼šç›´æ¥æ“çºµçº¿ç¨‹ï¼Œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå®Œå…¨äº¤ç»™developeræ§åˆ¶ï¼Œåœ¨å¤§çš„å·¥ç¨‹ä¸­ï¼Œæ¨¡å—é—´ç›¸äº’ç‹¬ç«‹ï¼Œå‡å¦‚Aæ¨¡å—å¹¶å‘äº†8æ¡çº¿ç¨‹ï¼ŒBæ¨¡å—éœ€è¦å¹¶å‘6æ¡çº¿ç¨‹ï¼Œä»¥æ­¤ç±»æ¨ï¼Œçº¿ç¨‹æ•°é‡ä¼šæŒç»­å¢é•¿ï¼Œæœ€ç»ˆä¼šå¯¼è‡´éš¾ä»¥æ§åˆ¶çš„ç»“æœã€‚</p>

<p>GCDå’ŒNSOperationQueueå‡ºæ¥ä»¥åï¼Œdeveloperå¯ä»¥ä¸ç›´æ¥æ“çºµçº¿ç¨‹ï¼Œè€Œæ˜¯å°†æ‰€è¦æ‰§è¡Œçš„ä»»åŠ¡å°è£…æˆä¸€ä¸ªunitä¸¢ç»™çº¿ç¨‹æ± å»å¤„ç†ï¼Œçº¿ç¨‹æ± ä¼šæœ‰æ•ˆç®¡ç†çº¿ç¨‹çš„å¹¶å‘ï¼Œæ§åˆ¶çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚å› æ­¤ï¼Œç°åœ¨å¦‚æœè€ƒè™‘åˆ°å¹¶å‘åœºæ™¯ï¼ŒåŸºæœ¬ä¸Šæ˜¯å›´ç»•ç€GCDå’ŒNSOperationQueueæ¥å±•å¼€è®¨è®ºã€‚GCDæ˜¯ä¸€ç§è½»é‡çš„åŸºäºblockçš„çº¿ç¨‹æ¨¡å‹ï¼Œä½¿ç”¨GCDä¸€èˆ¬è¦æ³¨æ„ä¸¤ç‚¹ï¼šä¸€æ˜¯çº¿ç¨‹çš„priorityï¼ŒäºŒæ˜¯å¯¹è±¡é—´çš„å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚NSOperationQueueæ˜¯å¯¹GCDæ›´ä¸Šä¸€å±‚çš„å°è£…ï¼Œå®ƒå¯¹çº¿ç¨‹çš„æ§åˆ¶æ›´å¥½ä¸€äº›ï¼Œä½†æ˜¯ç”¨èµ·æ¥ä¹Ÿéº»çƒ¦ä¸€äº›ã€‚å…³äºè¿™ä¸¤ä¸ªå­°ä¼˜ç†ŸåŠ£ï¼Œéœ€è¦æ ¹æ®å…·ä½“åº”ç”¨åœºæ™¯è¿›è¡Œè®¨è®ºï¼š<a title="GCD vs NSOperation" href="http://stackoverflow.com/questions/10373331/nsoperation-vs-grand-central-dispatch">stackoverflow:GCD vs NSopeartionQueue</a>ã€‚</p>

<p>æˆ‘ä»¬åé¢ä¼šä»¥ä¸‹è½½å›¾ç‰‡ä¸ºä¾‹ï¼Œé¦–å…ˆæ¥åˆ†æåœ¨éå¹¶å‘çš„æƒ…å†µä¸‹NSOperationQueueå’ŒGCDçš„ç”¨æ³•å’Œç‰¹æ€§ï¼Œç„¶ååˆ†æåœ¨å¹¶å‘çš„æƒ…å†µä¸‹è®¨è®ºNSOperationQueueå¯¹çº¿ç¨‹çš„ç®¡ç†ã€‚</p>

<blockquote>
  <p>æµ‹è¯•å›¾ç‰‡æ¥è‡ª<a href="http://www.collegedj.net/wp-content/uploads/">è¿™é‡Œ</a></p>
</blockquote>

<h3 id="å¼‚æ­¥ä¸‹è½½">å¼‚æ­¥ä¸‹è½½</h3>

<p>å…ˆä»NSOperationQueueæœ€ç®€å•çš„ç”¨æ³•å¼€å§‹ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_opQueue</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSOperationQueue</span> <span class="nf">alloc</span><span class="p">]</span><span class="nf">init</span><span class="p">];</span>
<span class="p">[</span><span class="n">_opQueue</span> <span class="nf">addOperationWithBlock</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
        <span class="n">NSData</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSData</span> <span class="nf">dataWithContentsOfURL</span><span class="p">:[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="n">url3</span><span class="p">]];</span>
        <span class="c1">//_imgv3.image = [UIImage imageWithData:data];</span>

        <span class="p">[[</span><span class="n">NSOperationQueue</span> <span class="nf">mainQueue</span><span class="p">]</span> <span class="nf">addOperationWithBlock</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
            <span class="n">_imgv3</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nf">imageWithData</span><span class="p">:</span><span class="n">data</span><span class="p">];</span>
        <span class="p">}];</span>
    <span class="p">}];</span>
</code></pre></div></div>

<p>è¿™ç§å†™æ³•å’Œä½¿ç”¨GCDç›¸æ¯”æ²¡ä»»ä½•ä¼˜åŠ¿ï¼Œä½¿ç”¨GCDä»£ç å†™èµ·æ¥è¿˜æ›´é¡ºæ‰‹ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">downloadWithGCD</span>
<span class="p">{</span>
    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">_gcdQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">NSData</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSData</span> <span class="nf">dataWithContentsOfURL</span><span class="p">:[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="n">url4</span><span class="p">]];</span>
        <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
            <span class="n">self</span><span class="p">.</span><span class="n">imgv4</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nf">imageWithData</span><span class="p">:</span><span class="n">data</span><span class="p">];</span>
             <span class="n">NSLog</span><span class="p">(</span><span class="s">@"done downloading 3rdimage "</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="çº¿ç¨‹åŒæ­¥">çº¿ç¨‹åŒæ­¥</h2>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å†å¯¹æ¯”ä¸€ä¸‹GCDå’ŒNSOperationå¯¹çº¿ç¨‹çš„æ§åˆ¶æ€§ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤å¼ å›¾è¦ä¸‹è½½ï¼Œç¬¬äºŒå¼ è¦åœ¨ç¬¬ä¸€å¼ å®Œæˆåå†å»ä¸‹è½½ï¼Œæ˜¾ç„¶è¿™æ˜¯ä¸€ä¸ªçº¿ç¨‹åŒæ­¥çš„é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆç”¨NSOperationæ¥å®ç°</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">downloadWithNSOperationDependency</span>
<span class="p">{</span>
    <span class="n">ETOperation</span><span class="o">*</span> <span class="n">op1</span> <span class="o">=</span> <span class="p">[</span><span class="n">ETOperation</span> <span class="nf">new</span><span class="p">];</span>
    <span class="n">op1</span><span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="n">url3</span><span class="p">];</span>
    <span class="n">__weak</span> <span class="n">ETOperation</span><span class="o">*</span> <span class="n">_op1</span> <span class="o">=</span> <span class="n">op1</span><span class="p">;</span>
    <span class="p">[</span><span class="n">op1</span> <span class="nf">setCompletionBlock</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
        <span class="n">_imgv3</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">_op1</span><span class="p">.</span><span class="n">image</span><span class="p">;</span>
    <span class="p">}];</span>
    <span class="p">[</span><span class="n">op1</span> <span class="nf">start</span><span class="p">];</span>
    
    <span class="n">ETOperation</span><span class="o">*</span> <span class="n">op2</span> <span class="o">=</span> <span class="p">[</span><span class="n">ETOperation</span> <span class="nf">new</span><span class="p">];</span>
    <span class="n">op2</span><span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="n">url4</span><span class="p">];</span>
    <span class="n">__weak</span> <span class="n">ETOperation</span><span class="o">*</span> <span class="n">_op2</span> <span class="o">=</span> <span class="n">op2</span><span class="p">;</span>
    <span class="p">[</span><span class="n">op2</span> <span class="nf">setCompletionBlock</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
        <span class="n">_imgv4</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">_op2</span><span class="p">.</span><span class="n">image</span><span class="p">;</span>
    <span class="p">}];</span>
    <span class="p">[</span><span class="n">op2</span> <span class="nf">addDependency</span><span class="p">:</span><span class="n">op1</span><span class="p">];</span>
    <span class="p">[</span><span class="n">op2</span> <span class="nf">start</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸Šè¿°ä»£ç ä¸­<code class="highlighter-rouge">op2</code>å°†åœ¨<code class="highlighter-rouge">op1</code>æ‰§è¡Œå®Œæˆåæ‰§è¡Œã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨GCDæ¥å®ŒæˆåŒæ ·çš„ä»»åŠ¡ï¼Œä»…å°±ä¸Šé¢çš„caseæ¥è¯´ï¼Œä½¿ç”¨GCDæœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œæ¯”å¦‚æœ€å¸¸ç”¨çš„å°±æ˜¯ä½¿ç”¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œå½“ç¬¬ä¸€ä¸ªä¸‹è½½blockæ‰§è¡Œå®Œååœ¨å¯åŠ¨ç¬¬äºŒä¸ªblockè¿›è¡Œä¸‹è½½ï¼Œè¿™ç§æ–¹å¼å¤ªè¿‡ç®€å•ï¼Œè¿™é‡Œå°±ä¸åšè¿‡å¤šä»‹ç»ï¼Œä¸‹é¢ç»™å‡ºä¸€ç§ä½¿ç”¨<code class="highlighter-rouge">dispatch_group</code>çš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼ç•¥æ˜¾ç¬¨æ‹™ï¼Œä½†æ˜¯å¯ä»¥å±•ç¤ºå¦‚ä½•ä½¿ç”¨GCDæ¥åšçº¿ç¨‹åŒæ­¥</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">downloadWithGCDGroups</span>
<span class="p">{</span>
    <span class="n">dispatch_group_t</span> <span class="n">group</span> <span class="o">=</span> <span class="n">dispatch_group_create</span><span class="p">();</span>
    <span class="n">dispatch_queue_t</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">dispatch_group_async</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="o">^</span><span class="p">(){</span>
        <span class="n">NSData</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSData</span> <span class="nf">dataWithContentsOfURL</span><span class="p">:[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="n">url3</span><span class="p">]];</span>
        <span class="n">dispatch_group_async</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">(){</span>
            <span class="n">self</span><span class="p">.</span><span class="n">imgv3</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nf">imageWithData</span><span class="p">:</span><span class="n">data</span><span class="p">];</span>
        <span class="p">});</span>
    <span class="p">});</span>
    <span class="c1">// This block will run once everything above is done:</span>
    <span class="n">dispatch_group_notify</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">(){</span> 
        <span class="n">dispatch_async</span><span class="p">(</span><span class="n">_gcdQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
            <span class="n">NSData</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSData</span> <span class="nf">dataWithContentsOfURL</span><span class="p">:[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="n">url4</span><span class="p">]];</span>
            <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
                <span class="n">self</span><span class="p">.</span><span class="n">imgv4</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nf">imageWithData</span><span class="p">:</span><span class="n">data</span><span class="p">];</span>   
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>
<p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå¦‚æœæ˜¯ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥é—®é¢˜ï¼Œæˆ‘ä»¬ä¸ä¼šä¹¦ç±»ä¼¼å†™ä¸Šé¢çš„ä»£ç ã€‚å®é™…ä¸Š<code class="highlighter-rouge">dispatch_group</code>çš„ä½œç”¨åœ¨äºæ§åˆ¶å¤šä¸ªçº¿ç¨‹å¹¶å‘ï¼Œå¹¶ä¸ºè¿™äº›çº¿ç¨‹æä¾›ä¸€ä¸ªçº¿ç¨‹åŒæ­¥ç‚¹ï¼Œå³å½“<code class="highlighter-rouge">group</code>å†…çš„æ‰€æœ‰çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæˆåï¼Œå†é€šçŸ¥å¤–éƒ¨(ç±»ä¼¼Javaä¸­çº¿ç¨‹çš„<code class="highlighter-rouge">join</code>æ“ä½œ)ã€‚å› æ­¤ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œ<code class="highlighter-rouge">dispatch_group</code>çš„ç”¨æ³•å¦‚ä¸‹ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dispatch_queue_t</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">dispatch_get_global_queue</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
<span class="n">dispatch_group_t</span> <span class="n">group</span> <span class="o">=</span> <span class="n">dispatch_group_create</span><span class="p">();</span>

<span class="c1">//run task #1</span>
<span class="n">dispatch_group_enter</span><span class="p">(</span><span class="n">group</span><span class="p">);</span>
<span class="n">dispatch_async</span><span class="p">(</span> <span class="n">queue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span> <span class="s">@"task 1 finished: %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">NSThread</span> <span class="nf">currentThread</span><span class="p">]</span> <span class="p">);</span>
    <span class="n">dispatch_group_leave</span><span class="p">(</span><span class="n">group</span><span class="p">);</span>
<span class="p">}</span> <span class="p">);</span>

<span class="c1">//run task #2</span>
<span class="n">dispatch_group_enter</span><span class="p">(</span><span class="n">group</span><span class="p">);</span>
<span class="n">dispatch_async</span><span class="p">(</span> <span class="n">queue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span> <span class="s">@"task 2 finished: %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">NSThread</span> <span class="nf">currentThread</span><span class="p">]</span> <span class="p">);</span>
    <span class="n">dispatch_group_leave</span><span class="p">(</span><span class="n">group</span><span class="p">);</span>
<span class="p">}</span> <span class="p">);</span>

<span class="c1">//sychronization point</span>
<span class="n">dispatch_group_notify</span><span class="p">(</span> <span class="n">group</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span> <span class="s">@"all task done: %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">NSThread</span> <span class="nf">currentThread</span><span class="p">]</span> <span class="p">);</span>
<span class="p">}</span> <span class="p">);</span>
</code></pre></div></div>
<p>å¦‚æœè€ƒè™‘æ§åˆ¶çº¿ç¨‹ï¼Œç›¸æ¯”GCDæ¥è¯´NSOperationæ˜¯ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼Œå®ƒæä¾›äº†å¾ˆå¤šGCDæ²¡æœ‰çš„é«˜çº§ç”¨æ³•ï¼š</p>

<ol>
  <li>Operationä¹‹é—´å¯æŒ‡å®šä¾èµ–å…³ç³»</li>
  <li>å¯æŒ‡å®šæ¯ä¸ªOperationçš„ä¼˜å…ˆçº§</li>
  <li>å¯ä»¥Cancelæ­£åœ¨æ‰§è¡Œçš„Operation</li>
  <li>å¯ä»¥ä½¿ç”¨KVOè§‚å¯Ÿå¯¹ä»»åŠ¡çŠ¶æ€ï¼š<code class="highlighter-rouge">isExecuteing</code>ã€<code class="highlighter-rouge">isFinished</code>ã€<code class="highlighter-rouge">isCancelled</code></li>
</ol>

<h3 id="nsoperationqueueä¸çº¿ç¨‹æ± ">NSOperationQueueä¸çº¿ç¨‹æ± </h3>

<p>ä¸‹é¢æˆ‘ä»¬åœ¨æ¥è§‚å¯Ÿå¹¶å‘çš„æƒ…å†µï¼Œè¿™ä¹Ÿæ˜¯ä»Šå¤©é‡ç‚¹è¦è®¨è®ºçš„ã€‚æˆ‘ä»¬å…ˆä»<code class="highlighter-rouge">NSOperationQueue</code>çš„å¹¶å‘æ¨¡å‹å¼€å§‹ï¼š</p>

<p>è¿™é‡Œæ˜¯appleå…³äºå¹¶å‘NSOperationQueueçš„<a href="&quot;https://developer.apple.com/library/mac/documentation/general/conceptual/concurrencyprogrammingguide/OperationObjects/OperationObjects.html#//apple_ref/doc/uid/TP40008091-CH101-SW1&quot;">Guideline</a>;</p>

<p>æ€»ç»“ä¸€ä¸‹ï¼Œè¦ç‚¹æœ‰è¿™ä¹ˆå‡ æ¡ï¼š</p>

<ol>
  <li>å¦‚æœè¦æ±‚concurrentï¼Œé‚£ä¹ˆNSOperationçš„ç”Ÿå‘½å‘¨æœŸè¦è‡ªå·±æŠŠæ§</li>
  <li>å¹¶å‘çš„operationè¦ç»§æ‰¿NSOperationè€Œä¸”å¿…é¡»overrideè¿™å‡ ä¸ªæ–¹æ³•ï¼š
    <ul>
      <li><code class="highlighter-rouge">start</code>ï¼Œ<code class="highlighter-rouge">isExecuting</code>ï¼Œ<code class="highlighter-rouge">isFinished</code>ï¼Œ<code class="highlighter-rouge">isConcurrent</code></li>
    </ul>
  </li>
  <li>å¤å†™<code class="highlighter-rouge">isExecuting</code>å’Œ<code class="highlighter-rouge">isFinished</code>è¦æ±‚ï¼š
    <ul>
      <li>çº¿ç¨‹å®‰å…¨</li>
      <li>æ‰‹åŠ¨å‡ºå‘kvoé€šçŸ¥</li>
    </ul>
  </li>
</ol>

<p>æ»¡è¶³è¿™ä¸‰ç‚¹ï¼Œå°±å¯ä»¥ä½¿ç”¨NSOperationQueueå¹¶å‘äº†ï¼Œæˆ‘ä»¬å…ˆæŒ‰ç…§ä¸Šé¢çš„è¦æ±‚åˆ›å»ºä¸€ä¸ª<code class="highlighter-rouge">NSOperation</code>ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">MXOperation</span> <span class="p">:</span> <span class="nc">NSOperation</span>
<span class="p">{</span>
    <span class="n">NSString</span><span class="o">*</span>   <span class="n">_threadName</span><span class="p">;</span>
    <span class="n">NSString</span><span class="o">*</span>   <span class="n">_url</span><span class="p">;</span>
    <span class="n">BOOL</span>        <span class="n">executing</span><span class="p">;</span>
    <span class="n">BOOL</span>        <span class="n">finished</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">MXOperation</span>

<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="nf">initWithUrl</span><span class="p">:(</span><span class="n">NSString</span><span class="o">*</span><span class="p">)</span><span class="nv">url</span> <span class="nf">name</span><span class="p">:(</span><span class="n">NSString</span><span class="o">*</span><span class="p">)</span><span class="nv">name</span><span class="p">;</span>
<span class="p">{</span>
    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">init</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">!=</span><span class="nb">nil</span><span class="p">)</span>
        <span class="n">_threadName</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
        <span class="n">_url</span> <span class="o">=</span> <span class="n">url</span><span class="p">;</span>
        <span class="n">executing</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
        
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">isConcurrent</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">isExecuting</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">executing</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">isFinished</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">finished</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">start</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">NSThread</span> <span class="nf">currentThread</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">_threadName</span><span class="p">;</span>
    <span class="n">currentThreadInfo</span><span class="p">(</span><span class="s">@"start"</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">([</span><span class="n">self</span> <span class="nf">isCancelled</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="c1">// Must move the operation to the finished state if it is canceled.</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">willChangeValueForKey</span><span class="p">:</span><span class="s">@"isFinished"</span><span class="p">];</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
        <span class="p">[</span><span class="n">self</span> <span class="nf">didChangeValueForKey</span><span class="p">:</span><span class="s">@"isFinished"</span><span class="p">];</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// If the operation is not canceled, begin executing the task.</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">willChangeValueForKey</span><span class="p">:</span><span class="s">@"isExecuting"</span><span class="p">];</span>

    <span class="n">executing</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    
    <span class="c1">//ä¸‹è½½å›¾ç‰‡</span>
    <span class="p">[</span><span class="n">NSData</span> <span class="nf">dataWithContentsOfURL</span><span class="p">:[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="n">_url</span><span class="p">]];</span>
    
    <span class="c1">//å®Œæˆä¸‹è½½</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">completeOperation</span><span class="p">];</span>

    <span class="p">[</span><span class="n">self</span> <span class="nf">didChangeValueForKey</span><span class="p">:</span><span class="s">@"isExecuting"</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">completeOperation</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">willChangeValueForKey</span><span class="p">:</span><span class="s">@"isFinished"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">willChangeValueForKey</span><span class="p">:</span><span class="s">@"isExecuting"</span><span class="p">];</span>
    
    <span class="n">executing</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    
    <span class="p">[</span><span class="n">self</span> <span class="nf">didChangeValueForKey</span><span class="p">:</span><span class="s">@"isExecuting"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">didChangeValueForKey</span><span class="p">:</span><span class="s">@"isFinished"</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">dealloc</span>
<span class="p">{</span>
    <span class="n">dumpThreads</span><span class="p">(</span><span class="s">@"dealloc"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>é¦–å…ˆæˆ‘ä»¬æŒ‰ç…§è¦æ±‚å®Œæˆäº†<code class="highlighter-rouge">MXOperation</code>çš„å¹¶å‘ä»£ç ã€‚å…¶æ¬¡æˆ‘ä»¬åœ¨<code class="highlighter-rouge">start</code>çš„æ–¹æ³•ä¸­ï¼Œç»™å½“å‰çº¿ç¨‹å¢åŠ äº†nameï¼Œæ–¹ä¾¿è§‚å¯Ÿã€‚ç„¶åä½¿ç”¨<code class="highlighter-rouge">NSData</code>å»ä¸‹è½½å›¾ç‰‡ï¼Œå›¾ç‰‡ä¸‹è½½å®Œæˆåé€šè¿‡<code class="highlighter-rouge">KVO</code>é€šçŸ¥<code class="highlighter-rouge">OperationQueue</code>ä»»åŠ¡å®Œæˆã€‚æœ€åæˆ‘ä»¬åœ¨<code class="highlighter-rouge">delloc</code>çš„æ–¹æ³•ä¸­ï¼Œè§‚å¯Ÿå½“å‰<code class="highlighter-rouge">active</code>çš„çº¿ç¨‹æƒ…å†µã€‚</p>

<p><code class="highlighter-rouge">currentThreadInfo</code>å’Œ<code class="highlighter-rouge">dumpThreads</code>ä¸¤ä¸ªå·¥å…·å‡½æ•°ï¼Œæ¶‰åŠåˆ°äº†kernelçš„ä¸€äº›APIï¼Œä½œç”¨æ˜¯ç”¨æ¥æŸ¥çœ‹å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">currentThreadInfo</span><span class="p">(</span><span class="n">NSString</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s">"---------%@----------"</span><span class="p">,</span><span class="n">str</span><span class="p">);</span>

    <span class="n">NSThread</span><span class="o">*</span> <span class="kr">thread</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSThread</span> <span class="n">currentThread</span><span class="p">];</span>
    <span class="n">mach_port_t</span> <span class="n">machTID</span> <span class="o">=</span> <span class="n">pthread_mach_thread_np</span><span class="p">(</span><span class="n">pthread_self</span><span class="p">());</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s">"current thread num: %x thread name:%@"</span><span class="p">,</span> <span class="n">machTID</span><span class="p">,</span><span class="kr">thread</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s">"-------------------"</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dumpThreads</span><span class="p">(</span><span class="n">NSString</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="n">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s">"---------%@----------"</span><span class="p">,</span><span class="n">str</span><span class="p">);</span>
    <span class="n">currentThreadInfo</span><span class="p">(</span><span class="n">nil</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="n">thread_act_array_t</span> <span class="n">threads</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">mach_msg_type_number_t</span> <span class="n">thread_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">task_threads</span><span class="p">(</span><span class="n">mach_task_self</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">threads</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">thread_count</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">mach_msg_type_number_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">thread_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">thread_t</span> <span class="kr">thread</span> <span class="o">=</span> <span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">pthread_t</span> <span class="n">pthread</span> <span class="o">=</span> <span class="n">pthread_from_mach_thread_np</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
        <span class="n">pthread_getname_np</span><span class="p">(</span><span class="n">pthread</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">name</span><span class="p">);</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s">"mach thread %x: getname: %s"</span><span class="p">,</span> <span class="n">pthread_mach_thread_np</span><span class="p">(</span><span class="n">pthread</span><span class="p">),</span> <span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s">"-------------------"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç„¶åæˆ‘ä»¬æ¥å¹¶å‘ä¸‹è½½4å¼ å›¾ç‰‡ï¼Œå›¾ç‰‡å¤§å°åœ¨100kbå·¦å³ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Do any additional setup after loading the view, typically from a nib.</span>
   <span class="n">NSArray</span><span class="o">*</span> <span class="n">urls</span> <span class="o">=</span> <span class="p">@[</span><span class="s">@"http://www.collegedj.net/wp-content/uploads/2010/10/6.jpg"</span><span class="p">,</span>
                     <span class="s">@"http://www.collegedj.net/wp-content/uploads/2010/10/Rihanna.jpg"</span><span class="p">,</span>
                     <span class="s">@"http://www.collegedj.net/wp-content/uploads/2010/10/chris-brown.jpg"</span><span class="p">,</span>
                     <span class="s">@"http://www.collegedj.net/wp-content/uploads/2010/10/dj_scary.jpg"</span><span class="p">,</span>
                   <span class="p">];</span>
   <span class="n">_queue</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSOperationQueue</span> <span class="nf">new</span><span class="p">];</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">urls</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> 
   <span class="p">{</span>
       <span class="n">MXOperation</span><span class="o">*</span> <span class="n">operation</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MXOperation</span> <span class="nf">alloc</span><span class="p">]</span><span class="nf">initWithUrl</span><span class="p">:</span><span class="n">urls</span><span class="p">[</span><span class="nf">i</span><span class="p">]</span> <span class="nf">name</span><span class="p">:[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"%d"</span><span class="p">,</span><span class="n">i</span><span class="p">]];</span>
       <span class="p">[</span><span class="n">_queue</span> <span class="nf">addOperation</span><span class="p">:</span><span class="n">operation</span><span class="p">];</span>
   <span class="p">}</span>
    
</code></pre></div></div>
<p>è§‚å¯Ÿæ—¥å¿—è¾“å‡º:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">---------start----------</span>
<span class="nt">---------start----------</span>
<span class="nt">---------start----------</span>
<span class="nt">---------start----------</span>
current thread num: 1403 thread name:0
current thread num: 3307 thread name:1
current thread num: 3603 thread name:2
current thread num: 3703 thread name:3
<span class="nt">-------------------</span>
<span class="nt">-------------------</span>
<span class="nt">-------------------</span>
<span class="nt">-------------------</span>
<span class="nt">---------dealloc----------</span>
current thread num: 1403 thread name:0
mach thread a0b: getname: 
mach thread d03: getname: 
mach thread 1403: getname: 0
mach thread 3307: getname: 1
mach thread 3603: getname: 2
mach thread 3703: getname: 3
mach thread 3f03: getname: com.apple.NSURLConnectionLoader
mach thread 4007: getname: 
mach thread 4707: getname: 
mach thread 6203: getname: 
mach thread 6303: getname: com.apple.CFSocket.private
<span class="nt">-------------------</span>
<span class="nt">---------dealloc----------</span>
current thread num: 3307 thread name:1
mach thread a0b: getname: 
mach thread d03: getname: 
mach thread 1403: getname: 0
mach thread 3307: getname: 1
mach thread 3603: getname: 2
mach thread 3703: getname: 3
mach thread 3f03: getname: com.apple.NSURLConnectionLoader
mach thread 4007: getname: 
mach thread 4707: getname: 
mach thread 6203: getname: 
mach thread 6303: getname: com.apple.CFSocket.private
<span class="nt">-------------------</span>
<span class="nt">---------dealloc----------</span>
current thread num: 3603 thread name:2
mach thread a0b: getname: 
mach thread d03: getname: 
mach thread 1403: getname: 0
mach thread 3307: getname: 1
mach thread 3603: getname: 2
mach thread 3703: getname: 3
mach thread 3f03: getname: com.apple.NSURLConnectionLoader
mach thread 4007: getname: 
mach thread 4707: getname: 
mach thread 6203: getname: 
mach thread 6303: getname: com.apple.CFSocket.private
<span class="nt">-------------------</span>
<span class="nt">---------dealloc----------</span>
current thread num: 3703 thread name:3
mach thread a0b: getname: 
mach thread d03: getname: 
mach thread 1403: getname: 0
mach thread 3307: getname: 1
mach thread 3603: getname: 2
mach thread 3703: getname: 3
mach thread 3f03: getname: com.apple.NSURLConnectionLoader
mach thread 4007: getname: 
mach thread 4707: getname: 
mach thread 6203: getname: 
mach thread 6303: getname: com.apple.CFSocket.private
<span class="nt">-------------------</span>
</code></pre></div></div>

<p>æœ‰ç§çœ¼èŠ±ç¼­ä¹±çš„æ„Ÿè§‰ï¼Œé™ä¸‹å¿ƒæ…¢æ…¢çœ‹ï¼š</p>

<ol>
  <li>
    <p>æˆ‘ä»¬é¦–å…ˆå¹¶å‘äº†4ä¸ªçº¿ç¨‹ï¼š</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">---------start----------</span>
 current thread num: 1403 thread name:0
 <span class="nt">---------start----------</span>
 current thread num: 3307 thread name:1
 <span class="nt">---------start----------</span>
 current thread num: 3603 thread name:2
 <span class="nt">---------start----------</span>
 current thread num: 3703 thread name:3
</code></pre></div>    </div>
  </li>
</ol>

<p>çº¿ç¨‹<code class="highlighter-rouge">id</code>æ˜¯ç³»ç»Ÿåˆ†é…çš„ï¼Œçº¿ç¨‹åå­—æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ï¼Œç”¨<code class="highlighter-rouge">0-3</code>å»æ ‡è¯†</p>

<ol>
  <li>
    <p>ç„¶åï¼Œå›¾ç‰‡ä¸‹è½½å®Œæˆåï¼Œ<code class="highlighter-rouge">MXOperation</code>è¢«é‡Šæ”¾æ‰ï¼š</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">---------dealloc----------</span>
 current thread num: 1403 thread name:0
 mach thread a0b: getname: 
 mach thread d03: getname: 
 mach thread 1403: getname: 0
 mach thread 3307: getname: 1
 mach thread 3603: getname: 2
 mach thread 3703: getname: 3
 mach thread 3f03: getname: com.apple.NSURLConnectionLoader
 mach thread 4007: getname: 
 mach thread 4707: getname: 
 mach thread 6203: getname: 
 mach thread 6303: getname: com.apple.CFSocket.private
</code></pre></div>    </div>
  </li>
</ol>

<p>è¿™ä¸ªæ—¶å€™å¯ä»¥çœ‹åˆ°ï¼šå½“å‰çº¿ç¨‹<code class="highlighter-rouge">id</code>ä¸º<code class="highlighter-rouge">1403</code>ï¼Œæˆ‘ä»¬æ ‡è¯†å…¶ä¸º0å·ï¼ŒåŒæ—¶å­˜åœ¨çš„çº¿ç¨‹è¿˜æœ‰1ï¼Œ2ï¼Œ3å’Œä¸€äº›åŒ…æ‹¬ä¸»çº¿ç¨‹åœ¨å†…ï¼Œè·å–ä¸åˆ°åå­—çš„çº¿ç¨‹ã€‚ç„¶åæœ‰ä¸¤ä¸ªæ˜¯ç½‘ç»œè¯·æ±‚çš„çº¿ç¨‹ã€‚</p>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œç»“æœå¤åˆé¢„æœŸï¼Œæ²¡ä»€ç‰¹åˆ«çš„åœ°æ–¹ã€‚æ¥ç€æˆ‘ä»¬å†ä¸‹è½½ä¸¤å¼ å›¾ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NSArray</span><span class="o">*</span> <span class="n">urls</span> <span class="o">=</span> <span class="p">@[</span> <span class="s">@"http://www.collegedj.net/wp-content/uploads/2010/10/3-150x150.jpg"</span><span class="p">,</span>
                       <span class="s">@"http://www.collegedj.net/wp-content/uploads/2010/10/3-300x199.jpg"</span><span class="p">];</span>
    
 <span class="k">for</span> <span class="p">(</span><span class="n">NSString</span><span class="o">*</span> <span class="n">url</span> <span class="k">in</span> <span class="n">urls</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="n">MXOperation</span><span class="o">*</span> <span class="n">operation</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MXOperation</span> <span class="nf">alloc</span><span class="p">]</span><span class="nf">initWithUrl</span><span class="p">:</span><span class="n">url</span> <span class="nf">name</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
     <span class="p">[</span><span class="n">_queue</span> <span class="nf">addOperation</span><span class="p">:</span><span class="n">operation</span><span class="p">];</span>
 <span class="p">}</span>
</code></pre></div></div>
<p>æ³¨æ„ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰æŒ‡å®šå…¶nameï¼Œæˆ‘ä»¬è¦éªŒè¯thread idï¼Œè§‚å¯Ÿæ—¥å¿—è¾“å‡ºç»“æœï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--------again-----------</span>
<span class="nt">---------start----------</span>
<span class="nt">---------start----------</span>
current thread num: 1403 thread name:
current thread num: 3307 thread name:
<span class="nt">-------------------</span>
<span class="nt">-------------------</span>
<span class="nt">---------dealloc----------</span>
current thread num: 1403 thread name:
mach thread a0b: getname: 
mach thread d03: getname: 
mach thread 1403: getname: 
mach thread 3307: getname: 
mach thread 3603: getname: 2
mach thread 3703: getname: 3
mach thread 3f03: getname: com.apple.NSURLConnectionLoader
mach thread 4007: getname: 
mach thread 4707: getname: 
mach thread 6203: getname: 
mach thread 6303: getname: com.apple.CFSocket.private
mach thread 6903: getname: 
mach thread 6a03: getname: 
mach thread 6b03: getname: 
<span class="nt">-------------------</span>
<span class="nt">---------dealloc----------</span>
current thread num: 3307 thread name:
mach thread a0b: getname: 
mach thread d03: getname: 
mach thread 1403: getname: 
mach thread 3307: getname: 
mach thread 3603: getname: 2
mach thread 3703: getname: 3
mach thread 3f03: getname: com.apple.NSURLConnectionLoader
mach thread 4007: getname: 
mach thread 4707: getname: 
mach thread 6203: getname: 
mach thread 6303: getname: com.apple.CFSocket.private
mach thread 6903: getname: 
mach thread 6a03: getname: 
mach thread 6b03: getname: 
<span class="nt">-------------------</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å‘ç°é‡æ–°ä¸‹è½½çš„ä¸¤æ¡çº¿ç¨‹idåˆ†åˆ«ä¸ºï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">---------start----------</span>
current thread num: 1403 thread name:
<span class="nt">---------start----------</span>
current thread num: 3307 thread name:
</code></pre></div></div>

<p>è¿™è¯´æ˜NSOperationQueueçš„çº¿ç¨‹æ± èµ·äº†ä½œç”¨ï¼Œ1403å’Œ3307çº¿ç¨‹åœ¨ä¸‹è½½å®Œåï¼Œç‡å…ˆè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œæœ‰æ–°ä»»åŠ¡æ¥æ—¶ï¼Œä¸¤æ¡çº¿ç¨‹å†æ¬¡è¢«å”¤é†’ï¼Œè€Œä¸æ˜¯é‡æ–°å†èµ·çº¿ç¨‹ã€‚ä¸ºäº†éªŒè¯è¿™ä¸ªçš„åˆ¤æ–­ï¼Œæˆ‘ä»¬æ¥æ”¹ä¸€ä¸‹NSOperationQueueçš„å¹¶å‘æ•°ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_queue</span><span class="p">.</span><span class="n">maxConcurrentOperationCount</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

</code></pre></div></div>
<p>ç„¶åæˆ‘ä»¬ä¸‹è½½6å¼ å›¾ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NSArray</span><span class="o">*</span> <span class="n">urls</span> <span class="o">=</span> <span class="p">@[</span><span class="s">@"http://www.collegedj.net/wp-content/uploads/2010/10/1-150x150.jpg"</span><span class="p">,</span>
                      <span class="s">@"http://www.collegedj.net/wp-content/uploads/2010/10/Rihanna.jpg"</span><span class="p">,</span>
                      <span class="s">@"http://www.collegedj.net/wp-content/uploads/2010/10/chris-brown.jpg"</span><span class="p">,</span>
                      <span class="s">@"http://www.collegedj.net/wp-content/uploads/2010/10/dj_scary.jpg"</span><span class="p">,</span>
                      <span class="s">@"http://www.collegedj.net/wp-content/uploads/2010/10/3-150x150.jpg"</span><span class="p">,</span>
                      <span class="s">@"http://www.collegedj.net/wp-content/uploads/2010/10/3-300x199.jpg"</span>
                    <span class="p">];</span>
</code></pre></div></div>

<p>å†æ¬¡è§‚å¯Ÿæ—¥å¿—:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">---------start----------
---------start----------
---------start----------
</span><span class="p">current thread num: 1403 thread name:0
current thread num: 3307 thread name:1
current thread num: 3603 thread name:2
</span><span class="gd">-------------------
-------------------
-------------------
---------start----------
</span><span class="p">current thread num: 1403 thread name:3
</span><span class="gd">-------------------
---------start----------
</span><span class="p">current thread num: 3307 thread name:4
</span><span class="gd">-------------------
---------dealloc----------
---------start----------
</span><span class="p">current thread num: 3603 thread name:2
current thread num: 3d07 thread name:5
</span>
</code></pre></div></div>

<p>ç”±äºå¹¶å‘æ•°ä¸º3ï¼Œç‡å…ˆæœ‰3æ¡çº¿ç¨‹å¹¶å‘å‡ºå»ï¼Œç”±äº1403æœ€å…ˆå»ä¸‹è½½ï¼Œæˆ‘ä»¬ç‰¹æ„ä¸ºå…¶å®‰æ’ä¸€ä¸ª150x150çš„å°å›¾ï¼Œå…¶ä¸‹è½½å®Œæˆåï¼Œç«‹åˆ»å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç„¶åç¬¬4å¼ å›¾ç‰‡è¢«ä¸‹è½½ï¼Œ1403åˆè¢«å”¤é†’ï¼ŒåŒç†ï¼Œ3307ä¹Ÿæ˜¯ç›¸åŒçš„æƒ…å†µã€‚è€Œå½“ç¬¬6å¼ å›¾è¦å»ä¸‹è½½æ—¶ï¼Œæˆ‘ä»¬çœ‹åˆ°æ˜¯ä¸€æ¡æ–°çš„çº¿ç¨‹idä¸º3d07ï¼Œä¸åœ¨1403ï¼Œ3307ï¼Œ3603ä¹‹å†…ã€‚è¿™è¯´æ˜çº¿ç¨‹æ± å½“å‰æ²¡æœ‰å¯è°ƒåº¦çš„çº¿ç¨‹äº†ï¼Œåªå¥½åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ã€‚</p>

<p>æœ€åï¼Œæˆ‘ä»¬å›¾ç‰‡å…¨éƒ¨ä¸‹è½½å®Œï¼Œæ¸…ç©ºè¿™ä¸ªçº¿ç¨‹æ± ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">_queue</span> <span class="nf">cancelAllOperations</span><span class="p">];</span>
    <span class="n">_queue</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="n">dumpThreads</span><span class="p">(</span><span class="s">@"finish"</span><span class="p">);</span>
</code></pre></div></div>

<p>ç»“æœä¸ºï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------finish----------
current thread num: a0b thread name:
mach thread a0b: getname: 
mach thread d03: getname: 
mach thread 3c03: getname: com.apple.NSURLConnectionLoader
mach thread 5b03: getname: com.apple.CFSocket.private
-------------------
</code></pre></div></div>
<p>è¿™ä¸ªç»“æœä¹Ÿåœ¨æˆ‘ä»¬æ„æ–™ä¹‹ä¸­ï¼Œæ‰€æœ‰çº¿ç¨‹æ± åˆ›å»ºçš„çº¿ç¨‹å…¨è¢«é”€æ¯ï¼Œåªç•™ä¸‹ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œä¸€ä¸ªä¸çŸ¥é“åå­—çš„çº¿ç¨‹ï¼Œä¸¤ä¸ªç½‘ç»œè¯·æ±‚çš„çº¿ç¨‹ã€‚</p>

<h2 id="resource">Resource</h2>

<p>//é™„ï¼špthreadä»£ç ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ä½¿ç”¨ptrhead</span>
<span class="k">struct</span> <span class="n">threadInfo</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">url</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">threadResult</span> <span class="p">{</span>

    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">imageRawData</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span> <span class="n">imageLength</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="o">*</span> <span class="nf">downloadImage</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">threadInfo</span> <span class="k">const</span> <span class="o">*</span> <span class="k">const</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">threadInfo</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">url</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">url</span><span class="p">;</span>
 
    <span class="n">NSURL</span><span class="o">*</span> <span class="n">nsUrl</span>  <span class="o">=</span><span class="p">[</span> <span class="n">NSURL</span> <span class="n">URLWithString</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithUTF8String</span><span class="o">:</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">url</span><span class="p">]];</span>
    <span class="n">NSData</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSData</span> <span class="n">dataWithContentsOfURL</span><span class="o">:</span><span class="n">nsUrl</span><span class="p">];</span>
    
    <span class="k">struct</span> <span class="n">threadResult</span> <span class="o">*</span> <span class="k">const</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">threadResult</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">));</span>
    <span class="n">result</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">imageRawData</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">imageLength</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>â€¦</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">downloadImageWithPthread</span>
<span class="p">{</span>
    <span class="c1">//çº¿ç¨‹å‚æ•°ç»“æ„ä½“</span>
    <span class="k">struct</span> <span class="n">threadInfo</span> <span class="o">*</span> <span class="k">const</span> <span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">threadInfo</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">));</span>
    <span class="n">info</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">url</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">url1</span><span class="p">.</span><span class="n">UTF8String</span><span class="p">;</span>
    
    <span class="c1">//</span>
    <span class="n">pthread_t</span> <span class="n">tid</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">err_create</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">downloadImage</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
    <span class="n">NSCAssert</span><span class="p">(</span><span class="n">err_create</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">@"pthread_create() failed: %d"</span><span class="p">,</span> <span class="n">err_create</span><span class="p">);</span>
    
    <span class="c1">// Wait for the threads to exit:</span>
    <span class="k">struct</span> <span class="n">threadResult</span> <span class="o">*</span> <span class="n">results</span><span class="p">;</span>
    
    <span class="kt">int</span> <span class="n">err_join</span> <span class="o">=</span> <span class="n">pthread_join</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">results</span><span class="p">));</span>
    <span class="n">NSCAssert</span><span class="p">(</span><span class="n">err_join</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">@"pthread_join() failed: %d"</span><span class="p">,</span> <span class="n">err_join</span><span class="p">);</span>
    
    <span class="n">NSData</span><span class="o">*</span> <span class="n">imgData</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSData</span> <span class="nf">dataWithBytes</span><span class="p">:</span><span class="n">results</span><span class="o">-&amp;</span><span class="n">gt</span><span class="err">;</span><span class="n">imageRawData</span> <span class="nf">length</span><span class="p">:</span><span class="n">results</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">imageLength</span><span class="p">];</span>
    <span class="n">_imgv1</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nf">imageWithData</span><span class="p">:</span> <span class="n">imgData</span><span class="p">];</span>
  
    <span class="n">free</span><span class="p">(</span><span class="n">results</span><span class="p">);</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

:ET