I"}‡<p>ä»Šå¤©å¼€å§‹æˆ‘ä»¬æ¥è®¨è®ºä¸‹C/C++ç¨‹åºçš„é“¾æ¥ï¼ŒåŠ è½½å’Œæ‰§è¡Œï¼Œæˆ‘ä»¬å°†æŠŠé‡ç‚¹æ”¾åœ¨ç›®æ ‡æ–‡ä»¶çš„é“¾æ¥å’ŒåŠ è½½ä¸Šã€‚</p>

<p>ä¸€èˆ¬æ¥è¯´ï¼Œæºæ–‡ä»¶ç¼–è¯‘å®Œæˆåä¼šç”Ÿæˆ<code class="highlighter-rouge">.o</code>æ–‡ä»¶ï¼Œå¤šä¸ª<code class="highlighter-rouge">.o</code>æ–‡ä»¶å’Œä¸€äº›libï¼Œä¸€èµ·linkå¾—åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸‹é¢æ˜¯GCCçš„ä¸€äº›å¸¸ç”¨ç¼–è¯‘é€‰é¡¹ï¼Œæˆ‘ä»¬ç¨åä¼šç”¨åˆ°ï¼š</p>

<ul>
  <li><code class="highlighter-rouge">-c</code>: ç”¨æ¥ç”Ÿæˆ<code class="highlighter-rouge">.o</code>æ–‡ä»¶</li>
  <li><code class="highlighter-rouge">-o</code> : ç”¨æ¥åˆ›å»ºç›®æ ‡æ–‡ä»¶</li>
  <li><code class="highlighter-rouge">-g</code>: ç¼–è¯‘å™¨åœ¨è¾“å‡ºæ–‡ä»¶ä¸­åŒ…å«debugä¿¡æ¯ï¼Œäº§ç”ŸdSYMç¬¦å·è¡¨</li>
  <li><code class="highlighter-rouge">-Wall</code>:ç¼–è¯‘å™¨ç¼–è¯‘æ—¶æ‰“å‡ºwarningä¿¡æ¯,å¼ºçƒˆæ¨èä½¿ç”¨è¿™ä¸ªé€‰é¡¹ã€‚</li>
  <li><code class="highlighter-rouge">-I+dir</code>: é™¤äº†åœ¨main.cå½“å‰ç›®å½•å’Œç³»ç»Ÿé»˜è®¤ç›®å½•ä¸­å¯»æ‰¾.hå¤–ï¼Œè¿˜åœ¨dirç›®å½•å¯»æ‰¾ï¼Œæ³¨æ„ï¼Œdiræ˜¯ä¸€ä¸ªç»å¯¹è·¯å¾„ã€‚</li>
  <li><code class="highlighter-rouge">-01,-02,-03</code>: ç¼–è¯‘å™¨ä¼˜åŒ–ç¨‹åº¦</li>
</ul>

<blockquote>
  <p>å¦‚æœä½¿ç”¨macOSï¼Œgccå®é™…ä¸Šæ˜¯Clangçš„aliasï¼Œbinaryçš„ç»“æ„ä¸ºMach-Oï¼Œè€Œä¸æ˜¯UNIXçš„ELFæ ¼å¼ï¼Œä¸è¿‡è¿™å¹¶ä¸å½±å“ç†è§£æœ¬æ–‡çš„å†…å®¹</p>
</blockquote>

<h2 id="object-files">Object Files</h2>

<p>æˆ‘ä»¬å…ˆä»æœ€åŸºæœ¬çš„ç›®æ ‡æ–‡ä»¶å¼€å§‹åˆ†æï¼Œç°åœ¨å‡è®¾æˆ‘ä»¬æœ‰ä¸‰ä¸ªæ–‡ä»¶:<code class="highlighter-rouge">function.h</code>,<code class="highlighter-rouge">function.m</code>å’Œ<code class="highlighter-rouge">main.c</code>ï¼Œä»£ç å¦‚ä¸‹</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//function.h</span>
<span class="cp">#define FIRST_OPTION
#ifdef FIRST_OPTION
#define MULTIPLIER (3.0)
#else
#define MULTIPLIER (2.0)
#endif
</span>
<span class="kt">float</span> <span class="nf">add_and_multiply</span><span class="p">(</span><span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="kt">float</span> <span class="n">y</span><span class="p">);</span>

<span class="c1">//function.c</span>
<span class="cp">#include "function.h"
</span>
<span class="kt">int</span> <span class="n">nCompletionStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">float</span> <span class="nf">add</span><span class="p">(</span><span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="kt">float</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float</span> <span class="n">z</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">z</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">float</span> <span class="nf">add_and_multiply</span><span class="p">(</span><span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="kt">float</span> <span class="n">y</span><span class="p">){</span>
    <span class="kt">float</span> <span class="n">z</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
    <span class="n">z</span> <span class="o">*=</span> <span class="n">MULTIPLIER</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">z</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//main.c</span>
<span class="cp">#include "function.h"
</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">nCompletionStatus</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">float</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">z</span><span class="p">;</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">add_and_multiply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
    <span class="n">nCompletionStatus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ä¸ºäº†ç”Ÿæˆç›®æ ‡æ–‡ä»¶<code class="highlighter-rouge">.o</code>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨gccå¯¹ä¸Šè¿°æºç è¿›è¡Œç¼–è¯‘</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc <span class="nt">-c</span> <span class="k">function</span>.c
gcc <span class="nt">-c</span> main.c
</code></pre></div></div>
<p>æ‰§è¡Œä¸Šé¢ä¸¤è¡Œå‘½ä»¤åï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°<code class="highlighter-rouge">funtion.o</code>å’Œ<code class="highlighter-rouge">main.o</code>ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç®€å•çš„åˆ†æä¸€ä¸‹ç›®æ ‡æ–‡ä»¶çš„æ ¼å¼ä»¥åŠé‡Œé¢æ‰€åŒ…å«çš„å†…å®¹ï¼Œåœ¨UNIXç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å·¥å…·å¸®åŠ©æˆ‘ä»¬åˆ†æ</p>

<ul>
  <li><strong>nm</strong>: æ˜¾ç¤ºç›®æ ‡æ–‡ä»¶ä¸­çš„symbolåˆ—è¡¨</li>
  <li><strong>objdump</strong>: æä¾›äº†ä¸€ç³»åˆ—é€‰é¡¹å¯ä»¥æœ€ç›®æ ‡æ–‡ä»¶åšæ¯”è¾ƒè¯¦ç»†çš„åˆ†æï¼Œæ¯”å¦‚<code class="highlighter-rouge">-S</code>é€‰é¡¹å¯ä»¥dumpå‡ºæ±‡ç¼–ä»£ç </li>
  <li><strong>readelf</strong>: è¯»å–å¹¶æ˜¾ç¤ºELFæ ¼å¼æ–‡ä»¶çš„ä¿¡æ¯</li>
</ul>

<p>ä»¥<code class="highlighter-rouge">function.o</code>ä¸ºä¾‹ï¼Œä½¿ç”¨<code class="highlighter-rouge">readelf -a function.o</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>readelf <span class="nt">-a</span> <span class="k">function</span>.o
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF64
  Data:                              2<span class="s1">'s complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              REL (Relocatable file)
  Machine:                           Advanced Micro Devices X86-64
  Version:                           0x1
  Entry point address:               0x0
  Start of program headers:          0 (bytes into file)
  Start of section headers:          808 (bytes into file)
  Flags:                             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           0 (bytes)
  Number of program headers:         0
  Size of section headers:           64 (bytes)
  Number of section headers:         12
  Section header string table index: 9

Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  [ 0]                   NULL             0000000000000000  00000000
       0000000000000000  0000000000000000           0     0     0
  [ 1] .text             PROGBITS         0000000000000000  00000040
       000000000000006a  0000000000000000  AX       0     0     1
  [ 2] .rela.text        RELA             0000000000000000  00000280
       0000000000000018  0000000000000018   I      10     1     8
  [ 3] .data             PROGBITS         0000000000000000  000000aa
       0000000000000000  0000000000000000  WA       0     0     1
  [ 4] .bss              NOBITS           0000000000000000  000000ac
       0000000000000004  0000000000000000  WA       0     0     4
  [ 5] .comment          PROGBITS         0000000000000000  000000ac
       0000000000000036  0000000000000001  MS       0     0     1
  [ 6] .note.GNU-stack   PROGBITS         0000000000000000  000000e2
       0000000000000000  0000000000000000           0     0     1
  [ 7] .eh_frame         PROGBITS         0000000000000000  000000e8
       0000000000000058  0000000000000000   A       0     0     8
  [ 8] .rela.eh_frame    RELA             0000000000000000  00000298
       0000000000000030  0000000000000018   I      10     7     8
  [ 9] .shstrtab         STRTAB           0000000000000000  000002c8
       0000000000000059  0000000000000000           0     0     1
  [10] .symtab           SYMTAB           0000000000000000  00000140
       0000000000000108  0000000000000018          11     8     8
  [11] .strtab           STRTAB           0000000000000000  00000248
       0000000000000033  0000000000000000           0     0     1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), l (large)
  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)

There are no section groups in this file.

There are no program headers in this file.

Relocation section '</span>.rela.text<span class="s1">' at offset 0x280 contains 1 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
00000000004a  000900000002 R_X86_64_PC32     0000000000000000 add - 4

Relocation section '</span>.rela.eh_frame<span class="s1">' at offset 0x298 contains 2 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000020  000200000002 R_X86_64_PC32     0000000000000000 .text + 0
000000000040  000200000002 R_X86_64_PC32     0000000000000000 .text + 24

The decoding of unwind sections for machine type Advanced Micro Devices X86-64 is not currently supported.

Symbol table '</span>.symtab<span class="s1">' contains 11 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS function.c
     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1
     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3
     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    6
     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    7
     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    5
     8: 0000000000000000     4 OBJECT  GLOBAL DEFAULT    4 nCompletionStatus
     9: 0000000000000000    36 FUNC    GLOBAL DEFAULT    1 add
    10: 0000000000000024    70 FUNC    GLOBAL DEFAULT    1 add_and_multiply
</span></code></pre></div></div>

<p>ä¸Šè¿°å‘½ä»¤ç»™å‡ºäº†<code class="highlighter-rouge">function.o</code>ä¸­ä¸€äº›æ¯”è¾ƒå…³é”®çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ç¬¬ä¸€æ®µçš„æ–‡ä»¶æè¿°ï¼Œç¬¬äºŒæ®µçš„section headerä¿¡æ¯ï¼Œä»¥åŠåé¢çš„é‡å®šä½è¡¨å’Œç¬¦å·è¡¨ç­‰ç­‰ã€‚å¦‚æœæˆ‘ä»¬åªè¦åˆ†ælinkerå’Œloaderï¼Œé‚£ä¹ˆæˆ‘ä»¬æš‚æ—¶ä¸éœ€è¦ç†è§£å…¨éƒ¨çš„å†…å®¹ï¼Œä½†æ˜¯éœ€è¦ç‰¹åˆ«å…³æ³¨ä¸€äº›é‡è¦çš„sectionã€‚å®é™…ä¸Šå¯¹äºæ¯ä¸ªsectionï¼Œå®ƒä»¬éƒ½æ˜¯ä¸€ä¸ªæœ‰èµ·å§‹å®åœ°å€å’Œå›ºå®šé•¿åº¦æ„æˆçš„ä¸€æ®µè¿ç»­ç©ºé—´ã€‚å…¶ä¸­ï¼Œæœ‰å››ä¸ªsectionéœ€è¦ç‰¹åˆ«å…³æ³¨</p>

<ol>
  <li><code class="highlighter-rouge">.text</code>æ®µï¼Œä¹Ÿå«ä»£ç æ®µï¼Œç”¨æ¥å­˜æ”¾æ±‡ç¼–æŒ‡ä»¤</li>
  <li><code class="highlighter-rouge">.data</code>æ®µï¼Œä¹Ÿå«æ•°æ®æ®µï¼Œç”¨æ¥ä¿å­˜ç¨‹åºé‡Œè®¾ç½®å¥½çš„åˆå§‹åŒ–æ•°æ®ä¿¡æ¯</li>
  <li><code class="highlighter-rouge">.rela.text</code>æ®µï¼Œå«åšé‡å®šä½è¡¨(Relocation Table)ã€‚åœ¨è¡¨é‡Œï¼Œä¿å­˜äº†æ‰€æœ‰æœªçŸ¥è·³è½¬çš„æŒ‡ä»¤</li>
  <li><code class="highlighter-rouge">.symtab</code>æ®µï¼Œä¹Ÿå«åšç¬¦å·è¡¨ï¼Œç”¨æ¥å­˜æ”¾å½“å‰æ–‡ä»¶é‡Œå®šä¹‰çš„å‡½æ•°å’Œå¯¹åº”çš„åœ°å€</li>
</ol>

<h2 id="linkers">Linkers</h2>

<p>åœ¨æœ‰äº†ç¼–è¯‘ç”Ÿæˆçš„<code class="highlighter-rouge">.o</code>æ–‡ä»¶åï¼ŒLinkerè¦åšçš„äº‹æƒ…å°±æ˜¯å°†è¿™äº›æ–‡ä»¶linkåœ¨ä¸€èµ·ï¼Œå…·ä½“æ¥è¯´è¿‡ç¨‹å¦‚ä¸‹ï¼Œlinkerä¼šæ‰«ææ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶ï¼Œå°†æ‰€æœ‰ç¬¦å·è¡¨ä¸­çš„ä¿¡æ¯æ”¶é›†èµ·æ¥ï¼Œæ„æˆä¸€ä¸ªå…¨å±€çš„ç¬¦å·è¡¨ï¼Œç„¶åå†æ ¹æ®é‡å®šä½è¡¨ï¼ŒæŠŠæ‰€æœ‰ä¸ç¡®å®šçš„è·³è½¬æŒ‡ä»¤æ ¹æ®ç¬¦å·è¡¨é‡Œåœ°å€ï¼Œè¿›è¡Œä¸€æ¬¡ä¿®æ­£ã€‚æœ€åï¼ŒæŠŠæ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶çš„sectionåˆ†åˆ«è¿›è¡Œåˆå¹¶ï¼Œå½¢æˆæœ€ç»ˆçš„å¯æ‰§è¡Œä»£ç ã€‚å¯¹äºå‰é¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªç›®æ ‡æ–‡ä»¶ï¼Œlinkerçš„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º</p>

<p><img class="md-img-center" src="/assets/images/2015/01/linker.png" /></p>

<p>å¦‚æœå°†ä¸Šè¿°æ­¥éª¤åˆ†è§£å¼€æ¥ï¼Œåˆ™linkerçš„æ‰§è¡Œæ­¥éª¤å¯å¤§è‡´åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šç¬¦å·è§£æ(Symbol Resolution)å’Œåœ°å€ç»‘å®š(Relocation)</p>

<h3 id="ç¬¦å·è§£æsymbol-resolution">ç¬¦å·è§£æï¼ˆSymbol Resolutionï¼‰</h3>

<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‰é¢æåˆ°çš„<code class="highlighter-rouge">nm</code>å‘½ä»¤æ¥å¿«é€Ÿçœ‹ä¸€ä¸‹<code class="highlighter-rouge">function.o</code>å’Œ<code class="highlighter-rouge">main.o</code>ä¸­éƒ½æœ‰å“ªäº›symbol</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#function.o</span>
0000000000000000    T add
0000000000000024    T add_and_multiply
0000000000000000    B nCompletionStatus

<span class="c">#main.o</span>
                    U add_and_multiply
0000000000000000    T main
                    U nCompletionStatus
</code></pre></div></div>

<p>é€šè¿‡è§‚å¯Ÿä¸Šé¢çš„ç¬¦å·è¡¨ï¼Œå¯ä»¥å‘ç°</p>

<ol>
  <li>
    <p>æ¯ä¸ªç¬¦å·éƒ½æœ‰è‡ªå·±çš„ç±»å‹ã€‚æ¯”å¦‚åœ¨<code class="highlighter-rouge">main.o</code>ä¸­ï¼Œç”±äº<code class="highlighter-rouge">add_and_multiply</code>æ˜¯å®šä¹‰åœ¨å¦ä¸€ä¸ªç›®æ ‡æ–‡ä»¶ä¸­ï¼Œå› æ­¤å¯¹äº<code class="highlighter-rouge">main.o</code>æ¥è¯´ï¼Œç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“è¿™ä¸ªç¬¦å·åœ¨å“ªé‡Œï¼Œå› æ­¤ç”¨<code class="highlighter-rouge">U</code>è¡¨ç¤ºã€‚<code class="highlighter-rouge">nCompletionStatus</code>åŒç†ã€‚è€Œå¯¹äº<code class="highlighter-rouge">function.o</code>æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å°±å®šä¹‰åœ¨è‡ªèº«çš„ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œç¼–è¯‘å™¨æ˜¯çŸ¥é“å®ƒä»¬çš„ä½ç½®çš„ï¼Œå› æ­¤ç”¨<code class="highlighter-rouge">T</code>å’Œ<code class="highlighter-rouge">B</code>è¡¨ç¤ºã€‚æ›´å¤šå…³äºç¬¦å·çš„å«ä¹‰å¯å‚è€ƒæ–‡æœ«çš„é™„å½•ã€‚</p>
  </li>
  <li>
    <p>æ¯ä¸ªç¬¦å·éƒ½æœ‰è‡ªå·±çš„åœ°å€ã€‚å®ƒä»¬çš„åœ°å€éƒ½æ˜¯ç›¸å¯¹çš„éƒ½æ˜¯ç›¸å¯¹äºè¯¥ç›®æ ‡æ–‡ä»¶çš„åç§»ï¼Œå¹¶ä¸æ˜¯è™šæ‹Ÿå†…å­˜ä¸­çš„åœ°å€ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è§‚å¯Ÿæ±‡ç¼–ä»£ç æ¥è¿›ä¸€æ­¥éªŒè¯ï¼Œä½¿ç”¨ <code class="highlighter-rouge">objdump -d function.o</code>å¾—åˆ°<code class="highlighter-rouge">function.o</code>çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹</p>
  </li>
</ol>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Disassembly of section .text:

0000000000000000 &lt;add&gt;:
   0:	55                   	push   %rbp
   1:	48 89 e5             	mov    %rsp,%rbp
   4:	f3 0f 11 45 ec       	movss  %xmm0,-0x14<span class="o">(</span>%rbp<span class="o">)</span>
   9:	f3 0f 11 4d e8       	movss  %xmm1,-0x18<span class="o">(</span>%rbp<span class="o">)</span>
   e:	f3 0f 10 45 ec       	movss  <span class="nt">-0x14</span><span class="o">(</span>%rbp<span class="o">)</span>,%xmm0
  13:	f3 0f 58 45 e8       	addss  <span class="nt">-0x18</span><span class="o">(</span>%rbp<span class="o">)</span>,%xmm0
  18:	f3 0f 11 45 <span class="nb">fc       	</span>movss  %xmm0,-0x4<span class="o">(</span>%rbp<span class="o">)</span>
  1d:	f3 0f 10 45 <span class="nb">fc       	</span>movss  <span class="nt">-0x4</span><span class="o">(</span>%rbp<span class="o">)</span>,%xmm0
  22:	5d                   	pop    %rbp
  23:	c3                   	retq

0000000000000024 &lt;add_and_multiply&gt;:
  24:	55                   	push   %rbp
  25:	48 89 e5             	mov    %rsp,%rbp
  28:	48 83 ec 20          	sub    <span class="nv">$0x20</span>,%rsp
  2c:	f3 0f 11 45 ec       	movss  %xmm0,-0x14<span class="o">(</span>%rbp<span class="o">)</span>
  31:	f3 0f 11 4d e8       	movss  %xmm1,-0x18<span class="o">(</span>%rbp<span class="o">)</span>
  36:	f3 0f 10 45 e8       	movss  <span class="nt">-0x18</span><span class="o">(</span>%rbp<span class="o">)</span>,%xmm0
  3b:	8b 45 ec             	mov    <span class="nt">-0x14</span><span class="o">(</span>%rbp<span class="o">)</span>,%eax
  3e:	0f 28 c8             	movaps %xmm0,%xmm1
  41:	89 45 e4             	mov    %eax,-0x1c<span class="o">(</span>%rbp<span class="o">)</span>
  44:	f3 0f 10 45 e4       	movss  <span class="nt">-0x1c</span><span class="o">(</span>%rbp<span class="o">)</span>,%xmm0
  49:	e8 00 00 00 00       	callq  4e &lt;add_and_multiply+0x2a&gt;
  4e:	66 0f 7e c0          	movd   %xmm0,%eax
  52:	89 45 <span class="nb">fc             	</span>mov    %eax,-0x4<span class="o">(</span>%rbp<span class="o">)</span>
  55:	f3 0f 10 45 <span class="nb">fc       	</span>movss  <span class="nt">-0x4</span><span class="o">(</span>%rbp<span class="o">)</span>,%xmm0
  5a:	f3 0f 58 c0          	addss  %xmm0,%xmm0
  5e:	f3 0f 11 45 <span class="nb">fc       	</span>movss  %xmm0,-0x4<span class="o">(</span>%rbp<span class="o">)</span>
  63:	f3 0f 10 45 <span class="nb">fc       	</span>movss  <span class="nt">-0x4</span><span class="o">(</span>%rbp<span class="o">)</span>,%xmm0
  68:	c9                   	leaveq
  69:	c3                   	retq
</code></pre></div></div>

<p>å› æ­¤å¯ä»¥çŒœæƒ³ï¼Œlinkeræ¥ä¸‹æ¥è¦åšçš„äº‹æƒ…å°±æ˜¯å°†æ‰€æœ‰<code class="highlighter-rouge">Undefined</code>ç¬¦å·è¿›è¡Œåœ°å€ç»‘å®šï¼ˆåŠ¨æ€åº“ä¸­çš„ç¬¦å·æš‚ä¸è€ƒè™‘ï¼‰ä»¥åŠç®—å‡ºæ¯ä¸ªç¬¦å·åœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„çœŸå®åœ°å€</p>

<h3 id="relocation">Relocation</h3>

<p>Sectionçš„Relocationå¾ˆç®€å•ï¼Œå°±æ˜¯å°†æ‰€æœ‰ç›®æ ‡æ–‡ä»¶çš„å„ä¸ªæ®µæŒ‰ç…§æŸç§è§„åˆ™è¿›è¡Œåˆå¹¶ï¼Œæ¯”å¦‚ä¸Šé¢å›¾ä¸­çš„ï¼Œtextæ®µåˆå¹¶ï¼Œç¬¦å·è¡¨åˆå¹¶ç­‰ç­‰ã€‚åœ¨åˆå¹¶çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦è®¡ç®—æ¯ä¸ªæ®µåœ¨å®é™…è™šæ‹Ÿå†…å­˜ä¸­çš„åœ°å€ï¼Œæ¯”å¦‚å‰é¢æåˆ°çš„<code class="highlighter-rouge">main.o</code>ä¸­çš„<code class="highlighter-rouge">main</code>ç¬¦å·çš„åœ°å€ä¸º<code class="highlighter-rouge">0x0000000000000000</code>ï¼Œ<code class="highlighter-rouge">function.o</code>ä¸­<code class="highlighter-rouge">add</code>åœ°å€ä¹Ÿä¸º<code class="highlighter-rouge">0x0000000000000000</code>ã€‚æ˜¾ç„¶ï¼Œåœ¨å®é™…çš„å†…å­˜ä¸­ï¼Œä¸ç®¡æ˜¯<code class="highlighter-rouge">add</code>è¿˜æ˜¯<code class="highlighter-rouge">main</code>çš„åœ°å€æ˜¯ä¸å¯èƒ½ä¸º<code class="highlighter-rouge">0x0000000000000000</code>çš„ã€‚è¿™æ—¶å€™å°±éœ€è¦Relocationå‘æŒ¥ä½œç”¨ï¼Œå°†æ‰€æœ‰sectionçš„åœ°å€é‡æ–°åˆ†é…åˆ°åˆç†çš„ä½ç½®ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨åˆ†é…çš„è¿‡ç¨‹ä¸­è¦ä¿è¯æ¯ä¸ªSectionçš„è¿ç»­æ€§ä¸è¢«ç ´åï¼Œå› æ­¤linkeræ˜¯éœ€è¦çŸ¥é“æ¯ä¸ªsectionçš„å¤§å°å’ŒèŒƒå›´ã€‚</p>

<p><img class="md-img-center" src="/assets/images/2009/05/c-compile-1.png" /></p>

<p>ä¸‹é¢æˆ‘ä»¬æ¥é€šè¿‡è§‚å¯Ÿæ±‡ç¼–ä»£ç æ¥å…·ä½“çœ‹ä¸€ä¸‹æ˜¯ä¸Šè¿°è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨<code class="highlighter-rouge">objdump</code>å‘½ä»¤æ¥åæ±‡ç¼–ç›®æ ‡æ–‡ä»¶</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>objdump <span class="nt">-d</span> <span class="nt">-S</span> main.o

main.o:     file format elf64-x86-64
Disassembly of section .text:
0000000000000000 main:
0:	55                   	push   rbp
1:	48 89 e5             	mov    rbp,rsp
4:	48 83 ec 20          	sub    rsp,0x20
8:	f3 0f 10 05 00 00 00 	movss  xmm0,DWORD PTR <span class="o">[</span>rip+0x0]        <span class="c"># 10 &lt;main+0x10&gt;</span>
f:	00
10:	f3 0f 11 45 f4       	movss  DWORD PTR <span class="o">[</span>rbp-0xc],xmm0
15:	f3 0f 10 05 00 00 00 	movss  xmm0,DWORD PTR <span class="o">[</span>rip+0x0]        <span class="c"># 1d &lt;main+0x1d&gt;</span>
1c:	00
1d:	f3 0f 11 45 f8       	movss  DWORD PTR <span class="o">[</span>rbp-0x8],xmm0
22:	f3 0f 10 45 f8       	movss  xmm0,DWORD PTR <span class="o">[</span>rbp-0x8]
27:	8b 45 f4             	mov    eax,DWORD PTR <span class="o">[</span>rbp-0xc]
2a:	0f 28 c8             	movaps xmm1,xmm0
2d:	89 45 ec             	mov    DWORD PTR <span class="o">[</span>rbp-0x14],eax
30:	f3 0f 10 45 ec       	movss  xmm0,DWORD PTR <span class="o">[</span>rbp-0x14]
35:	e8 00 00 00 00       	call   3a &lt;main+0x3a&gt;
3a:	66 0f 7e c0          	movd   eax,xmm0
3e:	89 45 <span class="nb">fc             	</span>mov    DWORD PTR <span class="o">[</span>rbp-0x4],eax
41:	c7 05 00 00 00 00 01 	mov    DWORD PTR <span class="o">[</span>rip+0x0],0x1        <span class="c"># 4b &lt;main+0x4b&gt;</span>
48:	00 00 00
4b:	b8 00 00 00 00       	mov    eax,0x0
50:	c9                   	leave
51:	c3                   	ret
</code></pre></div></div>
<p>ä¸Šè¿°æ˜¯<code class="highlighter-rouge">main</code>å‡½æ•°çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œæˆ‘ä»¬å‘ç°åœ¨ç¬¬#35è¡Œï¼Œæœ‰ä¸€ä¸ª<code class="highlighter-rouge">call</code>çš„æŒ‡ä»¤ï¼Œå‚è€ƒ<code class="highlighter-rouge">main</code>å‡½æ•°çš„æºç å¯çŸ¥ï¼Œè¿™ä¸ªæŒ‡ä»¤æ˜¯ç”¨æ¥è°ƒç”¨<code class="highlighter-rouge">add_and_multiply</code>å‡½æ•°çš„ï¼Œä½†æ˜¯ç”±äºè¿™ä¸ª<code class="highlighter-rouge">.o</code>ä¸­<code class="highlighter-rouge">_add_and_multiply</code>ç¬¦å·æœªçŸ¥ï¼Œ<code class="highlighter-rouge">call</code>å˜æˆè°ƒç”¨è‡ªå·±ï¼Œæ˜¾ç„¶æ˜¯ä¸æ­£ç¡®çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥çŒœæƒ³åœ¨æœ€ç»ˆçš„binaryä¸­ï¼Œè¿™è¡ŒæŒ‡ä»¤åº”è¯¥ä¼šå‘ç”Ÿå˜åŒ–ï¼Œlinkerä¼šå¯¹ç¬¦å·è¿›è¡Œè§£æå’Œåœ°å€ç»‘å®šã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$gcc</span> <span class="k">function</span>.c mian.c <span class="nt">-o</span> demoApp
<span class="nv">$objdump</span> <span class="nt">-D</span> demoApp

0000000000400540 main:
  400540:	55                   	push   rbp
  400541:	48 89 e5             	mov    rbp,rsp
  400544:	48 83 ec 20          	sub    rsp,0x20
  400548:	f3 0f 10 05 d4 00 00 	movss  xmm0,DWORD PTR <span class="o">[</span>rip+0xd4]        <span class="c"># 400624 &lt;_IO_stdin_used+0x4&gt;</span>
  40054f:	00
  400550:	f3 0f 11 45 f4       	movss  DWORD PTR <span class="o">[</span>rbp-0xc],xmm0
  400555:	f3 0f 10 05 cb 00 00 	movss  xmm0,DWORD PTR <span class="o">[</span>rip+0xcb]        <span class="c"># 400628 &lt;_IO_stdin_used+0x8&gt;</span>
  40055c:	00
  40055d:	f3 0f 11 45 f8       	movss  DWORD PTR <span class="o">[</span>rbp-0x8],xmm0
  400562:	f3 0f 10 45 f8       	movss  xmm0,DWORD PTR <span class="o">[</span>rbp-0x8]
  400567:	8b 45 f4             	mov    eax,DWORD PTR <span class="o">[</span>rbp-0xc]
  40056a:	0f 28 c8             	movaps xmm1,xmm0
  40056d:	89 45 ec             	mov    DWORD PTR <span class="o">[</span>rbp-0x14],eax
  400570:	f3 0f 10 45 ec       	movss  xmm0,DWORD PTR <span class="o">[</span>rbp-0x14]
  400575:	e8 80 ff ff ff       	call   4004fa add_and_multiply
  40057a:	66 0f 7e c0          	movd   eax,xmm0
  40057e:	89 45 <span class="nb">fc             	</span>mov    DWORD PTR <span class="o">[</span>rbp-0x4],eax
  400581:	c7 05 a9 0a 20 00 01 	mov    DWORD PTR <span class="o">[</span>rip+0x200aa9],0x1        <span class="c"># 601034 &lt;nCompletionStatus&gt;</span>
  400588:	00 00 00
  40058b:	b8 00 00 00 00       	mov    eax,0x0
  400590:	c9                   	leave
  400591:	c3                   	ret
  400592:	66 2e 0f 1f 84 00 00 	nop    WORD PTR cs:[rax+rax<span class="k">*</span>1+0x0]
  400599:	00 00 00
  40059c:	0f 1f 40 00          	nop    DWORD PTR <span class="o">[</span>rax+0x0]
</code></pre></div></div>
<p>å¯¹æ¯”ä¸¤æ®µæ±‡ç¼–ä»£ç ï¼Œä¸éš¾å‘ç°ï¼Œå‰è€…çš„BaseAddressæ˜¯<code class="highlighter-rouge">0000000000000000</code>ï¼Œæ¯æ¡æ±‡ç¼–æŒ‡ä»¤å‰é¢çš„æ•°å­—æ˜¯è¯¥æŒ‡ä»¤çš„offsetã€‚è€Œåè€…çš„BaseAddreesså˜æˆäº†<code class="highlighter-rouge">0000000000400540</code>ï¼Œè¯´æ˜Linkerå¯¹æ¯ä¸ªç›®æ ‡æ–‡ä»¶çš„æ±‡ç¼–æŒ‡ä»¤åšäº†åœ°å€ä¿®æ­£ï¼Œå¦å¤–ï¼Œ<code class="highlighter-rouge">call</code>æŒ‡ä»¤åçš„ç¬¦å·å˜æˆäº†æˆ‘ä»¬æœŸæœ›çš„å‡½æ•°ç¬¦å·<code class="highlighter-rouge">add_and_multiply</code>ï¼Œåœ°å€ä¸º<code class="highlighter-rouge">4004fa</code>ã€‚è¯´æ˜Linkerå®Œæˆçš„ç¬¦å·å’Œåœ°å€çš„ç»‘å®šã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00000000004004fa &lt;add_and_multiply&gt;:
4004fa:	55                   	push   rbp
4004fb:	48 89 e5             	mov    rbp,rsp
...
40051a:	f3 0f 10 45 e4       	movss  xmm0,DWORD PTR <span class="o">[</span>rbp-0x1c]
40051f:	e8 b2 ff ff ff       	call   4004d6 &lt;add&gt;
400524:	66 0f 7e c0          	movd   eax,xmm0
...
40053e:	c9                   	leave
40053f:	c3                   	ret
</code></pre></div></div>

<p>å¦ä¸€å…³äºCode Modificationæ¯”è¾ƒå¥½çš„ä¾‹å­æ˜¯<strong>Linkers and loaders</strong>è¿™æœ¬ä¹¦ä¸­çš„ä¾‹å­ï¼Œå‡è®¾æŸä¸ªç›®æ ‡æ–‡ä»¶åœ¨ç¼–è¯‘å®Œåæœ‰ä¸‹é¢x86çš„ä¸€æ®µæ±‡ç¼–ä»£ç </p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A1 34 12 00 00 mov a, %eax
A3 00 00 00 00 mov %eax, b
</code></pre></div></div>
<p>è¿™ä¸¤è¡Œä»£ç çš„æ„æ€æ˜¯å°†<code class="highlighter-rouge">a</code>ä¸­çš„å€¼é€šè¿‡å¯„å­˜å™¨èµ‹å€¼ç»™<code class="highlighter-rouge">b</code>ã€‚å…¶ä¸­æ¯è¡ŒæŒ‡ä»¤ç”±ä¸€ä¸ªopcode + 4å­—èŠ‚çš„åœ°å€ç»„æˆï¼Œç”±äº<code class="highlighter-rouge">a</code>ä½äºè¯¥ç›®æ ‡æ–‡ä»¶å†…ï¼Œåœ°å€ä¸º<code class="highlighter-rouge">0x1234</code>ï¼Œç”±äºx86ä½¿ç”¨çš„æ˜¯right-to-left orderï¼Œå› æ­¤<code class="highlighter-rouge">a</code>çš„åœ°å€è¡¨ç¤ºä¸º<code class="highlighter-rouge">34 12 00 00</code>ã€‚<code class="highlighter-rouge">b</code>æ˜¯ä¸€ä¸ªimportè¿›æ¥çš„å˜é‡ï¼Œåœ¨ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“<code class="highlighter-rouge">b</code>åœ¨å“ªé‡Œï¼Œå› æ­¤åœ°å€ä¸º<code class="highlighter-rouge">00 00 00 00 </code>ã€‚</p>

<p>å½“linkå®Œæˆåï¼Œå‡è®¾<code class="highlighter-rouge">a</code>æ‰€åœ¨çš„textæ®µçš„åç§»é‡ä¸º<code class="highlighter-rouge">0x1000</code>ï¼Œå› æ­¤<code class="highlighter-rouge">a</code>çš„åœ°å€å˜æˆäº†<code class="highlighter-rouge">0x11234</code>è€Œ<code class="highlighter-rouge">b</code>æ‰€åœ¨çš„åœ°å€ä¸º<code class="highlighter-rouge">0x9A12</code>ï¼Œåˆ™ä¸Šè¿°ä¸¤æ¡æŒ‡ä»¤ä¼šè¢«linkeræ”¹å†™ä¸º</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A1 34 12 10 00 mov a, %eax
A3 12 9A 00 00 mov %eax, b
</code></pre></div></div>

<p>å½“Relocationå®Œæˆåï¼Œæ¯ä¸ªsectionå’Œsymbolçš„è™šæ‹Ÿå†…å­˜åœ°å€ä¹Ÿå°±ç¡®å®šäº†ï¼Œè‡³æ­¤linkerçš„ä»»åŠ¡ä¹Ÿå°±å®Œæˆäº†ã€‚</p>

<h2 id="loaders">Loaders</h2>

<p>ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªlinkå¥½çš„binaryæ–‡ä»¶äº†ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œå®ƒçš„æ—¶å€™ï¼ŒLoaderä¼šå°†binaryä¸­çš„sectionæŒ‰ç…§ä¸€å®šè§„åˆ™åŠ è½½åˆ°å†…å­˜ä¸­ã€‚å®é™…ä¸ŠLoaderçš„å·¥ä½œå°±è¿™ä¹ˆç®€å•ï¼Œä½†æ˜¯æ‰€è°“çš„â€œä¸€å®šè§„åˆ™â€ç¡®åˆå¾ˆå¤æ‚ï¼Œå…·ä½“æ¥è¯´Loaderé¢ä¸´çš„æŒ‘æˆ˜ä¸»è¦æ˜¯å¦‚ä½•ä¸ºæ¯ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ‰¾åˆ°ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ã€‚è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ä¸ªåŠæ³•ï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨å†…å­˜åˆ†æ®µï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨å†…å­˜åˆ†é¡µ</p>

<h3 id="segmentation">Segmentation</h3>

<p>å†…å­˜åˆ†æ®µçš„æ€è·¯å¾ˆç®€å•ï¼Œå°±æ˜¯æ‰¾å‡ºä¸€æ®µè¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œç„¶åå’Œè™šæ‹Ÿå†…å­˜è¿›è¡Œæ˜ å°„å¾—åˆ°è™šæ‹Ÿå†…å­˜åœ°å€ï¼Œå†å°†è¿™ä¸ªåœ°å€åˆ†ç»™è¢«loadçš„binaryã€‚è¿™ç§æ€è·¯è™½ç„¶ç®€å•ï¼Œä½†æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜å°±æ˜¯å†…å­˜ç¢ç‰‡ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå½“Cç¨‹åºé€€å‡ºåï¼Œé‡Šæ”¾çš„128MBå†…å­˜æˆäº†ä¸è¿ç»­çš„ç©ºé—´ï¼Œå½“æœ‰loaderè¦åŠ è½½Dç¨‹åºæ—¶ï¼Œä¼šå‘ç°æ²¡æœ‰è¶³å¤Ÿçš„è¿ç»­å†…å­˜ç©ºé—´å¯ä»¥ä½¿ç”¨ã€‚</p>

<p><img class="md-img-center" src="/assets/images/2015/01/loader-1.png" /></p>

<p>è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨å†…å­˜çš„ç½®æ¢æŠ€æœ¯ï¼Œå³å°†ç¨‹åºBå…ˆå†™å…¥åˆ°ç¡¬ç›˜ï¼Œé‡Šæ”¾å†…å­˜ç©ºé—´æ¥è£…åœ¨Dï¼Œå½“Dè£…è½½å®Œæˆåï¼Œå†å°†Bè¯»å…¥åˆ°å†…å­˜ä¸­ã€‚ä½†æ˜¯ç”±äºå†…å­˜ç½®æ¢çš„æˆæœ¬æé«˜ï¼Œç¡¬ç›˜è®¿é—®çš„é€Ÿåº¦è¦æ¯”å†…å­˜æ…¢å¤ªå¤šï¼Œå› æ­¤è¿™ç§æ–¹æ¡ˆæœ‰å¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ã€‚</p>

<h3 id="paging">Paging</h3>

<p>ä¸ºäº†è§£å†³å†…å­˜ç¢ç‰‡å’Œäº¤æ¢é—®é¢˜ï¼Œç°ä»£æ“ä½œç³»ç»Ÿé‡‡ç”¨äº†å†…å­˜åˆ†é¡µçš„æŠ€æœ¯ã€‚å®ƒå°†ç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜å‡åˆ‡åˆ†æˆ4KBå¤§å°çš„ä¸€é¡µã€‚ç”±äºæ•°æ®é‡å°ï¼Œè¿™ç§åˆ‡åˆ†å¸¦æ¥çš„å¥½å¤„åœ¨äºå†…å­˜ç½®æ¢çš„æˆæœ¬å˜ä½äº†ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>getconf PAGE_SIZE <span class="c">#4096</span>
</code></pre></div></div>

<p>è¿›ä¸€æ­¥è®²ï¼Œå½“ç¨‹åºåŠ è½½æ—¶ï¼Œloaderä¸éœ€è¦å°†ç¨‹åºä¸€æ¬¡æ€§åŠ è½½åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œè€Œæ˜¯å¯ä»¥æŒ‰éœ€åŠ è½½ï¼Œå½“éœ€è¦ç”¨åˆ°è™šæ‹Ÿå†…å­˜é‡Œçš„æŒ‡ä»¤å’Œæ•°æ®æ—¶ï¼Œæ“ä½œç³»ç»Ÿè§¦å‘CPUçš„ç¼ºé¡µé”™è¯¯ï¼Œç„¶åè§¦å‘åŠ è½½è™šæ‹Ÿå†…å­˜ä¸­çš„é¡µåˆ°ç‰©ç†å†…å­˜ã€‚</p>

<p>è¿™å¹¶ä¸æ˜¯è¯´ä¸€æ®µè¿ç»­å®Œæ•´ç¨‹åºå¯ä»¥è¢«é›¶æ•£çš„æ˜ å°„ç‰©ç†å†…å­˜ä¸­ï¼Œç¨‹åºçš„å¯»å€ç©ºé—´åœ¨å†…å­˜ä¸­ä¾æ—§æ˜¯ä¸€æ®µè¿ç»­çš„åŒºåŸŸï¼Œåªä¸è¿‡å½“å‡ºç°å†…å­˜ç¢ç‰‡æˆ–è€…ç‰©ç†å†…å­˜ä¸è¶³æ—¶ï¼Œç³»ç»Ÿè¿›è¡Œå†…å­˜ç½®æ¢çš„æˆæœ¬å˜å°äº†(å› ä¸ºç½®æ¢ç°åœ¨æ˜¯ä»¥4KBä¸ºå•ä½ï¼Œé€Ÿåº¦å˜å¿«äº†)ã€‚å¦‚ä¸‹å›¾ä¸­ï¼Œå½“ç¨‹åºAè¯•å›¾åŠ è½½ç¬¬ä¸‰ç‰‡è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜ä¸­æ—¶ï¼Œä¼šè§¦å‘ç³»ç»Ÿçš„å†…å­˜ç½®æ¢</p>

<p><img class="md-img-center" src="/assets/images/2015/01/loader-2.png" /></p>

<p>æ€»çš„æ¥è¯´loaderå¯ä»¥å°†ç¨‹åºå’Œç‰©ç†å†…å­˜éš”ç¦»å¼€ï¼Œç„¶ç¨‹åºä¸éœ€è¦è€ƒè™‘å®é™…çš„ç‰©ç†å†…å­˜åœ°å€ï¼Œå¤§å°å’Œåˆ†é…æ–¹æ¡ˆï¼Œå¤§å¤§é™ä½äº†ç¨‹åºç¼–å†™å¤æ‚åº¦ã€‚</p>

<h3 id="executable">Executable</h3>

<p>å½“loaderå°†ç¨‹åºå®Œå…¨åŠ è½½åˆ°å†…å­˜ä¸­åï¼Œç¨‹åºå°±å¯ä»¥è¿è¡Œäº†ã€‚å¦‚æœä»C/C++ç¨‹åºçš„è§’åº¦çœ‹ï¼Œé‚£ä¹ˆç¨‹åºçš„å…¥å£åº”è¯¥å°±æ˜¯mainå‡½æ•°ï¼Œè€Œå¦‚æœä»loadersçš„è§’åº¦çœ‹ï¼Œåˆ™åœ¨mainå‡½æ•°æ‰§è¡Œä¹‹å‰ç¨‹åºå°±å·²ç»startäº†ã€‚æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡åæ±‡ç¼–ä¸Šé¢çš„<code class="highlighter-rouge">demoApp</code>æ¥è§‚å¯Ÿ</p>

<blockquote>
  <p>æ³¨æ„ï¼Œè¿™é‡Œçš„<code class="highlighter-rouge">demoApp</code>ä¾æ—§æ˜¯ELFæ ¼å¼</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Disassembly of section .text:

00000000004003e0 &lt;_start&gt;:
  4003e0:	31 ed                	xor    %ebp,%ebp
  4003e2:	49 89 d1             	mov    %rdx,%r9
  4003e5:	5e                   	pop    %rsi
  4003e6:	48 89 e2             	mov    %rsp,%rdx
  4003e9:	48 83 e4 f0          	and    <span class="nv">$0xfffffffffffffff0</span>,%rsp
  4003ed:	50                   	push   %rax
  4003ee:	54                   	push   %rsp
  4003ef:	49 c7 c0 10 06 40 00 	mov    <span class="nv">$0x400610</span>,%r8
  4003f6:	48 c7 c1 a0 05 40 00 	mov    <span class="nv">$0x4005a0</span>,%rcx
  4003fd:	48 c7 c7 40 05 40 00 	mov    <span class="nv">$0x400540</span>,%rdi
  400404:	e8 b7 ff ff ff       	callq  4003c0 &lt;__libc_start_main@plt&gt;
  400409:	f4                   	hlt
  40040a:	66 0f 1f 44 00 00    	nopw   0x0<span class="o">(</span>%rax,%rax,1<span class="o">)</span>
</code></pre></div></div>
<p>æˆ‘ä»¬çœ‹åˆ°ä»£ç æ®µ(text section)çš„ç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯<code class="highlighter-rouge">_start</code>ï¼Œè¿™ä¸ªå‡½æ•°æœ€ååˆè°ƒç”¨äº†<code class="highlighter-rouge">__libc_start_main</code>å‡½æ•°ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„åŸå‹</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">__libc_start_main</span><span class="p">(</span>
    <span class="kt">int</span> <span class="o">*</span><span class="p">(</span><span class="n">main</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="o">*</span><span class="p">),</span>  <span class="cm">/* address of main function */</span>
    <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> 
    <span class="kt">char</span> <span class="o">*</span> <span class="o">*</span> <span class="n">ubp_av</span><span class="p">,</span> 
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">),</span> <span class="cm">/* address of init function */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fini</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">),</span> 
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">rtld_fini</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">),</span> 
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span> <span class="n">stack_end</span><span class="p">));</span>
</code></pre></div></div>
<p>è¿™ä¸ªå‡½æ•°çš„å®šä¹‰åœ¨libcä¸­ï¼Œç”±äºç¯‡å¹…æœ‰é™ï¼Œæºç å°±ä¸å±•å¼€åˆ†æäº†ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å¤§è‡´çŒœåˆ°å®ƒçš„ä½œç”¨ï¼Œå³åˆå§‹åŒ–ç¨‹åºè¿›ç¨‹ä¸­çš„ç¯å¢ƒå˜é‡ï¼Œä¸ºmainå‡½æ•°çš„æ‰§è¡Œåšå‡†å¤‡ï¼Œæ¯”å¦‚æŸä¸ªç±»çš„æ„é€ å‡½æ•°ä½¿ç”¨äº†<code class="highlighter-rouge">__attribute__((constructor))</code>è¿™ç§keywordï¼Œé‚£ä¹ˆåœ¨mainå‡½æ•°æ‰§è¡Œå‰ï¼Œè‡ªå®šä¹‰çš„åˆå§‹åŒ–é€»è¾‘å°†è¢«æ‰§è¡Œã€‚</p>

<h3 id="å°ç»“">å°ç»“</h3>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å¯¹linkerså’Œloadersæœ‰äº†ä¸€äº›ç›´è§‚çš„æ„Ÿè§‰ï¼Œå½“ç„¶è¿™äº›æ„Ÿè§‰è¿˜å¾ˆè¡¨é¢ï¼Œå¾ˆå¤šç»†èŠ‚é—®é¢˜è¿˜ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œæ¯”å¦‚Symbol Resolutionçš„å…·ä½“è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼ŒRelocationæ—¶åç§»åœ°å€æ˜¯å¦‚ä½•è®¡ç®—çš„ï¼ŒåŠ¨æ€åº“æ˜¯å¦‚ä½•åŠ è½½çš„ï¼Œç­‰ç­‰ã€‚æˆ‘ä»¬å°†åœ¨åé¢é€æ­¥è®¨è®ºè¿™äº›é—®é¢˜</p>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="https://www.amazon.com/Linkers-Kaufmann-Software-Engineering-Programming/dp/1558604960">Linkers and Loaders</a></li>
  <li><a href="https://www.amazon.com/Advanced-C-Compiling-Milan-Stevanovic/dp/1430266678">Advanced C and C++ compiling</a>
    <h3 id="nmå‘½ä»¤"><code class="highlighter-rouge">nm</code>å‘½ä»¤</h3>
  </li>
</ul>

<blockquote>
  <p>æ³¨æ„ï¼Œ<code class="highlighter-rouge">nm</code>å‘½ä»¤ä¸ä¼šåˆ—å‡ºDLLçš„entry pointï¼Œé™¤éæœ‰å’Œå®ƒå…³è”çš„ç¬¦å·è¡¨ã€‚</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- A :absolute symbol, global
- a :absolute symbol, local
- B :uninitialized data (bss), global
- b :uninitialized data (bss), local
- D :initialized data, global
- d :initialized data, local
- F :file name
- l :line number entry (see -a option)
- N :no defined type, global; this is an unspecified type, compared to the undefined type U
- n :no defined type, local; this is an unspecified type, compared to the undefined type U
- S :section symbol, global
- s :section symbol, local
- T :text symbol, global
- t :text symbol, local (static)
- U :undefined symbol
- ? :unknown symbol
</code></pre></div></div>

:ET