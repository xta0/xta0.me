I"¤n<p><em></em></p>

<p>æœ€è¿‘çœ‹äº†ä¸€ç¯‡å¾ˆæœ‰è¶£æ–‡ç« ï¼Œ<a href="http://blog.parse.com/2013/02/05/objective-c-blocks-quiz/">å…³äºblockçš„quiz</a>ï¼Œ5é“é¢˜ç­”é”™äº†ä¸¤é“ã€‚ä¹‹å‰ç†è§£blockå¯ä»¥åœ¨heapå’Œstackä¸Šallocï¼Œçœ‹äº†è¿™ç¯‡æ–‡ç« æ‰å‘ç°åŸæ¥è¿˜æœ‰globalçš„blockã€‚æƒ³æƒ³ä¹Ÿæ˜¯ï¼Œè¿™ç§blockä¸å¼•ç”¨ä»»ä½•variableï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™å°±å¯ä»¥ç¡®å®šä¸‹æ¥äº†ã€‚</p>

<p>æœ€å¼€å§‹ç”¨blockçš„æ—¶å€™ï¼Œæ„Ÿåˆ°å¾ˆç–‘æƒ‘ï¼ŒåŸå› æ˜¯è¿™ç§ç”¨æ³•ä»ç¼–ç¨‹æ€æƒ³ä¸Šæ¥è®²å±äº<a href="http://en.wikipedia.org/wiki/Functional_programming">functional programming</a>ã€‚ä¸ç¬¦åˆé¢å‘å¯¹è±¡çš„è®¾è®¡åŸåˆ™ï¼Œä½†æ˜¯ä¸‡ç‰©æ— ç»å¯¹ï¼Œå°±åƒåœ¨é¢å‘å¯¹è±¡çš„ä¸–ç•Œä¸­åŒæ ·æœ‰å•ç‹¬å­˜åœ¨çš„å‡½æ•°ä¸€æ ·ï¼Œç°ä»£ç¼–ç¨‹è¯­è¨€å·²ç»ä¸æ‹˜æ³¥äºæŸç§ç‰¹å®šçš„å½¢å¼ã€‚è€Œç†Ÿæ‚‰Objective-Cçš„äººåº”è¯¥çŸ¥é“ï¼Œè¿™é—¨è¯­è¨€æ˜¯ä»<a href="http://zh.wikipedia.org/wiki/LISP">Lisp</a>æ¼”è¿›è¿‡æ¥ï¼Œè€ŒLispæ˜¯æœ€æ—©çš„å‡½æ•°å‹ç¼–ç¨‹è¯­è¨€ï¼Œè¿™ç¯‡æ–‡ç« å†™çš„å¾ˆä¸é”™ï¼š<a href="http://dave.fayr.am/posts/2011-08-19-lets-go-shopping.html">ã€ŠFunctional Programming Is Hard,
Thatâ€™s Why Itâ€™s Goodã€‹</a>ã€‚å…³äºLispï¼Œä¸€ç›´æ²¡æœ‰ç²¾åŠ›æ¥ä»”ç»†ç ”ç©¶ä¸€ä¸‹ï¼Œç•¥æ„Ÿé—æ†¾ã€‚åé¢çš„smallTalkä¿ç•™äº†Lispçš„è¿™ä¸€ç‰¹æ€§ï¼Œè¿›è€Œå¸¦åˆ°äº†Objective-Cä¸­ï¼Œæ‰€ä»¥åœ¨OCä¸­å‡ºç°blockä¹Ÿå¹¶ä¸å¥‡æ€ªã€‚</p>

<p>matt Gallowayå…³äºblockåšäº†<a href="http://www.galloway.me.uk/2012/10/a-look-inside-blocks-episode-1/">å¾ˆè¯¦ç»†çš„åˆ†æ</a>ï¼Œå¹¶ç»™å‡ºäº†LLVMä¸­å…³äºBlockçš„<a href="https://llvm.org/svn/llvm-project/compiler-rt/trunk/BlocksRuntime/Block_private.h">å®šä¹‰</a>ã€‚ä½†æ˜¯çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œä¸ºäº†ç†è§£çš„æ›´é€å½»ï¼Œæˆ‘ä»¬è¿˜æ˜¯äº²è‡ªæ¥debugä¸€ä¸‹,æˆ‘ä»¬å°±ä»¥ExampleAä¸ºä¾‹ï¼š</p>

<h3>Example A</h3>

<p>ä¸ºäº†åˆ†ææ–¹ä¾¿ï¼Œæˆ‘ä»¬æŠŠExample Aç¨å¾®æ”¹å†™ä¸€ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">void</span> <span class="nf">exampleA</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">a</span> <span class="o">=</span> <span class="sc">'A'</span><span class="p">;</span>

  <span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)()</span> <span class="o">=</span> 
  <span class="o">^</span><span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%c</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="n">block</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
	
	<span class="n">exampleA</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡clangæ¥<a href="http://clang-developers.42468.n3.nabble.com/rewrite-objc-C-and-blocks-td1614285.html">rewriteè¿™æ®µä»£ç </a>ï¼šclang -rewrite-objc test.c</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#line 4 "test.c"
</span><span class="k">struct</span> <span class="n">__exampleA_block_impl_0</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">__block_impl</span> <span class="n">impl</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">__exampleA_block_desc_0</span><span class="o">*</span> <span class="n">Desc</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">a</span><span class="p">;</span>
  <span class="n">__exampleA_block_impl_0</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">__exampleA_block_desc_0</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">_a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="n">a</span><span class="p">(</span><span class="n">_a</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">impl</span><span class="p">.</span><span class="n">isa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_NSConcreteStackBlock</span><span class="p">;</span>
    <span class="n">impl</span><span class="p">.</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
    <span class="n">impl</span><span class="p">.</span><span class="n">FuncPtr</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>
    <span class="n">Desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#line 8 "test.c"
</span><span class="k">static</span> <span class="kt">void</span> <span class="nf">__exampleA_block_func_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">__exampleA_block_impl_0</span> <span class="o">*</span><span class="n">__cself</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">a</span> <span class="o">=</span> <span class="n">__cself</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">;</span> <span class="c1">// bound by copy</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"%c</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">__exampleA_block_desc_0</span> <span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">reserved</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">Block_size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__exampleA_block_desc_0_DATA</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">__exampleA_block_impl_0</span><span class="p">)};</span>

<span class="cp">#line 4 "test.c"
</span><span class="kt">void</span> <span class="nf">exampleA</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">a</span> <span class="o">=</span> <span class="sc">'A'</span><span class="p">;</span>

  <span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">block</span><span class="p">)()</span> <span class="o">=</span>
  <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="o">&amp;</span><span class="n">__exampleA_block_impl_0</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__exampleA_block_func_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__exampleA_block_desc_0_DATA</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>

  <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">__block_impl</span> <span class="o">*</span><span class="p">))((</span><span class="n">__block_impl</span> <span class="o">*</span><span class="p">)</span><span class="n">block</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">FuncPtr</span><span class="p">)((</span><span class="n">__block_impl</span> <span class="o">*</span><span class="p">)</span><span class="n">block</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#line 15 "test.c"
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

 <span class="n">exampleA</span><span class="p">();</span>
 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="err">}</span>
</code></pre></div></div>

<p>éœ€è¦æŒ‡å‡ºçš„ä¸€ç‚¹æ˜¯ï¼Œè¿™ä¸ªrewrite-objcçš„å‘½ä»¤å¾ˆè¯¡å¼‚ï¼Œæˆ‘ä»¬çš„é¢„æœŸæ˜¯å°†ä¸€ä¸ª.cæ–‡ä»¶ä»…åœ¨è¯­æ³•å±‚é¢å°†blockå±•å¼€ï¼Œç”Ÿæˆå¦ä¸€ä¸ª.cæ–‡ä»¶ã€‚ä½†æ˜¯å®é™…ä¸Šè¿™ä¸ªå‘½ä»¤ç”Ÿæˆçš„æ˜¯ä¸€ä¸ª.cppçš„C++æ–‡ä»¶ï¼Œè¿™æ„å‘³ç€å®ƒåœ¨blockçš„ç»“æ„ä½“ä¸­æ’å…¥äº†æ„é€ å‡½æ•°ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">__exampleA_block_impl_0</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">__exampleA_block_desc_0</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">_a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="n">a</span><span class="p">(</span><span class="n">_a</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">impl</span><span class="p">.</span><span class="n">isa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_NSConcreteStackBlock</span><span class="p">;</span>
    <span class="n">impl</span><span class="p">.</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
    <span class="n">impl</span><span class="p">.</span><span class="n">FuncPtr</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>
    <span class="n">Desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>ä¸çŸ¥é“clangä¸ºä»€ä¹ˆè¦æŠŠå®ƒrewriteæˆC++çš„ã€‚ä½†è¿™å¹¶ä¸å½±å“æˆ‘ä»¬é˜…è¯»ä»£ç :</p>

<ul>
  <li>
    <p>mainå‡½æ•°æ‰§è¡ŒexampleAå‡½æ•°</p>
  </li>
  <li>
    <p>åœ¨exampleAå‡½æ•°ä¸­ï¼Œé¦–å…ˆé€šè¿‡æ„é€ å‡½æ•°åˆ›å»ºä¸€ä¸ªblockï¼šç”±äºè¿™ä¸ªblockæ˜¯åœ¨exampleAçš„stackä¸­ï¼Œæ‰€ä»¥blockçš„isaç±»å‹ä¸º_NSConcreteStackBlockï¼Œé‚£ä¹ˆå½“exampleAæ‰§è¡Œå®Œæ¯•åï¼Œblockå°±ä¼šè¢«é”€æ¯æ‰ï¼›blockæœ‰è‡ªå·±çš„å†…å­˜ç©ºé—´æ¥ä¿å­˜ä¼ è¿›æ¥çš„å‚æ•°aï¼›blockçš„å›è°ƒå‡½æ•°æŒ‡å‘äº†__exampleA_block_func_0</p>
  </li>
  <li>
    <p>æ‰§è¡Œblockçš„å›è°ƒå‡½æ•°ï¼šåœ¨__exampleA_block_func_0ä¸­ï¼Œè¾“å‡ºçš„aå®é™…ä¸Šæ˜¯blockç»“æ„ä½“ä¸­çš„aï¼Œä¸æ˜¯blockå¤–éƒ¨çš„aï¼Œå› æ­¤ï¼Œå¦‚æœåœ¨__exampleA_block_func_0å†…éƒ¨æ”¹å˜açš„å€¼ï¼Œæ”¹å˜ä¸æ˜¯å¤–éƒ¨çš„aå€¼ã€‚</p>
  </li>
</ul>

<h3>__block</h3>

<p>å¦‚æœæˆ‘ä»¬æƒ³æ”¹å˜açš„å€¼ï¼Œé€šå¸¸è¦æŠŠaå£°æ˜æˆ__blockï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">exampleA</span><span class="p">()</span> <span class="p">{</span>
  
  <span class="n">__block</span> <span class="kt">char</span> <span class="n">a</span> <span class="o">=</span> <span class="sc">'A'</span><span class="p">;</span>

  <span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)()</span> <span class="o">=</span> 
  <span class="o">^</span><span class="p">{</span>
	<span class="n">a</span> <span class="o">=</span> <span class="sc">'B'</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%c</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="n">block</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ ·æˆ‘ä»¬å°±èƒ½æ”¹å˜açš„å€¼äº†</p>

<p>whyï¼Ÿ</p>

<p>æˆ‘ä»¬å†æ¬¡ä½¿ç”¨ï¼šclang -rewrite-objc test.cï¼Œçœ‹çœ‹æœ‰ä»€ä¹ˆä¸åŒçš„åœ°æ–¹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">__Block_byref_a_0</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">__isa</span><span class="p">;</span>
<span class="n">__Block_byref_a_0</span> <span class="o">*</span><span class="n">__forwarding</span><span class="p">;</span>
 <span class="kt">int</span> <span class="n">__flags</span><span class="p">;</span>
 <span class="kt">int</span> <span class="n">__size</span><span class="p">;</span>
 <span class="kt">char</span> <span class="n">a</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">__exampleA_block_impl_0</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">__block_impl</span> <span class="n">impl</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">__exampleA_block_desc_0</span><span class="o">*</span> <span class="n">Desc</span><span class="p">;</span>
  <span class="n">__Block_byref_a_0</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span> <span class="c1">// by ref</span>
  <span class="n">__exampleA_block_impl_0</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">__exampleA_block_desc_0</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">__Block_byref_a_0</span> <span class="o">*</span><span class="n">_a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="n">a</span><span class="p">(</span><span class="n">_a</span><span class="o">-&gt;</span><span class="n">__forwarding</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">impl</span><span class="p">.</span><span class="n">isa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_NSConcreteStackBlock</span><span class="p">;</span>
    <span class="n">impl</span><span class="p">.</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
    <span class="n">impl</span><span class="p">.</span><span class="n">FuncPtr</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>
    <span class="n">Desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#line 9 "test.c"
</span><span class="k">static</span> <span class="kt">void</span> <span class="nf">__exampleA_block_func_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">__exampleA_block_impl_0</span> <span class="o">*</span><span class="n">__cself</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">__Block_byref_a_0</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">__cself</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">;</span> <span class="c1">// bound by ref</span>

 <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">__forwarding</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="sc">'B'</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%c</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">__forwarding</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">));</span>
  <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__exampleA_block_copy_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">__exampleA_block_impl_0</span><span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">__exampleA_block_impl_0</span><span class="o">*</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span><span class="n">_Block_object_assign</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">,</span> <span class="mi">8</span><span class="cm">/*BLOCK_FIELD_IS_BYREF*/</span><span class="p">);}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__exampleA_block_dispose_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">__exampleA_block_impl_0</span><span class="o">*</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span><span class="n">_Block_object_dispose</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">,</span> <span class="mi">8</span><span class="cm">/*BLOCK_FIELD_IS_BYREF*/</span><span class="p">);}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">__exampleA_block_desc_0</span> <span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">reserved</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">Block_size</span><span class="p">;</span>
  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">copy</span><span class="p">)(</span><span class="k">struct</span> <span class="n">__exampleA_block_impl_0</span><span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">__exampleA_block_impl_0</span><span class="o">*</span><span class="p">);</span>
  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">dispose</span><span class="p">)(</span><span class="k">struct</span> <span class="n">__exampleA_block_impl_0</span><span class="o">*</span><span class="p">);</span>
<span class="p">}</span> <span class="n">__exampleA_block_desc_0_DATA</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">__exampleA_block_impl_0</span><span class="p">),</span> <span class="n">__exampleA_block_copy_0</span><span class="p">,</span> <span class="n">__exampleA_block_dispose_0</span><span class="p">};</span>

<span class="cp">#line 4 "test.c"
</span><span class="kt">void</span> <span class="nf">exampleA</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">__attribute__</span><span class="p">((</span><span class="n">__blocks__</span><span class="p">(</span><span class="n">byref</span><span class="p">)))</span> <span class="n">__Block_byref_a_0</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,(</span><span class="n">__Block_byref_a_0</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__Block_byref_a_0</span><span class="p">),</span> <span class="sc">'A'</span><span class="p">};</span>

  <span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">block</span><span class="p">)()</span> <span class="o">=</span>
  <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="o">&amp;</span><span class="n">__exampleA_block_impl_0</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__exampleA_block_func_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__exampleA_block_desc_0_DATA</span><span class="p">,</span> <span class="p">(</span><span class="n">__Block_byref_a_0</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="mi">570425344</span><span class="p">);</span>

  <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">__block_impl</span> <span class="o">*</span><span class="p">))((</span><span class="n">__block_impl</span> <span class="o">*</span><span class="p">)</span><span class="n">block</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">FuncPtr</span><span class="p">)((</span><span class="n">__block_impl</span> <span class="o">*</span><span class="p">)</span><span class="n">block</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>exampleAå‘ç”Ÿäº†å˜åŒ–ï¼Œäº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„ç»“æ„ä½“ï¼š__Block_byref_a_0</p>
  </li>
  <li>
    <p>åŸæ¥æ˜¯ä¼ açš„å€¼ï¼Œç°åœ¨å˜æˆäº†ä¼ açš„å¼•ç”¨ã€‚</p>
  </li>
</ul>

<h3>Closure</h3>

<p>å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦äº†è§£blockæ˜¯å¦‚ä½•å®ç°çš„ï¼Œä½†æ˜¯ç†è§£blockåé¢çš„æ€æƒ³å´å¾ˆå…³é”®ã€‚å‰é¢å·²ç»æåˆ°è¿‡Functional Programmingçš„æ¦‚å¿µï¼ŒFunctional Programmingä¸­ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µæ˜¯Closureï¼Œç¿»è¯‘è¿‡æ¥å«â€œé—­åŒ…â€ã€‚å®ƒæœ‰å‡ ä¸ªæœ€åŸºæœ¬çš„featureï¼š</p>

<p>ï¼ˆ1ï¼‰First-Class Valueï¼šå‡½æ•°ä¹Ÿæ˜¯ä¸€ç§å˜é‡ï¼Œä¹Ÿå¯ä»¥åƒå˜é‡ä¸€æ ·è¢«èµ‹å€¼ï¼Œè¢«å½“åšå‚æ•°ä¼ é€’å’Œè¿”å›ã€‚
ï¼ˆ2ï¼‰High Order Functionï¼šé«˜é˜¶å‡½æ•°ï¼Œå³ä¸€ä¸ªå‡½æ•°çš„å‚æ•°ä¹Ÿå¯ä»¥æ˜¯å¦ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”è¿™ä¸ªå‡½æ•°å¯ä»¥æ˜¯åŒ¿åå‡½æ•°ã€‚
ï¼ˆ3ï¼‰Lexical Scoping:é™æ€ä½œç”¨åŸŸï¼Œä¹Ÿå«è¯æ³•ä½œç”¨åŸŸï¼Œè§£é‡Šèµ·æ¥å¾ˆéº»çƒ¦ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ç»´åŸºç™¾ç§‘ã€‚</p>

<p>è¿™ä¸‰æ¡æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œæ²¡é”™ï¼ŒObjective-Cä¸­çš„blockè¿™å‡ æ¡éƒ½æ”¯æŒ:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="n">func</span><span class="p">)(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="kt">int</span> <span class="n">y</span><span class="p">){</span> <span class="n">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s">"%d,%d"</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);};</span>
    <span class="n">func</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
</code></pre></div></div>

<p>è¿™è¯´æ˜blockå¯ä»¥å’Œæ™®é€šå˜é‡ä¸€æ ·ï¼Œè¿›è¡Œå®šä¹‰å’Œèµ‹å€¼</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">__block</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    
<span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">newCounter</span><span class="p">(</span> <span class="o">^</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">;</span>        
    <span class="err">}</span><span class="p">);</span>
</code></pre></div></div>

<p>è¿™è¯´æ˜ï¼Œblockå¯ä»¥ä½œä¸ºåŒ¿åå‡½æ•°ç›´æ¥ä½œä¸ºå‚æ•°ä¼ é€’ï¼ŒåŒæ—¶å®ƒè¿˜å¯ä»¥è®¿é—®iï¼Œè¯´æ˜blockä¹Ÿæ”¯æŒlexical scopingã€‚</p>

<p>å…¶å®æ‰€è°“blockä»…ä»…æ˜¯è¯­æ³•å±‚é¢çš„ä¸œè¥¿ï¼Œä»»ä½•æ”¯æŒclosureçš„è¯­è¨€éƒ½æœ‰å®ƒç‹¬ç‰¹çš„ä¸€å¥—è¯­æ³•å’Œå½¢å¼ï¼Œå°¤å…¶å¯¹äºè„šæœ¬è¯­è¨€ï¼Œæ²¡æœ‰å¼ºç±»å‹çš„é™åˆ¶ï¼Œä½¿ç”¨èµ·æ¥æ›´çµæ´»ï¼Œæ›´å¥½ç©ï¼Œä¾‹å¦‚,Luaçš„table.sortæ–¹æ³•ä¸­ç¬¬äºŒä¸ªå‚æ•°ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">network</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">name</span><span class="o">=</span><span class="s">"jason"</span><span class="p">,</span><span class="n">ip</span> <span class="o">=</span> <span class="s">"192.168.1.11"</span><span class="p">},</span>
	<span class="p">{</span><span class="n">name</span><span class="o">=</span><span class="s">"kate"</span><span class="p">,</span><span class="n">ip</span> <span class="o">=</span> <span class="s">"192.168.1.12"</span><span class="p">},</span>
	<span class="p">{</span><span class="n">name</span><span class="o">=</span><span class="s">"candy"</span><span class="p">,</span><span class="n">ip</span> <span class="o">=</span> <span class="s">"192.168.1.13"</span><span class="p">},</span>
	<span class="p">{</span><span class="n">name</span><span class="o">=</span><span class="s">"carl"</span><span class="p">,</span><span class="n">ip</span> <span class="o">=</span> <span class="s">"192.168.1.14"</span><span class="p">},</span>
<span class="p">}</span>
<span class="n">table</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="n">network</span><span class="p">,</span><span class="n">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">return</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">name</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">b</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="n">end</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">network</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">name</span><span class="p">,</span><span class="n">network</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ip</span><span class="p">)</span> <span class="o">--&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">kate</span><span class="p">,</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">12</span>
</code></pre></div></div>

<p>å› æ­¤ï¼Œæ€»ç»“æ¥è¯´ï¼Œå¯¹äºblockï¼Œä»…ä»…æ˜¯Objective-Cå®ç°Closureçš„ä¸€ç§é€”å¾„ï¼Œä¸ºçš„æ˜¯åœ¨æŸäº›åœºåˆç”¨èµ·æ¥æ›´æ–¹ä¾¿ï¼Œä½¿ä»£ç æ›´ç®€æ´ï¼Œæ›´ç´§å‡‘è€Œå·²ã€‚</p>
:ET